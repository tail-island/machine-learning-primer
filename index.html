<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>文系プログラマーの文系プログラマーによる文系プログラマーのための機械学習ガイド</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.1.0/github-markdown.min.css" />
  <meta name="description" content="文系の、文系による、文系のための機械学習ガイド。">
  <meta name="keywords"    content="機械学習, Python">

  <style>
  	.markdown-body {
  		box-sizing: border-box;
  		min-width: 200px;
  		max-width: 980px;
  		margin: 0 auto;
  		padding: 45px;
  	}

  	@media (max-width: 767px) {
  		.markdown-body {
  			padding: 15px;
  		}
  	}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<article class="markdown-body">
<p>文系の文系による文系のためのプログラマー向けの機械学習（machine
learning）ガイドです。今どきの機械学習ライブラリはとてもよくできているので、私のような数学ダメダメな文系プログラマーでも機械学習できちゃうんですな。機械学習してみたい文系プログラマーの皆様、すげー簡単ですから、一緒に機械学習しましょう。</p>
<p>本稿のプログラムはすべて<a
href="https://github.com/tail-island/machine-learning-primer"><a
href="https://github.com/tail-island/machine-learning-primer">https://github.com/tail-island/machine-learning-primer</a></a>に置きました。お時間があるときにでも、実行してみてください。</p>
<h1 id="機械学習とは">機械学習とは？</h1>
<p>コンピューターは頭が悪くて嫌になる！　コンピューターは頭が悪くて「アレをイイ感じにやっておいて」を理解できないから、我々プログラマーが細かくやり方を指示するプログラムを書いているんですもんね。そんなへっぽこなコンピューターが学習という高度なことをやるなんて、とても信じられない！</p>
<p>はい。おっしゃる通り。実は機械学習（machine
learning）ってのは無から有を生み出すすごいものではなくて、プログラム中のパラメーター（変数の値）を調整してくれるだけの、学習っちゃあ学習なんだけど冷静に考えるとなんだかなぁってものなんですよ。</p>
<p>具体例で考えましょう。西暦を令和に変換するプログラムを手で書いてみてください。たぶん、こんなコードになるんじゃないでしょうか？</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hand_made_version(year):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> year <span class="op">-</span> <span class="dv">2018</span></span></code></pre></div>
<p>で、このコードの<code>2018</code>の部分を書くのが面倒くさいなぁ、コンピューターが自動で設定してくれれば楽だなぁと思ったとしてください。そんな時は、機械学習が有効です。コードはこんな感じ。</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> ((<span class="dv">2019</span>,), (<span class="dv">2020</span>,), (<span class="dv">2021</span>,), (<span class="dv">2022</span>,), (<span class="dv">2023</span>,), (<span class="dv">2024</span>,), (<span class="dv">2025</span>,), (<span class="dv">2026</span>,), (<span class="dv">2027</span>,))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> LinearRegression()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>model.fit(xs, ys)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> machine_learning_version(year):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> ((year,),)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    ys <span class="op">=</span> model.predict(xs)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ys[<span class="dv">0</span>]</span></code></pre></div>
<p>コードが増えてるやんけ、という批判は忘れて、どうしてこのコードで西暦を令和に変換できるのかを考えてみましょう。</p>
<p><code>LinearRegression</code>クラスは、線形回帰（linear
regression）と呼ばれる機械学習の手法を実装したクラスで、線形回帰は、<code>a1 * x[0] + a2 * x[1] + a3 * x[2] ... + b</code>というプログラムで表現可能な場合向けの手法です。西暦から令和の場合は<code>1 * year - 2018</code>で表現できますから、この線形回帰がバッチリあてはまります。</p>
<p>で、その<code>a1 = 1</code>や<code>b = -2018</code>はどうやって導くのかというと、データから導きます。そのデータが上のコードの<code>xs</code>と<code>ys</code>。2019の時に1になるにはパラメーターをどんな値にすればよいのかなぁ、2020の時に2になるにはどうすればよいのかなぁと試して、できるだけ相違が少ない値を設定していきます。それを実現するための数学のテクニックがいろいろあるらしいのですけど、我々プログラマーがやらなければならないのは<code>fit()</code>メソッドを呼び出すだけ。</p>
<p>以上で機械学習してパラメーターを適切な値に調整してくれるので、あとは、<code>predict()</code>メソッドを呼び出して予測させればオッケー。線形回帰は入力が配列であることを期待しているのと、あと、一回で複数データ分の予測ができるように作られているので、型を揃えるために<code>xs = ((year,),)</code>したり<code>ys[0]</code>をリターンしています。</p>
<p>このように、機械学習ってのは、与えられたデータに合うようにパラメーターを調整しているだけなんです。これは、深層学習（deep
learning）のような最先端の手法でも同じ。ほら、機械学習って簡単そうでしょ？</p>
<h1
id="機械学習には様々な手法がある">機械学習には、様々な手法がある</h1>
<p>もう少し複雑な問題で、もっと機械学習してみましょう。東京都の月平均気温からアイスクリーム月別支出額を予測する場合でやってみます。</p>
<p>まずはデータです。<a
href="https://www.data.jma.go.jp/obd/stats/etrn/">気象庁のWebサイト</a>から東京都の月平均気温を、<a
href="https://www.icecream.or.jp/biz/data/expenditures.html">日本アイスクリーム協会のWebサイト</a>からアイスクリーム月別支出金額をもらってきました。</p>
<p>で、再利用性を高めるためにモジュール化したコードはこんな感じ。</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 東京都の月平均気温。https://www.data.jma.go.jp/obd/stats/etrn/</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> np.array((</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">6.1</span>,), (<span class="fl">7.2</span>,), (<span class="fl">10.1</span>,), (<span class="fl">15.4</span>,), (<span class="fl">20.2</span>,), (<span class="fl">22.4</span>,), (<span class="fl">25.4</span>,), (<span class="fl">27.1</span>,), (<span class="fl">24.4</span>,), (<span class="fl">18.7</span>,), (<span class="fl">11.4</span>,), (<span class="fl">8.9</span>,),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">5.8</span>,), (<span class="fl">6.9</span>,), (<span class="fl">8.5</span>,), (<span class="fl">14.7</span>,), (<span class="dv">20</span>,), (<span class="dv">22</span>,), (<span class="fl">27.3</span>,), (<span class="fl">26.4</span>,), (<span class="fl">22.8</span>,), (<span class="fl">16.8</span>,), (<span class="fl">11.9</span>,), (<span class="fl">6.6</span>,),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">4.7</span>,), (<span class="fl">5.4</span>,), (<span class="fl">11.5</span>,), (<span class="dv">17</span>,), (<span class="fl">19.8</span>,), (<span class="fl">22.4</span>,), (<span class="fl">28.3</span>,), (<span class="fl">28.1</span>,), (<span class="fl">22.9</span>,), (<span class="fl">19.1</span>,), (<span class="dv">14</span>,), (<span class="fl">8.3</span>,),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">5.6</span>,), (<span class="fl">7.2</span>,), (<span class="fl">10.6</span>,), (<span class="fl">13.6</span>,), (<span class="dv">20</span>,), (<span class="fl">21.8</span>,), (<span class="fl">24.1</span>,), (<span class="fl">28.4</span>,), (<span class="fl">25.1</span>,), (<span class="fl">19.4</span>,), (<span class="fl">13.1</span>,), (<span class="fl">8.5</span>,),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    (<span class="fl">7.1</span>,), (<span class="fl">8.3</span>,), (<span class="fl">10.7</span>,), (<span class="fl">12.8</span>,), (<span class="fl">19.5</span>,), (<span class="fl">23.2</span>,), (<span class="fl">24.3</span>,), (<span class="fl">29.1</span>,), (<span class="fl">24.2</span>,), (<span class="fl">17.5</span>,), (<span class="dv">14</span>,), (<span class="fl">7.7</span>,)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># アイスクリーム月別支出額。https://www.icecream.or.jp/biz/data/expenditures.html</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> np.array((</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="dv">464</span>, <span class="dv">397</span>, <span class="dv">493</span>, <span class="dv">617</span>, <span class="dv">890</span>, <span class="dv">883</span>, <span class="dv">1_292</span>, <span class="dv">1_387</span>, <span class="dv">843</span>, <span class="dv">621</span>, <span class="dv">459</span>, <span class="dv">562</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="dv">489</span>, <span class="dv">382</span>, <span class="dv">472</span>, <span class="dv">624</span>, <span class="dv">915</span>, <span class="dv">914</span>, <span class="dv">1_394</span>, <span class="dv">1_370</span>, <span class="dv">826</span>, <span class="dv">599</span>, <span class="dv">489</span>, <span class="dv">573</span>,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="dv">507</span>, <span class="dv">416</span>, <span class="dv">607</span>, <span class="dv">746</span>, <span class="dv">894</span>, <span class="dv">1_021</span>, <span class="dv">1_506</span>, <span class="dv">1_443</span>, <span class="dv">861</span>, <span class="dv">640</span>, <span class="dv">492</span>, <span class="dv">537</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="dv">494</span>, <span class="dv">423</span>, <span class="dv">542</span>, <span class="dv">667</span>, <span class="dv">1_000</span>, <span class="dv">991</span>, <span class="dv">1_236</span>, <span class="dv">1_513</span>, <span class="dv">996</span>, <span class="dv">724</span>, <span class="dv">531</span>, <span class="dv">584</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="dv">510</span>, <span class="dv">482</span>, <span class="dv">610</span>, <span class="dv">689</span>, <span class="dv">1_040</span>, <span class="dv">1_123</span>, <span class="dv">1_155</span>, <span class="dv">1_658</span>, <span class="dv">1_025</span>, <span class="dv">649</span>, <span class="dv">573</span>, <span class="dv">599</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_dataset():</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> xs, ys</span></code></pre></div>
<p>学習した結果を可視化して確認するための、matplotlibを使用してグラフを描画するモジュールがこちら。</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plot</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check(dataset, model):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 実データを取得します。</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    xs, ys <span class="op">=</span> dataset</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 実データを青色の散布図で描画します。</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    plot.plot(xs, ys, <span class="st">&#39;bo&#39;</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測データを取得します。</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    pred_xs <span class="op">=</span> np.linspace(np.<span class="bu">min</span>(xs), np.<span class="bu">max</span>(xs), <span class="dv">1000</span>).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    pred_ys <span class="op">=</span> model.predict(pred_xs)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測データを赤色の線グラフで描画します。</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    plot.plot(pred_xs, pred_ys, <span class="st">&#39;r-&#39;</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 描画結果を表示します。</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    plot.show()</span></code></pre></div>
<p>最後。最も重要な線形回帰で機械学習する部分のコードは、こんな感じ。</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> checker <span class="im">import</span> check</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_dataset</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> get_dataset()</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを作成して、機械学習します</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> LinearRegression()</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>model.fit(<span class="op">*</span>dataset)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 図を作成して精度をチェックします</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>check(dataset, model)</span></code></pre></div>
<p>……西暦から令和への変換とほとんど同じですな。実は、機械学習する部分は、ライブラリを使用するなら、我々プログラマーには最も簡単な部分なんです。</p>
<p>では、試してみましょう。プログラムを実行してみると、以下のグラフが表示されるはずです。</p>
<p><img src="image/ice-cream-linear-regression.png"
alt="アイスクリーム月別支出金額の線形回帰での予測結果" /></p>
<p>線形回帰なのでアイスクリーム月別支出金額を<code>a * 東京の月平均気温 + b</code>で計算していますから、予測結果は直線になるわけ。で、西暦から令和への変換とは違って実データにバラツキがあるので、できるだけデータの中央を通るようなパラメーターに調整されたというわけ。</p>
<p>ここでちょっと考えてみてください。もし、貴方の実家がアイスクリームに特化した駄菓子屋で、年老いた両親から仕入れの無駄を排除したいと相談されたら（アイスクリームには賞味期限がないので無駄があっても大丈夫な気もしますけど）、貴方のプログラマー力をどう使いますか？　いろいろ考えて複雑なアルゴリズムを組み立てる……のは、面倒くさいですよね？　「アルゴリズムを考えるのが面倒だから、とりあえず機械学習をやってみよう」という考え方が、なんだか良さそうな気がしてきませんか？　プログラミングはとても簡単なので、すぐに試せますしね。</p>
<p>あと、上の線形回帰のプログラムの結果を見て、真夏の気温が高い書き入れ時に仕入れ量が少なくて損が出ちゃうじゃんと思った方も、ご安心ください。機械学習には様々な手法があるので、別の手法を試してみればよいんですよ。</p>
<p>今回は、決定木という手法を使用してみます。決定木というのは、<code>if/else</code>を使う手法で、コードにするとこんな感じ。</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> x <span class="op">&lt;=</span> a1:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">&lt;=</span> a2:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> b1</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> b2</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">&lt;=</span> a3:</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> b3</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> b4</span></code></pre></div>
<p>この<code>a1</code>～<code>a3</code>と<code>b1</code>～<code>b4</code>を、データをもとにしてイイ感じに調整するわけですね。で、その決定木を使用して機械学習するコードは、こんな感じ。</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> checker <span class="im">import</span> check</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_dataset</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeRegressor, export_text</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> get_dataset()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを作成して、機械学習します</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> DecisionTreeRegressor(max_depth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>model.fit(<span class="op">*</span>dataset)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 図を作成して精度をチェックします</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>check(dataset, model)</span></code></pre></div>
<p>……間違い探しみたいな感じになっちゃってごめんなさい。このコードは線形回帰の時とほとんど同じで、違いは、<code>LinearRegression()</code>を<code>DecisionTree(max_depath=3)</code>に変更しただけです。</p>
<p>各手法のインターフェースは統一されているので、手法変更時のコード修正は本当に少しで済みます。ある手法でダメだったら、5秒くらいかけて少しコードを書き換えて、別の手法を試せばよい。ほら、機械学習って、簡単でしょ？</p>
<p>さて、このプログラムの実行結果はこんな感じになります。</p>
<p><img src="image/ice-cream-decision-tree.png"
alt="アイスクリーム月別支出金額の決定木での予測結果" /></p>
<p>線形回帰より精度が向上していて素晴らしい！　予測の線がカクカクになっていますけど、これ、<code>if/else</code>で定数をリターンしているのだから、我々プログラマーには自明の結果ですよね。</p>
<h1
id="機械学習で出来ることはいろいろある">機械学習で出来ることは、いろいろある</h1>
<p>でも、世の中って数値で表せることだけじゃなくね？　赤と青の薬のどちらを飲むべきかとかは？　そうお考えになった方、ご安心ください。機械学習は数値以外を予測することもできるんです。ここまででやってきたように数値を予測する機械学習を回帰（regression）と呼ぶのですけど、それ以外にも、クラス分類（classification）とクラスタリング（clustering）ができます。これらを、具体的にやってみましょう。</p>
<h2 id="データ収集">データ収集</h2>
<p>お題は、私の趣味であるバイク（健康的な人が乗るbicycleじゃなくて、頭が悪い人が乗るmotorcycleの方）にします。</p>
<p>まずはデータ集めから。新しいバイクを買うお金なんかないのに見るのをやめられない<a
href="https://www.bikebros.co.jp/catalog/">BikeBrosのWebサイト</a>からデータを取得します。でも、手でデータをコピー＆ペーストするのは大変ですから、プログラムを組んでデータを集めましょう。</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> concat, first</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> starmap</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.parse <span class="im">import</span> urljoin</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_soup(url):</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    html <span class="op">=</span> requests.get(url)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    html.encoding <span class="op">=</span> <span class="st">&#39;UTF8&#39;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> BeautifulSoup(html.text, <span class="st">&#39;html.parser&#39;</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_row_urls(category_url):</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">10</span>)  <span class="co"># サイトに迷惑をかけないよう、スリープして10秒待ちます。</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> li <span class="kw">in</span> get_soup(category_url).select(<span class="st">&#39;div.bikeList li&#39;</span>):</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> li.select(<span class="st">&#39;div.currentModel&#39;</span>):  <span class="co"># 現行車のみとします</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> urljoin(category_url, li.select_one(<span class="st">&#39;a&#39;</span>).attrs[<span class="st">&#39;href&#39;</span>])</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_name(soup):</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> soup.select_one(<span class="st">&#39;p.bikeNmae&#39;</span>).get_text().strip()</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_price(soup):</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    span <span class="op">=</span> soup.select_one(<span class="st">&#39;div.makerPriceRange span.priceRange&#39;</span>)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> span:</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    price_string <span class="op">=</span> span.get_text().strip()</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&#39;万&#39;</span> <span class="kw">not</span> <span class="kw">in</span> price_string <span class="kw">or</span> <span class="st">&#39;円&#39;</span> <span class="kw">not</span> <span class="kw">in</span> price_string:</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    price_1_string <span class="op">=</span> price_string.split(<span class="st">&#39;万&#39;</span>)[<span class="dv">0</span>]</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    price_2_string <span class="op">=</span> price_string.split(<span class="st">&#39;万&#39;</span>)[<span class="dv">1</span>].split(<span class="st">&#39;円&#39;</span>)[<span class="dv">0</span>]</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="bu">int</span>(price_1_string) <span class="op">*</span> <span class="dv">10_000</span> <span class="cf">if</span> price_1_string <span class="cf">else</span> <span class="dv">0</span>) <span class="op">+</span> (<span class="bu">int</span>(price_2_string) <span class="cf">if</span> price_2_string <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_spec_value(soup, th_text, convert_fn):</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    tr <span class="op">=</span> first(<span class="bu">filter</span>(<span class="kw">lambda</span> tr: tr.select_one(<span class="st">&#39;th&#39;</span>).get_text().strip() <span class="op">==</span> th_text, soup.select(<span class="st">&#39;div#bike_model_info tr&#39;</span>)))</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> tr:</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> convert_fn(tr.select_one(<span class="st">&#39;td&#39;</span>).get_text().strip())</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_rows(category_url):</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row_url <span class="kw">in</span> get_row_urls(category_url):</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>        sleep(<span class="dv">10</span>)  <span class="co"># サイトに迷惑をかけないよう、スリープして10秒待ちます。</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>        soup <span class="op">=</span> get_soup(row_url)</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> ((row_url, get_name(soup), get_price(soup)) <span class="op">+</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>               <span class="bu">tuple</span>(starmap(<span class="kw">lambda</span> caption, convert_fn: get_spec_value(soup, caption, convert_fn),</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>                             ((<span class="st">&#39;全長 (mm)&#39;</span>, <span class="bu">float</span>),</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;全幅 (mm)&#39;</span>, <span class="bu">float</span>),</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;全高 (mm)&#39;</span>, <span class="bu">float</span>),</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;ホイールベース (mm)&#39;</span>, <span class="bu">float</span>),</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;シート高 (mm)&#39;</span>, <span class="bu">float</span>),</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;車両重量 (kg)&#39;</span>, <span class="bu">float</span>),</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;気筒数&#39;</span>, <span class="bu">int</span>),</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;シリンダ配列&#39;</span>, <span class="bu">str</span>),</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;排気量 (cc)&#39;</span>, <span class="bu">float</span>),</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;カム・バルブ駆動方式&#39;</span>, <span class="bu">str</span>),</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;気筒あたりバルブ数&#39;</span>, <span class="bu">int</span>),</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;最高出力（kW）&#39;</span>, <span class="bu">float</span>),</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;最高出力回転数（rpm）&#39;</span>, <span class="bu">float</span>),</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;最大トルク（N・m）&#39;</span>, <span class="bu">float</span>),</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>                              (<span class="st">&#39;最大トルク回転数（rpm）&#39;</span>, <span class="bu">float</span>)))))</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># スクレイピングしてデータを取得します。</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>    rows <span class="op">=</span> concat(<span class="bu">map</span>(<span class="kw">lambda</span> row: (<span class="dv">0</span>,) <span class="op">+</span> row, get_rows(<span class="st">&#39;https://www.bikebros.co.jp/catalog/A01/&#39;</span>)),  <span class="co"># スポーツ＆ツアラー</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>                  <span class="bu">map</span>(<span class="kw">lambda</span> row: (<span class="dv">1</span>,) <span class="op">+</span> row, get_rows(<span class="st">&#39;https://www.bikebros.co.jp/catalog/B01/&#39;</span>)),  <span class="co"># ネイキッド＆ストリート</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>                  <span class="bu">map</span>(<span class="kw">lambda</span> row: (<span class="dv">2</span>,) <span class="op">+</span> row, get_rows(<span class="st">&#39;https://www.bikebros.co.jp/catalog/C01/&#39;</span>)),  <span class="co"># オフロード＆モタード</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>                  <span class="bu">map</span>(<span class="kw">lambda</span> row: (<span class="dv">3</span>,) <span class="op">+</span> row, get_rows(<span class="st">&#39;https://www.bikebros.co.jp/catalog/D01/&#39;</span>)),  <span class="co"># アメリカン＆クルーザー</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>                  <span class="bu">map</span>(<span class="kw">lambda</span> row: (<span class="dv">4</span>,) <span class="op">+</span> row, get_rows(<span class="st">&#39;https://www.bikebros.co.jp/catalog/E01/&#39;</span>)),  <span class="co"># ビッグスクーター</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>                  <span class="bu">map</span>(<span class="kw">lambda</span> row: (<span class="dv">5</span>,) <span class="op">+</span> row, get_rows(<span class="st">&#39;https://www.bikebros.co.jp/catalog/F01/&#39;</span>)),  <span class="co"># 原付・スクーター</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>                  <span class="bu">map</span>(<span class="kw">lambda</span> row: (<span class="dv">6</span>,) <span class="op">+</span> row, get_rows(<span class="st">&#39;https://www.bikebros.co.jp/catalog/G01/&#39;</span>)))  <span class="co"># ビジネスバイク・ミニバイク</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CSVとして出力します。</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;bike-bros-catalog.csv&#39;</span>, <span class="st">&#39;w&#39;</span>, newline<span class="op">=</span><span class="st">&quot;&quot;</span>, encoding<span class="op">=</span><span class="st">&quot;UTF-8&quot;</span>) <span class="im">as</span> f:</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>        writer <span class="op">=</span> csv.writer(f, quoting<span class="op">=</span>csv.QUOTE_NONNUMERIC)</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>        writer.writerow((<span class="st">&#39;ジャンル&#39;</span>,</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;URL&#39;</span>,</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;車名&#39;</span>,</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;価格&#39;</span>,</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;全長 (mm)&#39;</span>,</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;全幅 (mm)&#39;</span>,</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;全高 (mm)&#39;</span>,</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;ホイールベース (mm)&#39;</span>,</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;シート高 (mm)&#39;</span>,</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;車両重量 (kg)&#39;</span>,</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;気筒数&#39;</span>,</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;シリンダ配列&#39;</span>,</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;排気量 (cc)&#39;</span>,</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;カム・バルブ駆動方式&#39;</span>,</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;気筒あたりバルブ数&#39;</span>,</span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;最高出力（kW）&#39;</span>,</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;最高出力回転数（rpm）&#39;</span>,</span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;最大トルク（N・m）&#39;</span>,</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;最大トルク回転数（rpm）&#39;</span>))</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> row <span class="kw">in</span> rows:</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>            writer.writerow(row)</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>    main()</span></code></pre></div>
<p>このようにプログラムを使用してWebサイトからデータを取得することを、Webスクレイピングと呼びます。我々プログラマーの本領を発揮して、サクッと作っちゃいましょう。本稿の主題ではないので説明は割愛しますけど、Webスクレイピング時には<a
href="https://www.crummy.com/software/BeautifulSoup/">BeautifulSoup</a>がとても便利でお勧めです。あと、Python単体だとイマイチな関数型プログラミング機能を提供してくれる<a
href="https://github.com/Suor/funcy">funcy</a>も素敵なのでぜひ使ってみてください。</p>
<p>で、注意点なのですけど、Webスクレイピングってサイトに負荷がかかる上にグレーな行為なので、できるだけ迷惑がかからないように、たとえば上のコードのように長めの<code>sleep()</code>を入れるようにしてください。このプログラムでスクレイピングした結果はCSVファイルとして保存してありますから、私が快適に<a
href="https://www.bikebros.co.jp/">Bike
BrosのWebサイト</a>を閲覧できるよう、このプログラムを無駄に実行しないこともお願いします。あと、新しいバイクを買うときには必ず<a
href="https://www.bikebros.co.jp/">Bike
BrosのWebサイト</a>でチェックするのはもちろん、毎日<a
href="https://www.bikebros.co.jp/">Bike
BrosのWebサイト</a>を巡回して時々広告をクリックしてたまには広告先で買い物をするように！</p>
<h2 id="データ読み込み">データ読み込み</h2>
<p>いろいろ加工が必要となるので、データの読み込みもプログラムを組んでやるのがお勧めです。UTF-8でエンコードされたCSVファイルをダブル・クリックしたら文字化けしちゃうようなExcelで編集するってのは、プログラムを組む能力ある貴方にはふさわしくありません。</p>
<p>で、表形式のデータを読み込むときは、<a
href="https://pandas.pydata.org/">pandas</a>を使うととても簡単です。この後に実施する回帰の場合のデータ読み込み処理なら、こんな感じ。</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_dataset(seed<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CSVを読み込みます。</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    data_frame <span class="op">=</span> pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;bike-bros-catalog.csv&#39;</span>))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 不要なデータを削除します。</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    data_frame <span class="op">=</span> data_frame.dropna()                         <span class="co"># NaN（Not a Number）値がある行を削除します。</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    data_frame <span class="op">=</span> data_frame.drop_duplicates(subset<span class="op">=</span>[<span class="st">&#39;URL&#39;</span>])  <span class="co"># 重複した行を削除します。</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列を選択します。</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> pd.get_dummies(data_frame[[<span class="st">&#39;全長 (mm)&#39;</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;全幅 (mm)&#39;</span>,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;全高 (mm)&#39;</span>,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;ホイールベース (mm)&#39;</span>,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;シート高 (mm)&#39;</span>,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;車両重量 (kg)&#39;</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;気筒数&#39;</span>,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;シリンダ配列&#39;</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;排気量 (cc)&#39;</span>,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;カム・バルブ駆動方式&#39;</span>,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;気筒あたりバルブ数&#39;</span>,</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最高出力（kW）&#39;</span>,</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最高出力回転数（rpm）&#39;</span>,</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最大トルク（N・m）&#39;</span>,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最大トルク回転数（rpm）&#39;</span>]],</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>                        columns<span class="op">=</span>[<span class="st">&#39;シリンダ配列&#39;</span>, <span class="st">&#39;カム・バルブ駆動方式&#39;</span>]).values</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    ys <span class="op">=</span> data_frame[<span class="st">&#39;価格&#39;</span>].values</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    ns <span class="op">=</span> data_frame[<span class="st">&#39;車名&#39;</span>].values</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 訓練データのインデックスと検証データのインデックスを取得します。</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    indices <span class="op">=</span> rng.permutation(np.arange(<span class="bu">len</span>(xs)))</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    train_indices <span class="op">=</span> indices[<span class="dv">50</span>:]</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    valid_indices <span class="op">=</span> indices[:<span class="dv">50</span>]</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># データセットをリターンします。</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (xs[train_indices], ys[train_indices]), (xs[valid_indices], ys[valid_indices]), (ns[train_indices], ns[valid_indices])</span></code></pre></div>
<p>Webスクレイピング時にデータがない場合は<code>None</code>を出力するようにしましたので、今回のデータでは値がNaN（Not
a
Number）になっている場所があります。だから<code>dropna()</code>でNaNを含む行を削除しました。あと、同じバイクが異なるカテゴリーで登録されていることもあるので、<code>drop_duplicates()</code>で重複を排除しています。</p>
<p>列を選択する際に<code>get_dummies()</code>している点にも注目してください。シリンダ配列とカム・バルブ駆動方式には「V型」とか「単気筒」とか「DOHC」とか「OHV」とかの文字列が入っています。文字列のままだと機械学習をやれないので、なんとかして数値に変換しなければなりません。でも、「V型」は<code>1</code>で「単気筒」は<code>2</code>とかの数値にすると、「V型」を2倍すると「単気筒」になるという意味不明な関係ができて困っちゃう。だから今回は、「V型かどうか」と「単気筒かどうか」という複数の列を作成して、その中の該当する列を1に、そうでない列を0にするという、ワン・ホット・エンコーディング（one
hot
encoding）という手法を使いました。それを簡単に実現してくれるのが、pandasの<code>get_dummies()</code>なんですな。pandas便利！</p>
<h2
id="訓練データ検証データテストデータ">訓練データ、検証データ、テスト・データ</h2>
<p>先ほどのデータ読み込みのコードをよく見てみると、後半で訓練データセットと検証データセットに分割しています（インデックスの配列でデータを取得できるのは、NumPyのファンシー・インデックスという機能です）。で、これはなんでかというと、機械学習には過学習（over
fit）の危険性があるためです。</p>
<p>前に、機械学習はデータに合うようにパラメーターを調整すると述べました。これ、教科書を使わないで、ひたすら問題集を解くだけで勉強しているとイメージしてください。コンピューターは問題を解くための理論を学んでいるわけじゃなくて、データがこんな感じだったらこんな解答というパターンを学んでいるだけなんですよ。こんなんでも、学習に使用したのとは別の問題集だって似たような問題が出てくるだろうからたぶん解けるんじゃねってのが、機械学習の考え方なんです。</p>
<p>ただし、特定の問題集で学びすぎてしまうと、問題集の3ページ目の右上の問題の答えは2.718281828459みたいな、無意味なパターンも学んでしまいます。そうなると、他の問題集を解かせた場合でも3ページ目の右上なら問題を読まないで2.7とか答えるようになっちゃう。汎用的な予測能力ではなくて、その問題集（データ）でしか通用しない解き方を学習してしまうわけです。このような状態を、過学習と呼びます。</p>
<p>過学習を避ける方法はいろいろあって本稿の後の方で述べるのですけど、まずは、過学習していないかを確認する手段が必要です。過学習していないことを確認するにはどうすればよいかというと、学習に使用したのとは別の問題集を解けるか試せばよいわけで、この別データを検証データと呼びます。ちなみに、機械学習で作成した予測モデルの精度は、この検証データで測定します。そりゃそうですよね、学習に使用した問題集「だけ」を高い精度で解けても、何の役にも立たないわけですから。</p>
<p>実は、検証データとは別にテスト・データってのもあります。機械学習の手法には、機械学習で調整されるパラメーター以外にも、どのようにパラメーター調整をするのかを指定するパラメーターもあって、これをハイパー・パラメーターと呼びます。アイスクリーム予測でやった<code>DecisionTreeRegressor(max_depth=3)</code>の<code>max_depth</code>は、そのハイパー・パラメーターの一つ。このハイパー・パラメーターをチューニングすることで予測の精度を向上できたりするのですけど、精度の測定を前述した検証データでやった場合、検証データにとってだけ最適なハイパー・パラメーターになってしまう危険性があります。そこで、ハイパー・パラメーターが検証データに特化して「いない」か確認するためのデータとして、テスト・データを使用するというわけ。ここでは手抜きでハイパー・パラメーター・チューニングをやりませんから、テスト・データは作成しませんけどね……。</p>
<h2 id="回帰">回帰</h2>
<p>準備が整ったので、おさらいとして、もう一度回帰をやりましょう。バイクの仕様から、値段を予測させてみます。世の中には割高な商品と割安の商品があるわけで、これを「なんとなく高いなー」みたいなふわっとしたのではなく、機械学習で予測した値段と比較して高いか安いかで判断できるようになるわけで、これでバイク選びがはかどること請け合いです。</p>
<p>コードは、こんな感じ。</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_dataset</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 乱数のシード。</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>RANDOM_SEED <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>train_dataset, valid_dataset, names_collection <span class="op">=</span> get_dataset(RANDOM_SEED)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを作成して、機械学習します。</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> RandomForestRegressor(random_state<span class="op">=</span>RANDOM_SEED)  <span class="co"># とりあえず、ハイパー・パラメーターはデフォルト値。</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>model.fit(<span class="op">*</span>train_dataset)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証データセットを使用して、モデルの精度を表示します。</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model.score(<span class="op">*</span>valid_dataset))</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証データセットを使用して……</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>xs, ys <span class="op">=</span> valid_dataset</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>_, names <span class="op">=</span> names_collection</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 実際に予測もさせてみます。</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, y, pred_y <span class="kw">in</span> <span class="bu">zip</span>(names, ys, model.predict(xs)):</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&#39;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">:</span><span class="ch">\t</span><span class="sc">{</span>y<span class="sc">:,</span><span class="fl">.2</span><span class="er">f</span><span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>pred_y<span class="sc">:,</span><span class="fl">.2</span><span class="er">f</span><span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>y <span class="op">/</span> pred_y<span class="sc">:.2f}</span><span class="ss">&#39;</span>)</span></code></pre></div>
<p>……また同じコードかよと思われた方、実は、今回はランダム・フォレスト（random
forest）という別の機械学習の手法を使用している点が異なっています。ランダム・フォレストというのは決定木を森のように何本も作成して予測する手法で、回帰の場合は各決定木の出力の平均が予測結果となります。</p>
<p>あと、<code>score()</code>メソッドを使用して、検証データセットでの予測精度も調べました。<code>score()</code>の戻り値は、正解と予測値の差の2乗（2乗すれば、プラスに間違えてもマイナスに間違えても正の数になりますし、あと、大きく間違えた場合により大きな値になって便利）を、正解と予測値の平均の差の2乗で割って、1から引いたものです。うまく予測できているほど1に近くなる（予測が外れまくるとマイナスの値になることもある）値で、今回はが0.538498919239462が出力されました。<code>RANDOM_SEED</code>の値（乱数のシード値）を変えて検証データセットに分割されるデータを変更すると値が上下しますけど、0.8を超えるようなとても高い場合が多いみたい。予測した結果を見ても、なんとなく妥当っぽい。</p>
<p>うん、そこそこ予測できているんじゃないかな？</p>
<h2 id="クラス分類">クラス分類</h2>
<p>クラス（class）とは、「種類」を意味します（学校のクラスや階級ではない）。このコンピューターは「ラップトップPC」、そのコンピューターは「デスクトップPC」という場合の、「ラップトップPC」や「デスクトップPC」がクラスで、その特徴は、連続量で表現できないことです。このコンピューターの種類は1.23とか言われてもなんだか分からないでしょ？　で、このクラスを予測するのが、クラス分類です。</p>
<p>お題は、バイクのジャンルとします。仕様から、どのジャンルのバイクなのかを予測させてみましょう。Webスクレイピングは終了していますので、作業はデータの読み込みから。こんなコードになりました。</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データのインデックスと検証データのインデックスを取得します。</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_train_indices_and_valid_indices(ys, valid_size, rng):</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    size_per_y <span class="op">=</span> <span class="bu">min</span>(<span class="bu">map</span>(<span class="kw">lambda</span> y: <span class="bu">len</span>(ys[ys <span class="op">==</span> y]), <span class="bu">range</span>(<span class="bu">max</span>(ys) <span class="op">+</span> <span class="dv">1</span>)))</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    genre_indices_collection <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> y: rng.choice(np.arange(<span class="bu">len</span>(ys))[ys <span class="op">==</span> y], size<span class="op">=</span>size_per_y, replace<span class="op">=</span><span class="va">False</span>), <span class="bu">range</span>(<span class="bu">max</span>(ys) <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    train_indices_collection, valid_indices_collection <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span><span class="bu">map</span>(<span class="kw">lambda</span> indices: (indices[valid_size:], indices[:valid_size]), genre_indices_collection))</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.concatenate(train_indices_collection), np.concatenate(valid_indices_collection)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_dataset(seed<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CSVを読み込みます。</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    data_frame <span class="op">=</span> pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;bike-bros-catalog.csv&#39;</span>))</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 不要なデータを削除します。</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    data_frame <span class="op">=</span> data_frame.dropna()                                      <span class="co"># NaN（Not a Number）値がある行を削除します。</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    data_frame <span class="op">=</span> data_frame.drop_duplicates(subset<span class="op">=</span>[<span class="st">&#39;URL&#39;</span>], keep<span class="op">=</span><span class="st">&#39;last&#39;</span>)  <span class="co"># 重複した行を削除します。先の行（メジャーなジャンルの行）は数が多いので、最後の行を残しました。</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列を選択します。</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> pd.get_dummies(data_frame[[<span class="st">&#39;価格&#39;</span>,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;全長 (mm)&#39;</span>,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;全幅 (mm)&#39;</span>,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;全高 (mm)&#39;</span>,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;ホイールベース (mm)&#39;</span>,</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;シート高 (mm)&#39;</span>,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;車両重量 (kg)&#39;</span>,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;気筒数&#39;</span>,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;シリンダ配列&#39;</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;排気量 (cc)&#39;</span>,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;カム・バルブ駆動方式&#39;</span>,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;気筒あたりバルブ数&#39;</span>,</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最高出力（kW）&#39;</span>,</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最高出力回転数（rpm）&#39;</span>,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最大トルク（N・m）&#39;</span>,</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最大トルク回転数（rpm）&#39;</span>]],</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>                        columns<span class="op">=</span>[<span class="st">&#39;シリンダ配列&#39;</span>, <span class="st">&#39;カム・バルブ駆動方式&#39;</span>]).values</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    ys <span class="op">=</span> data_frame[<span class="st">&#39;ジャンル&#39;</span>].values</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    ns <span class="op">=</span> data_frame[<span class="st">&#39;車名&#39;</span>].values</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 訓練データのインデックスと検証データのインデックスを取得します。</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    train_indices, valid_indices <span class="op">=</span> get_train_indices_and_valid_indices(ys, <span class="dv">4</span>, rng)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># データセットをリターンします。</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (xs[train_indices], ys[train_indices]), (xs[valid_indices], ys[valid_indices]), (ns[train_indices], ns[valid_indices])</span></code></pre></div>
<p>ジャンル毎のデータ数を揃えるのが大変でした……。NumPyとfuncyのおかげで、そこそこきれいにかけたので嬉しい（学習時にクラス毎の重みをパラメーターで指定するなら、数を揃えなくてもよいのですけど……）。</p>
<p>で、例によって例のごとく、機械学習する部分のコードはほとんど同じです。</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_dataset</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 乱数のシード。</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>RANDOM_SEED <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>train_dataset, valid_dataset, names_collection <span class="op">=</span> get_dataset(RANDOM_SEED)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを作成して、機械学習します。</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> RandomForestClassifier(random_state<span class="op">=</span>RANDOM_SEED)  <span class="co"># とりあえず、ハイパー・パラメーターはデフォルト値。</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>model.fit(<span class="op">*</span>train_dataset)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データセットを使用して、モデルの精度を表示します。あまり意味はないですけど……。</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model.score(<span class="op">*</span>train_dataset))</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証データセットを使用して、モデルの精度を表示します。</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model.score(<span class="op">*</span>valid_dataset))</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証データセットを使用して……</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>xs, ys <span class="op">=</span> valid_dataset</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>_, names <span class="op">=</span> names_collection</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 実際に予測もさせてみます。</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, y, pred_y, pred_y_proba <span class="kw">in</span> <span class="bu">zip</span>(names, ys, model.predict(xs), model.predict_proba(xs)):</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&#39;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">:</span><span class="ch">\t</span><span class="sc">{</span>y<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>pred_y<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>pred_y_proba<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
<p>回帰の時の<code>RandomForestRegressor</code>が、クラス分類では<code>RandomForestClassifier</code>に変わっていて、でも、学習する部分のコードはまったく同じ。ただし、<code>RandomForectClassifier</code>では予測のメソッドが<code>predict()</code>以外に<code>predict_proba()</code>があるところがちょっと違う。</p>
<p>この<code>predict_proba()</code>だと、クラス毎の確率が出力されます。今回使用したランダム・フォレストは決定木を何本も作成して予測する方法で、クラス分類の場合は多数決でクラスを決定します。ということはですよ、100対0の圧倒的な差で「クラスA」と予測する場合と、51対49の僅差で「クラスA」と予測する場合があり得るわけです。これを、確率という形で表現してくれます。</p>
<p>クラス分類して確率付きでクラスを予測させる方式は便利です。たとえば、過去の株価の推移から今後の株価を予測するシステムを作ると考えてみてください。株価をバシっと予測してくれる回帰が良さそうに感じますけど、でも、株価って、過去の株価の推移だけから決まったりはしないですよね？　同じ株価の推移の後でも、株価が上がったり下がったりします。で、過去50回は100円上がって、過去50回は100円下がったような場合に回帰の予測結果がどうなるかというと、できるだけ正解との誤差を減らそうとするので、たぶん、±0が出力されちゃうんですよ……。</p>
<p>で、これがクラス分類だと「50%の確率で上がる、50%の確率で下がる」みたいな予測結果になるので、投資予算が少ない場合は役に立つと思いませんか？　まぁ、膨大な額を何回も投資できるなら、統計と同じ結果になって回帰でも大丈夫な気がしますけど……。</p>
<p>閑話休題。このプログラムを実行した結果の精度を見てみましょう。精度は驚愕の0.9642857142857143になりました！　<code>RANDOM_SEED</code>の値を変えて検証データの内容を変えると上下するのですけど、おおむねとても高い精度になります。</p>
<p>うん、精度が高くて便利そう。バイクのジャンルってのは、それほど難しくない気もするけどね……。</p>
<h2 id="クラスタリング">クラスタリング</h2>
<p>クラスタリング（clustering）は、回帰やクラス分類とは違って、正解データを用意しなくても実施できる手法です。なにをしてくれるかというと、近いデータをグルーピングしてくれます。人をグループ化して、私をアニメ・クラスタとかキモヲタ・クラスタに入れてくれちゃう無慈悲なアレですね。</p>
<p>クラスタリングはいろいろ活用方法があるみたいで、たとえば顧客をグループに分けて、それぞれの顧客グループの特徴を考えて、顧客グループの特長を考えた施策を考えるといったビジネス面で役に立つらしいです。私はプログラマーでビジネスやったことがないので、よく分からないですけど……。</p>
<p>でも、そんな私でもクラスタリングのプログラムは組めます。まずは、データの読み込みから。</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_dataset():</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CSVを読み込みます。</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    data_frame <span class="op">=</span> pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;bike-bros-catalog.csv&#39;</span>))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 不要なデータを削除します。</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    data_frame <span class="op">=</span> data_frame.dropna()                         <span class="co"># NaN（Not a Number）値がある行を削除します。</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    data_frame <span class="op">=</span> data_frame.drop_duplicates(subset<span class="op">=</span>[<span class="st">&#39;URL&#39;</span>])  <span class="co"># 重複した行を削除します。</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 列を選択します。</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> pd.get_dummies(data_frame[[<span class="st">&#39;価格&#39;</span>,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;全長 (mm)&#39;</span>,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;全幅 (mm)&#39;</span>,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;全高 (mm)&#39;</span>,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;ホイールベース (mm)&#39;</span>,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;シート高 (mm)&#39;</span>,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;車両重量 (kg)&#39;</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;気筒数&#39;</span>,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;シリンダ配列&#39;</span>,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;排気量 (cc)&#39;</span>,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;カム・バルブ駆動方式&#39;</span>,</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;気筒あたりバルブ数&#39;</span>,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最高出力（kW）&#39;</span>,</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最高出力回転数（rpm）&#39;</span>,</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最大トルク（N・m）&#39;</span>,</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&#39;最大トルク回転数（rpm）&#39;</span>]],</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>                        columns<span class="op">=</span>[<span class="st">&#39;シリンダ配列&#39;</span>, <span class="st">&#39;カム・バルブ駆動方式&#39;</span>]).values</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    ns <span class="op">=</span> data_frame[<span class="st">&#39;車名&#39;</span>].values</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0～1の値に正規化します。</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    xs_max <span class="op">=</span> np.<span class="bu">max</span>(xs, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    xs_min <span class="op">=</span> np.<span class="bu">min</span>(xs, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    xs <span class="op">=</span> (xs <span class="op">-</span> xs_min) <span class="op">/</span> (xs_max <span class="op">-</span> xs_min)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># データセットをリターンします。</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> xs, ns</span></code></pre></div>
<p>正解データが不要なので、これまでとは違って<code>ys</code>を作成しません。その代わりに、データを正規化しています。正規化をした理由は、この後に使用するK-meansってのがデータ間の距離を使って似ているか判断する手法だからです。金額が100万円違うのと排気量が100cc違うのが並んでいると、金額の差の大きさに目を奪われてK-meansはほぼ金額だけでクラスタリングしちゃう。それじゃあ困るので、どの列の値も0～1の間になるようにしているわけ。</p>
<p>あと、データを分類することが目的で、未知の新しいデータにも通用する分類方式を作るわけじゃないので、訓練データと検証データに分けることもしません。</p>
<p>で、機械学習する部分のコードはこちら。</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_dataset</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 乱数のシード。</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>RANDOM_SEED <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># クラスタの数</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>CLUSTER_SIZE <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>xs, names <span class="op">=</span> get_dataset()</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを作成して、機械学習します。</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>CLUSTER_SIZE, random_state<span class="op">=</span>RANDOM_SEED)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> model.fit_predict(xs)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co"># クラスタを表示させてみます。</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(CLUSTER_SIZE):</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> <span class="bu">sorted</span>(names[ys <span class="op">==</span> i]):</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&#39;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span></code></pre></div>
<p><code>KMeans</code>を使用していることと、<code>fit()</code>ではなくて<code>fit_pred()</code>で、その引数に正解データが含まれていない点が違うところ。<code>fit_pred()</code>は、機械学習して、<code>xs</code>の各行がどのクラスタに所属するのかの配列を返します。</p>
<p>この<code>KMeans</code>にはK-meansというクラスタリングの手法が実装されていて、これは、データ間の距離を使用してグループを作成します。平面での距離は<code>sqrt(x ** 2 + y ** 2)</code>で計算できるわけですけど、これ、3次元でも<code>sqrt(x ** 2 + y ** 2 + z ** 2)</code>でほぼ同じ。そして、4次元以上でも同様に計算できるらしいんですよ。ということは、複数の数値が入った配列と同じ数の数値が入った配列を、多次元空間上の座標だと考えて距離を計算することができるわけ。K-meansでは、この距離が近いものをグルーピングしていきます。</p>
<p>で、<code>fit_pred()</code>の出力を使用してクラスタにどんなデータが含まれているのかを確認して、いろいろ考えて、考えた結果をビジネスに役立てたりしていきます。私はプログラマーでビジネス・パーソンじゃないので、具体的にどうやるかは分からないので詳しい話はごめんなさい省略で。</p>
<p>ともあれ、クラスタリングもとても簡単でした。手持ちのデータをクラスタリングでグループ分けしてみたら面白そう。</p>
<h1 id="機械学習の手法選択">機械学習の手法選択</h1>
<p>本稿では、これまで線形回帰、決定木、ランダム・フォレスト、K-meansといういくつかの手法を使用してきました。実は機械学習にはこれ以外にもたくさんの手法があって、それを使い分けなければならない……のは大変すぎるので、私が手法選択に使用しているルールを疑似コードで示しましょう。</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> 大量のデータを用意できる <span class="kw">and</span> (そこそこ高性能なGPUを使える <span class="kw">or</span> 潤沢なクラウド予算がある) <span class="kw">and</span> テーブル・データではない:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> 深層学習</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> 勾配ブースティング</span></code></pre></div>
<p>……ごめんなさい。実は私は普段は線形回帰とか全くやってません。なんでかというと、私は統計の人じゃなくて機械学習の人だから。</p>
<h2 id="統計と機械学習">統計と機械学習</h2>
<p>統計と機械学習って同じ道具を使うことも多くて似ているのですけど、目的が異なります。統計は「説明」を目的とし、機械学習は「予測」を目的とします。気温とアイスクリームの売り上げには関係があるのか、関係があるのであればどのような関係なのかを考えるのが統計で、どんな関係なのかはさておいて予測の精度を高めることにひたすら注力するのが機械学習なんです。</p>
<p>統計をしたいのであれば、データの関係を明らかにしたいですから、モデルはできるだけ単純な方が良い。シンプルなモデルの方が関係が分かりやすいですもんね。だから、データに合致する範囲で、できるだけシンプルなモデルを構築します。だから、まずは線形回帰で関係があるかを調べようとなります。</p>
<p>機械学習では予測精度をできるだけ高めたいので、複雑なモデルであっても、モデルの中身がブラックボックスでデータ間の関係が理解不能であってもお構いなし。だから、できるだけ高い予測精度を期待できるモデルを選びます。よって、線形回帰みたいな精度が低そうなモデルは選択肢にあがらないわけ。</p>
<p>で、私は機械学習の人なので、前に書いたように、現在の技術で最高の精度を誇る深層学習（deep
learning）と勾配ブースティング（gradient
boosting）しか使わないんですな。</p>
<h2 id="深層学習の弱点">深層学習の弱点</h2>
<p>いや精度第一ならば深層学習一択だろうという反論が聞こえてきそうですけど、深層学習って弱点も多いと思うんですよ。</p>
<p>その深層学習は脳の構造を模した手法とかよく言われますけど、今どきの深層学習モデルは脳のどこかを模しているわけではありません。独自に進化した結果、脳とはあまり関係なくなっています。</p>
<p>ぶっちゃけて言えば、私は深層学習とは行列演算を大量に積み重ねたもので、その行列の各要素をパラメーターとする、異常に大量のパラメーターを使える機械学習の手法と認識しています。で、パラメーターが大量にあったら調整が大変に思えるのですけど、それは逆誤差伝播法（backprobagation）という適用可能な範囲は狭いけど効率が良い調整方式で対応しちゃう。あと、大量のパラメーターを使って計算するのは時間がかかりそうに思えるけど、それは行列の特性をイイ感じに活用した並列処理で対応しちゃう。</p>
<p>ただね、いくら逆誤差伝播法が効率が良くても、深層学習の良さを出そうとしてパラメーターを大量に使用したなら、やっぱりパラメーターの調整は大変になります。この大変さは、「大量のデータが必要」という形になって我々を苦しめます。</p>
<p>あと、行列の特性をイイ感じに活用した並列処理で高速化といっても、たとえば8コアのCPUだとハイパー・スレッディングを使用しても16並列でしか処理できません。だから、膨大な数の並列処理が可能なGPU（Graphicd
Processing Unit）やTPU（Tensor Processing
Unit）が必要となります。そこそこ高性能なGPUを買うか、GPUやTPUを使用可能なクラウドを借りるかしなければならないわけで、とにかくお金がかかります。</p>
<p>あと、深層学習ってのは、テーブル・データに弱いです。実は本稿の深層学習のところで述べるTransformerベースならそこそこいけるかもしれないのですけど、少なくとも、他の機械学習の手法と比べて面倒が多い。画像処理や自然言語処理のような、深層学習以外では精度が出ないような場合以外、いわゆるテーブル・データ（表形式のデータ）の場合は深層学習以外の手法を試した方が良いんじゃないかな。</p>
<p>まとめると、大量のデータが必要で、GPUやTPUが必要（ローカルでもクラウドでもよい）で、テーブル・データではいろいろ面倒な癖に今のところ明確なアドバンテージがないんです。</p>
<h2 id="機械学習の手法選択-1">機械学習の手法選択</h2>
<p>というわけで、大量のデータを用意できないとか、GPUを持っていないしクラウド予算もないとか、テーブル・データであるとかの場合は、私は勾配ブースティングで機械学習することにしているというわけ。</p>
<h1 id="lightgbmで勾配ブースティング">LightGBMで勾配ブースティング</h1>
<p>というわけで、まずは勾配ブースティング（gradient
boosting）しましょう。使用するライブラリは、LightGBMです。</p>
<h2 id="勾配ブースティングとは">勾配ブースティングとは？</h2>
<p>勾配ブースティングは、複数の決定木を使用して予測する機械学習の手法です。……って前にやったランダム・フォレストと同じじゃんと思ったかもしれませんけど、学習のさせ方がランダム・フォレストとは一味違うんです。</p>
<h3 id="バギングとブースティング">バギングとブースティング</h3>
<p>複数の予測器を使う方式はアンサンブル（ensemble）と呼ぶのですけど、このアンサンブルの代表的な手法に、バギング（bagging）とブースティング（boosting）という2つの手法があります。</p>
<p>そもそもね、まったく同じ思考をする人が3人集まっても同じ答えが3つ返ってくるだけですから、3人いても文殊の知恵は手に入りません。アンサンブルて予測の精度を上げるには、バラツキが必要なんです。ではどのようにバラツキを出すのかというと、今やっているのは機械学習なので、データセットを変えることでバラツキがでます。</p>
<p>バギングでは、データセット全体からのサンプリング抽出で複数の異なるデータセットを作成します。サンプリングだからデータセットは異なるはずで、だから学習結果も異なるのでアンサンブルで予測精度が上がるはずという考え方なわけですな。</p>
<p>でも、サンプリング結果って、そんなに違わないですよね？　日本全体からサンプリングで1万人集めた場合、たぶん男女比は日本全体とほぼ同じ。年齢構成だってそう。だから、あるサンプリング結果で学習してもうまく予測できないような問題は、たぶんあまり違わない他のサンプリング結果で学習してもうまく予測できない。</p>
<p>じゃあサンプリング処理に介入しちゃおうぜというのがブースティング（boosting）。サンプリングしたデータセットで学習してとりあえず1つの予測器を作成し、その予測器で予測して、正解したデータは少なめに、不正解だったデータは多めに選択されるように重みづけしてもう一度サンプリングします。1番目の予測器が苦手とする問題が多く含まれるわけで、だからそのデータセットで作成した2番目の予測器は1番目の予測器が苦手とする予測をうまくこなせるはず。これを繰り返していけば、最終的には、トータルで見れば弱点がない複数の予測器になるというわけ。</p>
<p>こう考えると、ブースティングの精度の高さにうなづけるでしょ？　ただ、むしろ予測を間違える方が正しいような外れ値に引っ張られてしまったり、過学習してしまったりする危険性があります。でも精度が高いのでやめられないんですな。</p>
<h3 id="で勾配とは">で、勾配とは？</h3>
<p>……えっと、勾配（gradient）は勾配降下法の意味で、調整していくときの方法みたいです。なんかね、偏微分で勾配を求めてってやるらしいんですけど、私レベルでは欠片も理解できてない。</p>
<p>でも大丈夫！　これまでだっていろいろな機械学習の手法でパラメーター調整のためにいろいろ数学の手法が使われていただろうけど、それらをやるのは機械学習ライブラリの役目でプログラマーの私の役割じゃなかったですもんね。勾配降下法でやるんだーというふわっとした理解で大丈夫じゃないかな。</p>
<h3 id="勾配ブースティングとは-1">勾配ブースティングとは？</h3>
<p>というわけで、勾配ブースティングは決定木をアンサンブルして予測する手法で、アンサンブル方法はバギングではなくてブースティングなので精度が高くて、あと、勾配降下法を使うので学習の効率が良い（と思う）な手法で、とにかくお勧めです。</p>
<h2 id="lightgbmとは">LightGBMとは？</h2>
<p>LightGBMは、マイクロソフト社が開発したオープン・ソースの勾配ブースティングのライブラリです。</p>
<p>勾配ブースティングのライブラリはXGBoostとLightGBMが有名なのですけど、本稿ではLightGBMを使用します。今はあまり差がないみたいですけど、昔はLightGBMの方が圧倒的に速かったので大人気になって、そのまま今も利用者が多くて寄らば大樹の陰なのでLightGBMお勧めです。</p>
<h1 id="お題はkaggleから">お題は、Kaggleから</h1>
<p>使用する道具が決まったのでこれからLightGBMで機械学習していくわけですけど、毎回お題を用意するのは大変すぎて私が死んじゃう。あと、本稿の内容は機械学習の基本だけなので、読後に機械学習を実践してテクニックを学んでいく必要があるのだけど、高度なテクニックを紹介していくのも私では無理。なので、お題の提供と最強テクニックの提供は<a
href="https://www.kaggle.com/">Kaggle</a>に丸投げしちゃいましょう。</p>
<p>Kaggle（カグルと読みます）は、機械学習のコンペのサイトです。企業や政府が課題と賞金を出して、Kaggler（カグラーと読みます。Kaggleの参加者の意味です）が競争形式でその課題を解いていきます。</p>
<p>競争なんてやりたくない、私はひっそり機械学習を学んでアルゴリズム作成で楽をしたいだけなんだ……という方にもKaggleは役に立ちます（怖いので私もKaggleのコンペはやっていません）。Kaggleには練習用のコンペも用意されていますし、Codeに他の参加者が実際に動くコードで解説を投稿してくれますし、今競技中で戦っている最中なのに面白いことを思いついたKagglerがDiscussionにそのアイデアを書いてくれちゃいます。実践環境を提供してくれる上に、異常に能力が高い方々のアドバイスが盛りだくさんなのですから、機械学習の勉強が捗りまくります。</p>
<p>……Kaggleは全部英語だけどな。でも大丈夫、英語ダメダメな私だけど、Chrome翻訳と<a
href="https://www.deepl.com/ja/translator">DeepL</a>が私を助けてくれるはず！</p>
<h1 id="勾配ブースティングで2値分類">勾配ブースティングで2値分類</h1>
<p>というわけで、Kaggleからお題をもらってLightGBMで勾配ブースティングでクラス分類（2値分類ですが）をやりましょう。お題はKaggleが最初の挑戦としてお勧めしている<a
href="https://www.kaggle.com/c/titanic">Titanic</a>にします。Titanicは、Kaggleのページの左側の\[Competitions\]をクリックして、[Getting
Started]をクリックするとリスト表示される中に入っています。</p>
<p>というわけで、Titanicを開いてデータをダウンロードして、本稿のソース・コードのtitanic/input/titanicに保存してください。データはtrain.csvとtest.csvに分かれていて、train.csvを使って機械学習して、test.csvを使って予測した結果で精度を競うわけですな。</p>
<h2 id="まずは予測可能なのか調べる">まずは、予測可能なのか調べる</h2>
<p>さて、今回はKaggleなので他の参加者のスコアを見れば予測が可能でそこそこの精度が出ることは一目瞭然なのですけど、実際の案件ではそもそも予測が可能なのか分からないことが稀によくあります。</p>
<p>予測ができない理由としては、予測する内容とは無関係なデータしかない場合と、そもそも予測対象のランダム性が高すぎて予測が不可能な場合等があります。特に結果のランダム性が高い場合は辛くて、たとえば過去10回のサイコロの出目がこんな場合に次に出る目を予測するなんてのは、絶対に無理でしょ？</p>
<p>で、いろいろデータを解析していけば予測が可能か分かるのかもしれませんけど、私はプログラマーなのでとりあえずプログラムを組んで調べます。こんな感じ。</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plot</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> count</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリ型の特徴量を、どの数値に変換するかのdictを取得します。</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_categorical_features(data_frame):</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">map</span>(<span class="kw">lambda</span> feature: (feature, <span class="bu">dict</span>(<span class="bu">zip</span>(data_frame[feature].factorize()[<span class="dv">1</span>], count()))), (<span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Embarked&#39;</span>)))  <span class="co"># factorize()で数値に変換することもできるのですけど、その方式は、実際に予測するときに使えない。。。</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xs(data_frame, categorical_features):</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># カテゴリ型の特徴量を、数値に変換します。</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, mapping <span class="kw">in</span> categorical_features.items():</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        data_frame[feature] <span class="op">=</span> data_frame[feature].<span class="bu">map</span>(mapping).fillna(<span class="op">-</span><span class="dv">1</span>).astype(<span class="st">&#39;category&#39;</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測に使用するカラムだけを抽出します。NameとTicketは関係なさそうなので無視、Cabinは欠損地が多いので無視しました。</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[[<span class="st">&#39;Pclass&#39;</span>, <span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Age&#39;</span>, <span class="st">&#39;SibSp&#39;</span>, <span class="st">&#39;Parch&#39;</span>, <span class="st">&#39;Fare&#39;</span>, <span class="st">&#39;Embarked&#39;</span>]]</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 正解を取得します。</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ys(data_frame):</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[<span class="st">&#39;Survived&#39;</span>]</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="co"># データを読み込んで、前準備をします。</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, <span class="st">&#39;titanic&#39;</span>, <span class="st">&#39;train.csv&#39;</span>))</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> get_categorical_features(data_frame)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データセットを取得します。</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>train_xs <span class="op">=</span> xs[<span class="dv">200</span>:]</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>train_ys <span class="op">=</span> ys[<span class="dv">200</span>:]</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証データセットを取得します。test.csvを使ってKaggleに問い合わせる方式は、面倒な上に数をこなせないためです。</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>valid_xs <span class="op">=</span> xs[:<span class="dv">200</span>]</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>valid_ys <span class="op">=</span> ys[:<span class="dv">200</span>]</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="co"># LightGBMのパラメーターを作成します。</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> {</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;objective&#39;</span>: <span class="st">&#39;binary&#39;</span>,  <span class="co"># 2値分類。</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;force_col_wise&#39;</span>: <span class="va">True</span>  <span class="co"># 警告を消すために付けました。</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 交差検証で機械学習します。</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>cv_result <span class="op">=</span> lgb.cv(params, lgb.Dataset(train_xs, label<span class="op">=</span>train_ys), return_cvbooster<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> cv_result[<span class="st">&#39;cvbooster&#39;</span>]</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a><span class="co"># 特徴量の重要性を出力します。</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame({<span class="st">&#39;feature&#39;</span>: model.boosters[<span class="dv">0</span>].feature_name(), <span class="st">&#39;importance&#39;</span>: np.mean(model.feature_importance(), axis<span class="op">=</span><span class="dv">0</span>)}).sort_values(<span class="st">&#39;importance&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 精度を出力します。</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Accuracy = </span><span class="sc">{</span>accuracy_score(valid_ys, np.mean(model.predict(valid_xs), axis<span class="op">=</span><span class="dv">0</span>) <span class="op">&gt;=</span> <span class="fl">0.5</span>)<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a><span class="co"># 学習曲線を出力します。</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>plot.plot(cv_result[<span class="st">&#39;binary_logloss-mean&#39;</span>])</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>plot.show()</span></code></pre></div>
<p>前にやったバイクのジャンル予測ではNaNが無くなるように工夫したりカテゴリー値をone
hot
encodingしたりといろいろ工夫しましたけど、LightGBMはどちらの作業もやらねくて大丈夫とても楽ちんです（できればNaNは埋めた方が良いけど）。ほら、とりあえずLightGBMって気持ちになるでしょ？</p>
<p>残る前準備のカテゴリーの数値への変換は必要ですけど、pandasの<code>factorize()</code>と<code>map()</code>を使えば、上のコードの<code>get_categorical_features()</code>や<code>get_xs()</code>のように簡単に書けます。LightGBMがカテゴリーかどうか判断できるように、カテゴリーのカラムでは<code>ascategory('category')</code>しておくのを忘れないようにしてください。</p>
<p>データセットができたら、いつも通りに訓練データセットと検証データセット（後述する交差検証（cross
validation）をしているので、テスト・データに近いけど）に分けて、機械学習していきます。</p>
<p>LightGBMでは、どのように機械学習を進めるのかをdict型の変数で指定します。上のコードでの<code>params</code>がそれ。とりあえずは、<code>objective</code>で何をしたいのかを指定しておけばオッケーです。詳細はLightGBMのドキュメントの<a
href="https://lightgbm.readthedocs.io/en/latest/Parameters.html">Parameters</a>に書いてありますので機械学習に慣れた頃に読んでみてください。今回は生き残ったかどうかの2値分類なので、`objective`に`binary`を指定しました。</p>
<p>で、一般的にはLightGBMは<code>train()</code>メソッドで機械学習するのですけど、上のコードでは<code>cv()</code>メソッドで学習をしています。<code>cv()</code>はcross
validationの略で、日本語では交差検証と呼びます。交差検証は過学習していないかを確認するための方法の一つで、これまでにやってきた訓練データと検証データを分割する（これをホールド・アウト法と呼びます）の仲間、データをいくつかに分割して、そのうちの一つを検証データにして残りを訓練データにするってのを、分割したデータすべてでやって精度を出し、結果を平均化して過学習していないか判断します。</p>
<p><img src="" alt="交差検証" /></p>
<p>過学習していないかの検証の方法は学習とは無関係に思えるかもしれませんけど、過学習したら学習を止めるという意味で使えるんです。ただ、検証データで精度が高かったからどんなデータでも高い精度を出せるかというとそうでもなくて、たまたま検証データの癖に合致したので精度が高かったという危険性があります。特に、今回のようにデータ数が少ない場合はその可能性が高い。そんなあやふやな数値に頼るのは危険ですから、交差検証しながら学習する<code>cv()</code>メソッドを使用するというわけ。</p>
<p>あとは、のちの作業のために予測にどのカラムがどの程度使われたのかと精度を出力して、学習がどのように進んだのかを示す学習曲線を出力します。</p>
<p><img src="./image/learning-curve-titanic-1.png" alt="学習曲線" /></p>
<p>学習曲線で表示しているのは正解と予測の誤差の推移で、縦軸は<code>object</code>は<code>binary</code>の場合の<code>metric</code>のデフォルトである<code>binary_logloss</code>（交差検証しているのでその平均）です。これが小さいほど精度が高くなります。この図の横軸は何かというと、機械学習の用語でエポック（epoch）と呼ばれるもので、データセットを上から下まで全部使用すると1エポックになります。2エポック目では、同じデータセットをやっぱり上から下まで全部使用して学習します。まさに同じ問題集を繰り返し学習しているわけで、だからその問題集に特化した予測をするようになって、過学習して他の問題集の問題を解けなくなっていく可能性が高い。</p>
<p>で、学習曲線を見てみると、20エポックのあたりから精度がだんだん悪くなっているので、まさに過学習していることが分かります。でも、エポック数を減らしてもう一度機械学習しなくても大丈夫。LightGBMはデフォルトだと最も精度が高かったパラメーターを使用して予測をするようになっているので、先のプログラムを実行すると表示される精度の0.795は、20回目あたりのパラメーターを使用した場合の値なんですよ。</p>
<p>ともあれ、8割近く正解できているのであれば、うん、Titanicは予測可能な問題ですね。これで安心できたので、精度向上のための施策をやることにしましょう。</p>
<h2
id="特徴量エンジニアリングで精度を上げる">特徴量エンジニアリングで精度を上げる</h2>
<p>前に、LightGBMは勾配ブースティングで、勾配ブースティングは決定木をバギングするものだと述べました。その決定木ってのは、たしか<code>if/else</code>で予測する仕組みでしたよね？　コードにすると、こんな感じでした。</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> x <span class="op">&lt;=</span> a1:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">&lt;=</span> a2:</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> b1</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> b2</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">&lt;=</span> a3:</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> b3</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> b4</span></code></pre></div>
<p>このコードを眺めていると、たとえば、給料が少ないのでこっそり副業している場合に新しいバイクを買うか予測するような場合に効率が悪いことが分かります。データのカラムが給料と副業の収入に分かれていると、給料がいくら以上で、副業の収入がいくら以上だったら買えるみたいな多段の<code>if</code>にせざるを得なくて、しかも、給料10万円副業100万円や給料100万円副業10万円みたいな様々な組み合わせの<code>if</code>文を作らなければなりません。</p>
<p>ではどうすればよいかというと、給料＋副業の収入を表現する総収入というカラムを追加してあげればよいわけ。Titanicのデータだと、SibSp（同乗した兄弟姉妹と配偶者の数）とParch（同乗した両親と子供の数）がまさにこのケースになります。同乗者がいないと助けてくれる人がいないので死にやすそうですし、同乗者が多いと行動が遅くなるのでやっぱり死にやすそう。だから同乗者の数を入力に追加してあげると精度が向上するんじゃないかな。</p>
<p>このようにカラム（機械学習の人は特徴量（feature）と呼びます）を追加したり、取捨選択したりすることを特徴量エンジニアリングと呼びます。効率が悪かったり無関係だったりするデータから予測をするのは難しいので、機械学習の気持ちになって、できるだけ気持ちよく予測できるようにしてあげる作業です。</p>
<p>で、一般には関係がありそうなデータをかき集めてくる作業になるのですけど、Kaggleだとデータが決められているので、既存の特徴量から新たな特徴量を作成する作業になります。</p>
<p>他の特徴量も見ていきましょう。前回は使わなかったNameの活用を考えてみます。NameにはMr.とかMrs.とかの肩書が含まれていて、肩書から性別や年齢が推測できそうな気がします（Titanicの特徴量には性別や年齢もあるけど、年齢はNaNの場合があるしね）。男性よりも女性、大人よりも子供の方が優先して避難させてもらえそうな気がするので、肩書を追加しましょう。あとは、Fareってのはどうもチケットの合計金額っぽくて、チケットを複数枚買っている場合は高くなっているみたい。チケット料金が安い船室の人は避難が後回しになって死んじゃう可能性が高そうな気がしますから、Fareを家族数で割って単価を出しておきましょう。</p>
<p>というわけで、特徴量エンジニアリングした結果はこんな感じ。</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plot</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> count, repeat</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 特徴量を追加します。</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(data_frame):</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># train.csvでの肩書の内訳は、以下の通り。</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mr.        509</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Miss.      180</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mrs.       125</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Master.     40  少年もしくは青年への敬称らしい</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dr.         11</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Col.        10</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rev.         6  聖職者への敬称らしい</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Don.         2</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Major.       2</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mme.         1</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ms.          1</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Capt.        1</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NaN.         3</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書追加用の補助関数。</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_title(title_series, name_series, <span class="bu">id</span>, titles):</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        title_series[<span class="bu">reduce</span>(<span class="kw">lambda</span> acc, series: acc <span class="op">+</span> series, <span class="bu">map</span>(<span class="kw">lambda</span> title: name_series.<span class="bu">str</span>.contains(title), titles))] <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> title_series</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書を追加します。</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;Title&#39;</span>] <span class="op">=</span> <span class="bu">reduce</span>(<span class="kw">lambda</span> title_series, params: add_title(title_series, data_frame[<span class="st">&#39;Name&#39;</span>], <span class="op">*</span>params),</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>                                 ((<span class="dv">0</span>, (<span class="st">&#39;Mr.&#39;</span>, <span class="st">&#39;Dr.&#39;</span>, <span class="st">&#39;Rev.&#39;</span>, <span class="st">&#39;Don.&#39;</span>, <span class="st">&#39;Col.&#39;</span>, <span class="st">&#39;Major.&#39;</span>, <span class="st">&#39;Capt.&#39;</span>)),</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">1</span>, (<span class="st">&#39;Master.&#39;</span>,)),</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">2</span>, (<span class="st">&#39;Mrs.&#39;</span>, <span class="st">&#39;Mme.&#39;</span>, <span class="st">&#39;Ms.&#39;</span>)),</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">3</span>, (<span class="st">&#39;Miss.&#39;</span>,))),</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>                                 pd.Series(repeat(np.nan, <span class="bu">len</span>(data_frame[<span class="st">&#39;Name&#39;</span>])), dtype<span class="op">=</span><span class="st">&#39;object&#39;</span>))</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 家族の人数を追加します。</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;FamilySize&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;SibSp&#39;</span>] <span class="op">+</span> data_frame[<span class="st">&#39;Parch&#39;</span>]</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 料金は合計みたいなので、単価を追加します。</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;FareUnitPrice&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;Fare&#39;</span>] <span class="op">/</span> data_frame[<span class="st">&#39;FamilySize&#39;</span>]</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリ型の特徴量を、どの数値に変換するかのdictを取得します。</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_categorical_features(data_frame):</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">map</span>(<span class="kw">lambda</span> feature: (feature, <span class="bu">dict</span>(<span class="bu">zip</span>(data_frame[feature].factorize()[<span class="dv">1</span>], count()))), (<span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>)))</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xs(data_frame, categorical_features):</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># カテゴリ型の特徴量を、数値に変換します。</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, mapping <span class="kw">in</span> categorical_features.items():</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>        data_frame[feature] <span class="op">=</span> data_frame[feature].<span class="bu">map</span>(mapping).fillna(<span class="op">-</span><span class="dv">1</span>).astype(<span class="st">&#39;category&#39;</span>)</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測に使用するカラムだけを抽出します。NameとTicketは関係なさそうなので無視、Cabinは欠損地が多いので無視しました。</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[[<span class="st">&#39;Pclass&#39;</span>, <span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Age&#39;</span>, <span class="st">&#39;SibSp&#39;</span>, <span class="st">&#39;Parch&#39;</span>, <span class="st">&#39;Fare&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>, <span class="st">&#39;FamilySize&#39;</span>, <span class="st">&#39;FareUnitPrice&#39;</span>]]</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a><span class="co"># 正解を取得します。</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ys(data_frame):</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[<span class="st">&#39;Survived&#39;</span>]</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a><span class="co"># データを読み込んで、前準備をします。</span></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> add_features(pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, <span class="st">&#39;titanic&#39;</span>, <span class="st">&#39;train.csv&#39;</span>)))</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> get_categorical_features(data_frame)</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features)</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データセットを取得します。</span></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>train_xs <span class="op">=</span> xs[<span class="dv">200</span>:]</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>train_ys <span class="op">=</span> ys[<span class="dv">200</span>:]</span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証データセットを取得します。test.csvを使ってKaggleに問い合わせる方式は、面倒な上に数をこなせないためです。</span></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>valid_xs <span class="op">=</span> xs[:<span class="dv">200</span>]</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>valid_ys <span class="op">=</span> ys[:<span class="dv">200</span>]</span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a><span class="co"># LightGBMのパラメーターを作成します。</span></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> {</span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;objective&#39;</span>: <span class="st">&#39;binary&#39;</span>,  <span class="co"># 2値分類。</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;force_col_wise&#39;</span>: <span class="va">True</span>  <span class="co"># 警告を消すために付けました。</span></span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a><span class="co"># 交差検証で機械学習します。</span></span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>cv_result <span class="op">=</span> lgb.cv(params, lgb.Dataset(train_xs, label<span class="op">=</span>train_ys), return_cvbooster<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> cv_result[<span class="st">&#39;cvbooster&#39;</span>]</span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a><span class="co"># 特徴量の重要性を出力します。</span></span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame({<span class="st">&#39;feature&#39;</span>: model.boosters[<span class="dv">0</span>].feature_name(), <span class="st">&#39;importance&#39;</span>: np.mean(model.feature_importance(), axis<span class="op">=</span><span class="dv">0</span>)}).sort_values(<span class="st">&#39;importance&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a><span class="co"># 精度を出力します。</span></span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Accuracy = </span><span class="sc">{</span>accuracy_score(valid_ys, np.mean(model.predict(valid_xs), axis<span class="op">=</span><span class="dv">0</span>) <span class="op">&gt;=</span> <span class="fl">0.5</span>)<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a><span class="co"># 学習曲線を出力します。</span></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>plot.plot(cv_result[<span class="st">&#39;binary_logloss-mean&#39;</span>])</span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>plot.show()</span></code></pre></div>
<p>前のコードに、特徴量を追加する処理を追加しただけですね。精度が0.795→0.81に上がりましたので、特徴量エンジニアリングの効果を確認できました。</p>
<h2
id="統計の手法を使えば特徴量エンジニアリングは効率化できる">統計の手法を使えば特徴量エンジニアリングは効率化できる</h2>
<p>先ほどの特徴量エンジニアリングなのですが、実は統計の手法を使うと効率よく作業できる（みたい）です。</p>
<p>仮説を立てて仮説をプログラミングして精度を検証する、というのが前で述べたやり方なのですけど、仮説を立てる際にもプログラミングの前に仮説の妥当性を検証するにも、統計の手法が有効（っぽい）んです。</p>
<p>でも私は文系で統計手法を知らないので、勢いだけで仮説を立てて速攻でプログラミングして、検証してみたら精度が上がらなくて木端微塵にされるってのを繰り返しています。皆様は私を反面教師に統計手法を勉強（pandasでの統計量の可視化手法のマスターでも可）するのが良いかと愚考します。</p>
<p>私はこれからも「統計で調べるより短い時間で仮説をプログラミングすれば問題はないんだよ！」と言い張るるもりだけどな！</p>
<h2
id="optunaでハイパーパラメーターチューニング">Optunaでハイパー・パラメーター・チューニング</h2>
<p>さて、LightGBMのハイパー・パラメーターはドキュメントの<a
href="https://lightgbm.readthedocs.io/en/latest/Parameters.html">Parameters</a>に書いてあって、チューニングのやり方は<a
href="https://lightgbm.readthedocs.io/en/latest/Parameters-Tuning.html">Parameter
Tuning</a>に書いてあるのですけど、読むのが面倒くさい……。</p>
<p>でも精度向上のためにハイパー・パラメーター・チューニングをやりたい！　というわけで、ツールに頼りましょう。Preferred
Networks社が<a
href="https://github.com/optuna/optuna">Optuna</a>というオープン・ソースのツールを提供してくださっていて、これを使えば全自動でハイパー・パラメーターをチューニングできるんです。</p>
<p>Optunaを使うコードはこんな感じ。</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> optuna.integration.lightgbm <span class="im">as</span> lgb</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> count, repeat</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 特徴量を追加します。</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(data_frame):</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書追加用の補助関数。</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_title(title_series, name_series, <span class="bu">id</span>, titles):</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        title_series[<span class="bu">reduce</span>(<span class="kw">lambda</span> acc, series: acc <span class="op">+</span> series, <span class="bu">map</span>(<span class="kw">lambda</span> title: name_series.<span class="bu">str</span>.contains(title), titles))] <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> title_series</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書を追加します。</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;Title&#39;</span>] <span class="op">=</span> <span class="bu">reduce</span>(<span class="kw">lambda</span> title_series, params: add_title(title_series, data_frame[<span class="st">&#39;Name&#39;</span>], <span class="op">*</span>params),</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>                                 ((<span class="dv">0</span>, (<span class="st">&#39;Mr.&#39;</span>, <span class="st">&#39;Dr.&#39;</span>, <span class="st">&#39;Rev.&#39;</span>, <span class="st">&#39;Don.&#39;</span>, <span class="st">&#39;Col.&#39;</span>, <span class="st">&#39;Major.&#39;</span>, <span class="st">&#39;Capt.&#39;</span>)),</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">1</span>, (<span class="st">&#39;Master.&#39;</span>,)),</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">2</span>, (<span class="st">&#39;Mrs.&#39;</span>, <span class="st">&#39;Mme.&#39;</span>, <span class="st">&#39;Ms.&#39;</span>)),</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">3</span>, (<span class="st">&#39;Miss.&#39;</span>,))),</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>                                 pd.Series(repeat(np.nan, <span class="bu">len</span>(data_frame[<span class="st">&#39;Name&#39;</span>])), dtype<span class="op">=</span><span class="st">&#39;object&#39;</span>))</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 家族の人数を追加します。</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;FamilySize&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;SibSp&#39;</span>] <span class="op">+</span> data_frame[<span class="st">&#39;Parch&#39;</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 料金は合計みたいなので、単価を追加します。</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;FareUnitPrice&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;Fare&#39;</span>] <span class="op">/</span> data_frame[<span class="st">&#39;FamilySize&#39;</span>]</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリ型の特徴量を、どの数値に変換するかのdictを取得します。</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_categorical_features(data_frame):</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">map</span>(<span class="kw">lambda</span> feature: (feature, <span class="bu">dict</span>(<span class="bu">zip</span>(data_frame[feature].factorize()[<span class="dv">1</span>], count()))), (<span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>)))</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xs(data_frame, categorical_features):</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># カテゴリ型の特徴量を、数値に変換します。</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, mapping <span class="kw">in</span> categorical_features.items():</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        data_frame[feature] <span class="op">=</span> data_frame[feature].<span class="bu">map</span>(mapping).fillna(<span class="op">-</span><span class="dv">1</span>).astype(<span class="st">&#39;category&#39;</span>)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測に使用するカラムだけを抽出します。NameとTicketは関係なさそうなので無視、Cabinは欠損地が多いので無視しました。</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[[<span class="st">&#39;Pclass&#39;</span>, <span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Age&#39;</span>, <span class="st">&#39;SibSp&#39;</span>, <span class="st">&#39;Parch&#39;</span>, <span class="st">&#39;Fare&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>, <span class="st">&#39;FamilySize&#39;</span>, <span class="st">&#39;FareUnitPrice&#39;</span>]]</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 正解を取得します。</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ys(data_frame):</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[<span class="st">&#39;Survived&#39;</span>]</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="co"># データを読み込んで、前準備をします。</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> add_features(pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, <span class="st">&#39;titanic&#39;</span>, <span class="st">&#39;train.csv&#39;</span>)))</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> get_categorical_features(data_frame)</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。Optunaを信用しているので検証は不要と考え、検証データは作成しません。データ量が多い方が正確なハイパー・パラメーターになりますし。</span></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features)</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a><span class="co"># LightGBMのパラメーターを作成します。</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> {</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;objective&#39;</span>: <span class="st">&#39;binary&#39;</span>,  <span class="co"># 2値分類。</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;force_col_wise&#39;</span>: <span class="va">True</span>  <span class="co"># 警告を消すために付けました。</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a><span class="co"># 交差検証でハイパー・パラメーター・チューニングをします。</span></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> lgb.LightGBMTunerCV(params, lgb.Dataset(xs, label<span class="op">=</span>ys), return_cvbooster<span class="op">=</span><span class="va">True</span>, optuna_seed<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>cv_result <span class="op">=</span> tuner.run()</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tuner.get_best_booster()</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a><span class="co"># 特徴量の重要性を出力します。</span></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame({<span class="st">&#39;feature&#39;</span>: model.boosters[<span class="dv">0</span>].feature_name(), <span class="st">&#39;importance&#39;</span>: np.mean(model.feature_importance(), axis<span class="op">=</span><span class="dv">0</span>)}).sort_values(<span class="st">&#39;importance&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a><span class="co"># ハイパー・パラメーターを出力します。</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tuner.best_params)</span></code></pre></div>
<p>一目見て分かるように、ほとんどコードは変わりません。<code>cv()</code>じゃなくて<code>train()</code>する場合であれば、<code>import lightgbm as lgb</code>を<code>import optuna.integration.lightgbm as lgb</code>に変えるだけという楽ちん仕様です。<code>cv()</code>の場合でも、上のコードを参考に<code>LightGBMTunerCV</code>を使うように修正するだけでオッケー。</p>
<p>たったこれだけで、ハイパー・パラメーター・チューニングは終了です。このプログラムの実行にはちょっと時間がかかりますけど、手でハイパー・パラメーター・チューニングするより速いし、なにより楽ちんです。</p>
<h2 id="成果を確認する">成果を確認する</h2>
<p>これまでの成果を確認してみましょう。2つ前の特徴量エンジニアリングのコードに、Optunaが作成したパラメーターを埋め込みます。</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plot</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> count, repeat</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 特徴量を追加します。</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(data_frame):</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書追加用の補助関数。</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_title(title_series, name_series, <span class="bu">id</span>, titles):</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        title_series[<span class="bu">reduce</span>(<span class="kw">lambda</span> acc, series: acc <span class="op">+</span> series, <span class="bu">map</span>(<span class="kw">lambda</span> title: name_series.<span class="bu">str</span>.contains(title), titles))] <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> title_series</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書を追加します。</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;Title&#39;</span>] <span class="op">=</span> <span class="bu">reduce</span>(<span class="kw">lambda</span> title_series, params: add_title(title_series, data_frame[<span class="st">&#39;Name&#39;</span>], <span class="op">*</span>params),</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>                                 ((<span class="dv">0</span>, (<span class="st">&#39;Mr.&#39;</span>, <span class="st">&#39;Dr.&#39;</span>, <span class="st">&#39;Rev.&#39;</span>, <span class="st">&#39;Don.&#39;</span>, <span class="st">&#39;Col.&#39;</span>, <span class="st">&#39;Major.&#39;</span>, <span class="st">&#39;Capt.&#39;</span>)),</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">1</span>, (<span class="st">&#39;Master.&#39;</span>,)),</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">2</span>, (<span class="st">&#39;Mrs.&#39;</span>, <span class="st">&#39;Mme.&#39;</span>, <span class="st">&#39;Ms.&#39;</span>)),</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">3</span>, (<span class="st">&#39;Miss.&#39;</span>,))),</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>                                 pd.Series(repeat(np.nan, <span class="bu">len</span>(data_frame[<span class="st">&#39;Name&#39;</span>])), dtype<span class="op">=</span><span class="st">&#39;object&#39;</span>))</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 家族の人数を追加します。</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;FamilySize&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;SibSp&#39;</span>] <span class="op">+</span> data_frame[<span class="st">&#39;Parch&#39;</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 料金は合計みたいなので、単価を追加します。</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;FareUnitPrice&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;Fare&#39;</span>] <span class="op">/</span> data_frame[<span class="st">&#39;FamilySize&#39;</span>]</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリ型の特徴量を、どの数値に変換するかのdictを取得します。</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_categorical_features(data_frame):</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">map</span>(<span class="kw">lambda</span> feature: (feature, <span class="bu">dict</span>(<span class="bu">zip</span>(data_frame[feature].factorize()[<span class="dv">1</span>], count()))), (<span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>)))</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xs(data_frame, categorical_features):</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># カテゴリ型の特徴量を、数値に変換します。</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, mapping <span class="kw">in</span> categorical_features.items():</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>        data_frame[feature] <span class="op">=</span> data_frame[feature].<span class="bu">map</span>(mapping).fillna(<span class="op">-</span><span class="dv">1</span>).astype(<span class="st">&#39;category&#39;</span>)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測に使用するカラムだけを抽出します。NameとTicketは関係なさそうなので無視、Cabinは欠損地が多いので無視しました。</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[[<span class="st">&#39;Pclass&#39;</span>, <span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Age&#39;</span>, <span class="st">&#39;SibSp&#39;</span>, <span class="st">&#39;Parch&#39;</span>, <span class="st">&#39;Fare&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>, <span class="st">&#39;FamilySize&#39;</span>, <span class="st">&#39;FareUnitPrice&#39;</span>]]</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a><span class="co"># 正解を取得します。</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ys(data_frame):</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[<span class="st">&#39;Survived&#39;</span>]</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a><span class="co"># データを読み込んで、前準備をします。</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> add_features(pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, <span class="st">&#39;titanic&#39;</span>, <span class="st">&#39;train.csv&#39;</span>)))</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> get_categorical_features(data_frame)</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features)</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データセットを取得します。</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>train_xs <span class="op">=</span> xs[<span class="dv">200</span>:]</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>train_ys <span class="op">=</span> ys[<span class="dv">200</span>:]</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証データセットを取得します。test.csvを使ってKaggleに問い合わせる方式は、面倒な上に数をこなせないためです。</span></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>valid_xs <span class="op">=</span> xs[:<span class="dv">200</span>]</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>valid_ys <span class="op">=</span> ys[:<span class="dv">200</span>]</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a><span class="co"># LightGBMのパラメーターを作成します。Optunaが作成したパラメーターを使用します。</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> {</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;objective&#39;</span>: <span class="st">&#39;binary&#39;</span>,</span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;force_col_wise&#39;</span>: <span class="va">True</span>,</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;feature_pre_filter&#39;</span>: <span class="va">False</span>,</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;lambda_l1&#39;</span>: <span class="fl">1.4361833756015463</span>,</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;lambda_l2&#39;</span>: <span class="fl">2.760985217750726e-07</span>,</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;num_leaves&#39;</span>: <span class="dv">5</span>,</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;feature_fraction&#39;</span>: <span class="fl">0.4</span>,</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;bagging_fraction&#39;</span>: <span class="fl">1.0</span>,</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;bagging_freq&#39;</span>: <span class="dv">0</span>,</span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;min_child_samples&#39;</span>: <span class="dv">20</span></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a><span class="co"># 交差検証で機械学習します。</span></span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>cv_result <span class="op">=</span> lgb.cv(params, lgb.Dataset(train_xs, label<span class="op">=</span>train_ys), return_cvbooster<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> cv_result[<span class="st">&#39;cvbooster&#39;</span>]</span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a><span class="co"># 特徴量の重要性を出力します。</span></span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame({<span class="st">&#39;feature&#39;</span>: model.boosters[<span class="dv">0</span>].feature_name(), <span class="st">&#39;importance&#39;</span>: np.mean(model.feature_importance(), axis<span class="op">=</span><span class="dv">0</span>)}).sort_values(<span class="st">&#39;importance&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a><span class="co"># 精度を出力します。</span></span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Accuracy = </span><span class="sc">{</span>accuracy_score(valid_ys, np.mean(model.predict(valid_xs), axis<span class="op">=</span><span class="dv">0</span>) <span class="op">&gt;=</span> <span class="fl">0.5</span>)<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a><span class="co"># 学習曲線を出力します。</span></span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>plot.plot(cv_result[<span class="st">&#39;binary_logloss-mean&#39;</span>])</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>plot.show()</span></code></pre></div>
<p>精度は、0.81→0.82になりました。まぁ精度は誤差の気もしますけど、学習曲線がとてもきれいになったのがとにかく嬉しい！</p>
<p><img src="./image/learning-curve-titanic-4.png" alt="学習曲線" /></p>
<p>過学習を防ぐ方法は、よりシンプルな機械学習モデルを作るか、データ量を増やすかになります（パラメーターを正則化するというのもありますけど省略で）。で、Optunaが絶妙なシンプル具合になる（かつ、イイ感じの正則化を入れた）ハイパー・パラメーターを作成してくれたので、過学習しない学習曲線になったというわけです。</p>
<p>さて、ここまで話がとんとん拍子に進んだように書いてきましたけど、実際は、こんなにうまくは進みません。特徴量エンジニアリングで精度が上がっても、ハイパー・パラメーター・チューニングで特徴量の扱われ方が変わって効果が微妙になったりね。なので実際は、Optunaでハイパー・パラメーター・チューニング→チューニングされたハイパー・パラメーターを使用してひたすら特徴量エンジニアリング（ときどきはハイパー・パラメーター・チューニングもやり直す）という感じになります。</p>
<p>で、そのひたすら繰り返す特徴量エンジニアリングで役に立つのが、特徴量の重要性です。プログラムを実行すると、以下のような情報が出力されていましたよね？</p>
<pre><code>         feature  importance
2            Age        90.0
9  FareUnitPrice        64.8
0         Pclass        61.0
5           Fare        44.4
6       Embarked        34.4
8     FamilySize        32.8
7          Title        25.4
1            Sex        17.2
4          Parch        13.4
3          SibSp         7.4</code></pre>
<p>これ、特徴量が決定木で使われた数（の平均）です。おお、やっぱり若者と金持ちが優先で、だからおっさんで貧乏な私は後回しなんだと世の中が理解できるようになって、特徴量エンジニアリングが進むんじゃないかな。</p>
<h2 id="予測モデルを作成する">予測モデルを作成する</h2>
<p>さて、これでチューニングは概ね終了したので、結果をKaggleに提出して採点したい。Kaggleに提出するだけなら学習から予測まで一気通貫で実施するプログラムで良いのですけど、実際にシステムを開発するときはそんなわけにはいきません。本番環境で学習するなんて無駄ですもんね。学習は事前にやっておけばよいんです。</p>
<p>だから、まずは、機械学習して予測モデルを作成するプログラムです。こんな感じ。</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plot</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> count, repeat</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 特長量を追加します。</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(data_frame):</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書追加用の補助関数。</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_title(title_series, name_series, <span class="bu">id</span>, titles):</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        title_series[<span class="bu">reduce</span>(<span class="kw">lambda</span> acc, series: acc <span class="op">+</span> series, <span class="bu">map</span>(<span class="kw">lambda</span> title: name_series.<span class="bu">str</span>.contains(title), titles))] <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> title_series</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書を追加します。</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;Title&#39;</span>] <span class="op">=</span> <span class="bu">reduce</span>(<span class="kw">lambda</span> title_series, params: add_title(title_series, data_frame[<span class="st">&#39;Name&#39;</span>], <span class="op">*</span>params),</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>                                 ((<span class="dv">0</span>, (<span class="st">&#39;Mr.&#39;</span>, <span class="st">&#39;Dr.&#39;</span>, <span class="st">&#39;Rev.&#39;</span>, <span class="st">&#39;Don.&#39;</span>, <span class="st">&#39;Col.&#39;</span>, <span class="st">&#39;Major.&#39;</span>, <span class="st">&#39;Capt.&#39;</span>)),</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">1</span>, (<span class="st">&#39;Master.&#39;</span>,)),</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">2</span>, (<span class="st">&#39;Mrs.&#39;</span>, <span class="st">&#39;Mme.&#39;</span>, <span class="st">&#39;Ms.&#39;</span>)),</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">3</span>, (<span class="st">&#39;Miss.&#39;</span>,))),</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>                                 pd.Series(repeat(np.nan, <span class="bu">len</span>(data_frame[<span class="st">&#39;Name&#39;</span>])), dtype<span class="op">=</span><span class="st">&#39;object&#39;</span>))</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 家族の人数を追加します。</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;FamilySize&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;SibSp&#39;</span>] <span class="op">+</span> data_frame[<span class="st">&#39;Parch&#39;</span>]</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 料金は合計みたいなので、単価を追加します。</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;FareUnitPrice&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;Fare&#39;</span>] <span class="op">/</span> data_frame[<span class="st">&#39;FamilySize&#39;</span>]</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリ型の特長量を、どの数値に変換するかのdictを取得します。</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_categorical_features(data_frame):</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">map</span>(<span class="kw">lambda</span> feature: (feature, <span class="bu">dict</span>(<span class="bu">zip</span>(data_frame[feature].factorize()[<span class="dv">1</span>], count()))), (<span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>)))</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xs(data_frame, categorical_features):</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># カテゴリ型の特長量を、数値に変換します。</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, mapping <span class="kw">in</span> categorical_features.items():</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>        data_frame[feature] <span class="op">=</span> data_frame[feature].<span class="bu">map</span>(mapping).fillna(<span class="op">-</span><span class="dv">1</span>).astype(<span class="st">&#39;category&#39;</span>)</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測に使用するカラムだけを抽出します。NameとTicketは関係なさそうなので無視、Cabinは欠損地が多いので無視しました。</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[[<span class="st">&#39;Pclass&#39;</span>, <span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Age&#39;</span>, <span class="st">&#39;SibSp&#39;</span>, <span class="st">&#39;Parch&#39;</span>, <span class="st">&#39;Fare&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>, <span class="st">&#39;FamilySize&#39;</span>, <span class="st">&#39;FareUnitPrice&#39;</span>]]</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 正解を取得します。</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ys(data_frame):</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[<span class="st">&#39;Survived&#39;</span>]</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a><span class="co"># 機械学習モデルを保存します。</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_model(model):</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, booster <span class="kw">in</span> <span class="bu">enumerate</span>(model.boosters):  <span class="co"># 交差検証なので、複数のモデルが生成されます。</span></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>        booster.save_model(path.join(<span class="st">&#39;titanic-model&#39;</span>, <span class="ss">f&#39;model-</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">.txt&#39;</span>))</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリ型の特長量を、どの数値に変換するかのdictを保存します。</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_categorical_features(categorical_features):</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path.join(<span class="st">&#39;titanic-model&#39;</span>, <span class="st">&#39;categorical-features.pickle&#39;</span>), mode<span class="op">=</span><span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>        pickle.dump(categorical_features, f)</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a><span class="co"># データを読み込んで、前準備をします。</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> add_features(pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, <span class="st">&#39;titanic&#39;</span>, <span class="st">&#39;train.csv&#39;</span>)))</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> get_categorical_features(data_frame)</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。できるだけ精度を上げたいので、すべてのデータを使用して機械学習します。</span></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features)</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a><span class="co"># LightGBMのパラメーターを作成します。Optunaが作成したパラメーター（+ learning_rate）を使用します。</span></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> {</span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;objective&#39;</span>: <span class="st">&#39;binary&#39;</span>,</span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;force_col_wise&#39;</span>: <span class="va">True</span>,</span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;feature_pre_filter&#39;</span>: <span class="va">False</span>,</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;lambda_l1&#39;</span>: <span class="fl">1.4361833756015463</span>,</span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;lambda_l2&#39;</span>: <span class="fl">2.760985217750726e-07</span>,</span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;num_leaves&#39;</span>: <span class="dv">5</span>,</span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;feature_fraction&#39;</span>: <span class="fl">0.4</span>,</span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;bagging_fraction&#39;</span>: <span class="fl">1.0</span>,</span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;bagging_freq&#39;</span>: <span class="dv">0</span>,</span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;min_child_samples&#39;</span>: <span class="dv">20</span>,</span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;learning_rate&#39;</span>: <span class="fl">0.01</span></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a><span class="co"># 交差検証法で機械学習します。</span></span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a>cv_result <span class="op">=</span> lgb.cv(params, lgb.Dataset(xs, label<span class="op">=</span>ys), num_boost_round<span class="op">=</span><span class="dv">1000</span>, return_cvbooster<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> cv_result[<span class="st">&#39;cvbooster&#39;</span>]</span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a><span class="co"># モデル保存用のディレクトリを作成します。</span></span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a>os.makedirs(<span class="st">&#39;titanic-model&#39;</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを保存します。</span></span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a>save_model(model)</span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a>save_categorical_features(categorical_features)</span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a><span class="co"># 学習曲線を出力します。</span></span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a>plot.plot(cv_result[<span class="st">&#39;binary_logloss-mean&#39;</span>])</span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a>plot.show()</span></code></pre></div>
<p>LightGBMのパラメーターに学習率（learning
rate）である<code>learning_rate</code>を追加しているところに注意してください。勾配降下法では正解との誤差に基づいてパラメーターを調整していくのですけど、学習率を設定することで、大きく一気に調整したり小さく小刻みに調整したりできます。学習率が大きければ学習が早く終わりますけど調整が大雑把なので精度はそんなに高くない、小さい場合はその逆で時間はかかるけど精度が高くなります。</p>
<p>特徴量エンジニアリングするときには早くサイクルを回したいので学習率を大きく（デフォルト値でも十分に大きい）、最終成果物を作るときには学習率を小さくします。今回は、デフォルト値の1/10に設定しました。</p>
<p>で、学習率を下げた分だけ学習が遅くなりますから、エポック数に相当する<code>num_boost_round</code>（<code>cv()</code>の引数です）の値を大きくしています。</p>
<p>あとは、交差検証なので複数のモデルが作られるのでそれらを全部保存することと、カテゴリーの特徴量を数値化するための情報も帆損しなければなりません。それ以外は、少しでも精度を上げるために検証データを作らずにすべてのデータで学習しているくらいかな。</p>
<p>あ、今回はKaggleのnotebookで実行しやすいようにモジュール化していませんけど、次の回帰でやるようにモジュール化すればもっとシンプルなコードにできます。実案件ではモジュール化してみてください。</p>
<h2 id="解答を作成する">解答を作成する</h2>
<p>実際のシステムでは本番環境で動く部分に相当する、予測をするプログラムを作ります。保存された予測モデルをロードして、test.csvを使用して予測をしてKaggle提出量のCSVファイルを作成します。</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> count, repeat</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 特長量を追加します。</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(data_frame):</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書追加用の補助関数。</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_title(title_series, name_series, <span class="bu">id</span>, titles):</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        title_series[<span class="bu">reduce</span>(<span class="kw">lambda</span> acc, series: acc <span class="op">+</span> series, <span class="bu">map</span>(<span class="kw">lambda</span> title: name_series.<span class="bu">str</span>.contains(title), titles))] <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> title_series</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書を追加します。</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;Title&#39;</span>] <span class="op">=</span> <span class="bu">reduce</span>(<span class="kw">lambda</span> title_series, params: add_title(title_series, data_frame[<span class="st">&#39;Name&#39;</span>], <span class="op">*</span>params),</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                                 ((<span class="dv">0</span>, (<span class="st">&#39;Mr.&#39;</span>, <span class="st">&#39;Dr.&#39;</span>, <span class="st">&#39;Rev.&#39;</span>, <span class="st">&#39;Don.&#39;</span>, <span class="st">&#39;Col.&#39;</span>, <span class="st">&#39;Major.&#39;</span>, <span class="st">&#39;Capt.&#39;</span>)),</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">1</span>, (<span class="st">&#39;Master.&#39;</span>,)),</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">2</span>, (<span class="st">&#39;Mrs.&#39;</span>, <span class="st">&#39;Mme.&#39;</span>, <span class="st">&#39;Ms.&#39;</span>)),</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">3</span>, (<span class="st">&#39;Miss.&#39;</span>,))),</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>                                 pd.Series(repeat(np.nan, <span class="bu">len</span>(data_frame[<span class="st">&#39;Name&#39;</span>])), dtype<span class="op">=</span><span class="st">&#39;object&#39;</span>))</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 家族の人数を追加します。</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;FamilySize&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;SibSp&#39;</span>] <span class="op">+</span> data_frame[<span class="st">&#39;Parch&#39;</span>]</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 料金は合計みたいなので、単価を追加します。</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;FareUnitPrice&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;Fare&#39;</span>] <span class="op">/</span> data_frame[<span class="st">&#39;FamilySize&#39;</span>]</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリ型の特長量を、どの数値に変換するかのdictを取得します。</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_categorical_features(data_frame):</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">map</span>(<span class="kw">lambda</span> feature: (feature, <span class="bu">dict</span>(<span class="bu">zip</span>(data_frame[feature].factorize()[<span class="dv">1</span>], count()))), (<span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>)))</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xs(data_frame, categorical_features):</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># カテゴリ型の特長量を、数値に変換します。</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, mapping <span class="kw">in</span> categorical_features.items():</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>        data_frame[feature] <span class="op">=</span> data_frame[feature].<span class="bu">map</span>(mapping).fillna(<span class="op">-</span><span class="dv">1</span>).astype(<span class="st">&#39;category&#39;</span>)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測に使用するカラムだけを抽出します。NameとTicketは関係なさそうなので無視、Cabinは欠損地が多いので無視しました。</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[[<span class="st">&#39;Pclass&#39;</span>, <span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Age&#39;</span>, <span class="st">&#39;SibSp&#39;</span>, <span class="st">&#39;Parch&#39;</span>, <span class="st">&#39;Fare&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>, <span class="st">&#39;FamilySize&#39;</span>, <span class="st">&#39;FareUnitPrice&#39;</span>]]</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Kaggleのnotebookなのかを判定します。</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_kaggle_notebook():</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;_dh&#39;</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="bu">globals</span>()[<span class="st">&#39;_dh&#39;</span>] <span class="op">==</span> [<span class="st">&#39;/kaggle/working&#39;</span>]</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルをロードします。</span></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_model():</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> lgb.CVBooster()</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>    base_path <span class="op">=</span> <span class="st">&#39;.&#39;</span> <span class="cf">if</span> <span class="kw">not</span> is_kaggle_notebook() <span class="cf">else</span> path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>)  <span class="co"># KaggleのnotebookのDatasetは../inputに展開されます。。。</span></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> <span class="bu">sorted</span>(glob(path.join(base_path, <span class="st">&#39;titanic-model&#39;</span>, <span class="st">&#39;model-*.txt&#39;</span>))):  <span class="co"># 交差検証なので、複数のモデルが生成されます。</span></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>        result.boosters.append(lgb.Booster(model_file<span class="op">=</span><span class="bu">file</span>))</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリ型の特長量を、どの数値に変換するかのdictをロードします。</span></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_categorical_features():</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>    base_path <span class="op">=</span> <span class="st">&#39;.&#39;</span> <span class="cf">if</span> <span class="kw">not</span> is_kaggle_notebook() <span class="cf">else</span> path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>)  <span class="co"># KaggleのnotebookのDatasetは../inputに展開されます。。。</span></span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path.join(base_path, <span class="st">&#39;titanic-model&#39;</span>, <span class="st">&#39;categorical-features.pickle&#39;</span>), mode<span class="op">=</span><span class="st">&#39;rb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pickle.load(f)</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルをロードします。</span></span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> load_model()</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> load_categorical_features()</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a><span class="co"># データを読み込んで、前準備をします。</span></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> add_features(pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, <span class="st">&#39;titanic&#39;</span>, <span class="st">&#39;test.csv&#39;</span>)))</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>data_frame[<span class="st">&#39;Fare&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;Fare&#39;</span>].fillna(data_frame[<span class="st">&#39;Fare&#39;</span>].mean())  <span class="co"># train.csvにはないけど、test.csvのFareにはNaNがある。。。</span></span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a><span class="co"># 予測用のデータを取得します。</span></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features)</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a><span class="co"># 予測して、結果をCSVとして保存します。</span></span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>submission <span class="op">=</span> pd.DataFrame({<span class="st">&#39;PassengerId&#39;</span>: data_frame[<span class="st">&#39;PassengerId&#39;</span>], <span class="st">&#39;Survived&#39;</span>: (np.mean(model.predict(xs), axis<span class="op">=</span><span class="dv">0</span>) <span class="op">&gt;=</span> <span class="fl">0.5</span>).astype(np.int32)})</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>submission.to_csv(<span class="st">&#39;submission.csv&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<p>機械学習モデルの読み込みはLightGBMの<code>Booseter</code>のコンストラクタで<code>model_file</code>を指定すればオッケー。交差検証なので複数のモデルがあることだけ注意。あと、Kaggleのnotebookで実行する場合、追加したファイルは../inputに展開されるので、Kaggleのnotebookの場合用の分岐も入れています。残りの予測をする部分は、これまでと同じです。</p>
<p>これでプログラミングがすべて完了したので、作成されたCSVファイルをKaggleに提出して、スコアを見てみると……0.77990で3,282位でした。スコアが0.8くらいの人のやり方を参考にすれば、もう少し精度を上げられるかもしれません。Leaderboardに並んでいるスコア1.0の連中は<a
href="https://www.kaggle.com/maryragozina/notebook9849f51564?scriptVersionId=85357609">カンニングしている</a>ので、参考にしては駄目です。</p>
<p>あとね、いくらスコアが高くても、たまたまtest.csvに合っていただけという可能性もあるんですよ……。Kaggleのコンペでは競技中はテスト・データの一部を使用したスコアでの順位しか表示されず、最終的な順位はテスト・データの残りでスコアで決定されます。テスト・データの一部に過剰にフィットしていただけだったので、競技中はスコアが高かったけど最終的には低かったなんて場合もあります。だから、スコアを上げるためだけにさらにハイパー・パラメーターを手でチューニングしたりするのは無意味だと思います。</p>
<p>というかね、0.77990って、スコアの最頻値よりも良い、そこそこ自慢して良いスコアだと思うんですよ（精度なので、大きいほど良いです）。公式のチュートリアルのスコアが0.77751みたいですし、実際の案件だったらそれでビジネスが成り立つ精度であれば十分なわけですし。</p>
<p><img src="./image/score-histgram-titanic.png"
alt="Titanicのスコアのヒストグラム" /></p>
<p>というわけで、LightGBMとOptunaを使って、あと少しだけ特長量エンジニアリングすれば、機械学習で簡単にそこそこの精度を出せることがわかりました。しかも、特長量エンジニアリングまで含めて、全てが慣れ親しんだプログラミング作業です。</p>
<p>ほら、アルゴリズムを考えるのが面倒だからとりあえず機械学習してみるってのは、十分アリだと思いませんか？</p>
<h1 id="勾配ブースティングで回帰">勾配ブースティングで回帰</h1>
<p>続いて、やはりKaggleのGetting Startedの<a
href="https://www.kaggle.com/c/house-prices-advanced-regression-techniques">House
Prices</a>をやってみましょう。今度は回帰分析です。あと、Titanicではやらなかったモジュール化でやります。KaggleのNotebookで動かすのは少し大変かもしれませんけど気にしない方向で。</p>
<h2 id="データセットを取得する">データセットを取得する</h2>
<p>まずは、データセットを取得するモジュール（dataset.py）を作成します。</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> concat, count, repeat</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 大小関係がある文字列の特長量を数値に変換します。</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert_to_number(data_frame):</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, names <span class="kw">in</span> concat(<span class="bu">zip</span>((<span class="st">&#39;Utilities&#39;</span>,),</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>                                     repeat((<span class="st">&#39;AllPub&#39;</span>, <span class="st">&#39;NoSewr&#39;</span>, <span class="st">&#39;NoSeWa&#39;</span>, <span class="st">&#39;ELO&#39;</span>))),</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>                                 <span class="bu">zip</span>((<span class="st">&#39;LandSlope&#39;</span>,),</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>                                     repeat((<span class="st">&#39;Gtl&#39;</span>, <span class="st">&#39;Mod&#39;</span>, <span class="st">&#39;Sev&#39;</span>))),</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>                                 <span class="bu">zip</span>((<span class="st">&#39;ExterQual&#39;</span>, <span class="st">&#39;ExterCond&#39;</span>, <span class="st">&#39;BsmtQual&#39;</span>, <span class="st">&#39;BsmtCond&#39;</span>, <span class="st">&#39;HeatingQC&#39;</span>, <span class="st">&#39;KitchenQual&#39;</span>, <span class="st">&#39;FireplaceQu&#39;</span>, <span class="st">&#39;GarageQual&#39;</span>, <span class="st">&#39;GarageCond&#39;</span>, <span class="st">&#39;PoolQC&#39;</span>),</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>                                     repeat((<span class="st">&#39;Ex&#39;</span>, <span class="st">&#39;Gd&#39;</span>, <span class="st">&#39;Ta&#39;</span>, <span class="st">&#39;Fa&#39;</span>, <span class="st">&#39;Po&#39;</span>))),</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>                                 <span class="bu">zip</span>((<span class="st">&#39;BsmtExposure&#39;</span>,),</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>                                     repeat((<span class="st">&#39;Gd&#39;</span>, <span class="st">&#39;Av&#39;</span>, <span class="st">&#39;Mn&#39;</span>, <span class="st">&#39;No&#39;</span>))),</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>                                 <span class="bu">zip</span>((<span class="st">&#39;BsmtFinType1&#39;</span>, <span class="st">&#39;BsmtFinType2&#39;</span>),</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>                                     repeat((<span class="st">&#39;GLQ&#39;</span>, <span class="st">&#39;ALQ&#39;</span>, <span class="st">&#39;BLQ&#39;</span>, <span class="st">&#39;Rec&#39;</span>, <span class="st">&#39;LwQ&#39;</span>, <span class="st">&#39;Unf&#39;</span>))),</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>                                 <span class="bu">zip</span>((<span class="st">&#39;Functional&#39;</span>,),</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>                                     repeat((<span class="st">&#39;Typ&#39;</span>, <span class="st">&#39;Min1&#39;</span>, <span class="st">&#39;Min2&#39;</span>, <span class="st">&#39;Mod&#39;</span>, <span class="st">&#39;Maj1&#39;</span>, <span class="st">&#39;Maj2&#39;</span>, <span class="st">&#39;Sev&#39;</span>, <span class="st">&#39;Sal&#39;</span>))),</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>                                 <span class="bu">zip</span>((<span class="st">&#39;GarageFinish&#39;</span>,),</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>                                     repeat((<span class="st">&#39;Fin&#39;</span>, <span class="st">&#39;RFn&#39;</span>, <span class="st">&#39;Unf&#39;</span>))),</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>                                 <span class="bu">zip</span>((<span class="st">&#39;Fence&#39;</span>,),</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>                                     repeat((<span class="st">&#39;GdPrv&#39;</span>, <span class="st">&#39;MnPrv&#39;</span>, <span class="st">&#39;GdWo&#39;</span>, <span class="st">&#39;MnWw&#39;</span>)))):</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        data_frame[feature] <span class="op">=</span> data_frame[feature].<span class="bu">map</span>(<span class="bu">dict</span>(<span class="bu">zip</span>(names, count(<span class="bu">len</span>(names) <span class="op">-</span> <span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)))).fillna(<span class="op">-</span><span class="dv">1</span>).astype(<span class="st">&#39;int&#39;</span>)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 特徴量エンジニアリングで、特徴量を追加します。</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(data_frame):</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;TotalSF&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;TotalBsmtSF&#39;</span>] <span class="op">+</span> data_frame[<span class="st">&#39;1stFlrSF&#39;</span>] <span class="op">+</span> data_frame[<span class="st">&#39;2ndFlrSF&#39;</span>]  <span class="co"># 3階建てはない？</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;SFPerRoom&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;TotalSF&#39;</span>] <span class="op">/</span> data_frame[<span class="st">&#39;TotRmsAbvGrd&#39;</span>]</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練用のDataFrameを読み込みます。</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_train_data_frame():</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> add_features(convert_to_number(pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, <span class="st">&#39;house-prices-advanced-regression-techniques&#39;</span>, <span class="st">&#39;train.csv&#39;</span>))))</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="co"># テスト用のDataFrameを読み込みます。</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_test_data_frame():</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> add_features(convert_to_number(pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, <span class="st">&#39;house-prices-advanced-regression-techniques&#39;</span>, <span class="st">&#39;test.csv&#39;</span>))))</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリーの特長量を変換します。</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_categorical_features(data_frame):</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">map</span>(<span class="kw">lambda</span> feature: (feature, <span class="bu">dict</span>(<span class="bu">zip</span>(data_frame[feature].factorize()[<span class="dv">1</span>], count()))),</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">&#39;MSZoning&#39;</span>,</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;Street&#39;</span>,</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;Alley&#39;</span>,</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;LotShape&#39;</span>,</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;LandContour&#39;</span>,</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;LotConfig&#39;</span>,</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;Neighborhood&#39;</span>,</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;Condition1&#39;</span>,</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;Condition2&#39;</span>,</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;BldgType&#39;</span>,</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;HouseStyle&#39;</span>,</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;RoofStyle&#39;</span>,</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;RoofMatl&#39;</span>,</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;Exterior1st&#39;</span>,</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;Exterior2nd&#39;</span>,</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;MasVnrType&#39;</span>,</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;Foundation&#39;</span>,</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;Heating&#39;</span>,</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;CentralAir&#39;</span>,</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;Electrical&#39;</span>,</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;GarageType&#39;</span>,</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;PavedDrive&#39;</span>,</span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;MiscFeature&#39;</span>,</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;SaleType&#39;</span>,</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;SaleCondition&#39;</span>)))</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a><span class="co"># 入力データを読み込みます。</span></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xs(data_frame, categorical_features):</span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, mapping <span class="kw">in</span> categorical_features.items():</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>        data_frame[feature] <span class="op">=</span> data_frame[feature].<span class="bu">map</span>(mapping).fillna(<span class="op">-</span><span class="dv">1</span>).astype(<span class="st">&#39;category&#39;</span>)</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[[<span class="st">&#39;MSSubClass&#39;</span>,</span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;MSZoning&#39;</span>,</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;LotFrontage&#39;</span>,</span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;LotArea&#39;</span>,</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Street&#39;</span>,</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Alley&#39;</span>,</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;LotShape&#39;</span>,</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;LandContour&#39;</span>,</span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Utilities&#39;</span>,</span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;LotConfig&#39;</span>,</span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;LandSlope&#39;</span>,</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Neighborhood&#39;</span>,</span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Condition1&#39;</span>,</span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Condition2&#39;</span>,</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BldgType&#39;</span>,</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;HouseStyle&#39;</span>,</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;OverallQual&#39;</span>,</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;OverallCond&#39;</span>,</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;YearBuilt&#39;</span>,</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;YearRemodAdd&#39;</span>,</span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;RoofStyle&#39;</span>,</span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;RoofMatl&#39;</span>,</span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Exterior1st&#39;</span>,</span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Exterior2nd&#39;</span>,</span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;MasVnrType&#39;</span>,</span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;MasVnrArea&#39;</span>,</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;ExterQual&#39;</span>,</span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;ExterCond&#39;</span>,</span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Foundation&#39;</span>,</span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BsmtQual&#39;</span>,</span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BsmtCond&#39;</span>,</span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BsmtExposure&#39;</span>,</span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BsmtFinType1&#39;</span>,</span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BsmtFinSF1&#39;</span>,</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BsmtFinType2&#39;</span>,</span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BsmtFinSF2&#39;</span>,</span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BsmtUnfSF&#39;</span>,</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;TotalBsmtSF&#39;</span>,</span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Heating&#39;</span>,</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;HeatingQC&#39;</span>,</span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;CentralAir&#39;</span>,</span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Electrical&#39;</span>,</span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;1stFlrSF&#39;</span>,</span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;2ndFlrSF&#39;</span>,</span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;LowQualFinSF&#39;</span>,</span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;GrLivArea&#39;</span>,</span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BsmtFullBath&#39;</span>,</span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BsmtHalfBath&#39;</span>,</span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;FullBath&#39;</span>,</span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;HalfBath&#39;</span>,</span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;BedroomAbvGr&#39;</span>,</span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;KitchenAbvGr&#39;</span>,</span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;KitchenQual&#39;</span>,</span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;TotRmsAbvGrd&#39;</span>,</span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Functional&#39;</span>,</span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Fireplaces&#39;</span>,</span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;FireplaceQu&#39;</span>,</span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;GarageType&#39;</span>,</span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;GarageYrBlt&#39;</span>,</span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;GarageFinish&#39;</span>,</span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;GarageCars&#39;</span>,</span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;GarageArea&#39;</span>,</span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;GarageQual&#39;</span>,</span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;GarageCond&#39;</span>,</span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;PavedDrive&#39;</span>,</span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;WoodDeckSF&#39;</span>,</span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;OpenPorchSF&#39;</span>,</span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;EnclosedPorch&#39;</span>,</span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;3SsnPorch&#39;</span>,</span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;ScreenPorch&#39;</span>,</span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;PoolArea&#39;</span>,</span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;PoolQC&#39;</span>,</span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Fence&#39;</span>,</span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;MiscFeature&#39;</span>,</span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;MiscVal&#39;</span>,</span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;MoSold&#39;</span>,</span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;YrSold&#39;</span>,</span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;SaleType&#39;</span>,</span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;SaleCondition&#39;</span>,</span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;TotalSF&#39;</span>,</span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;SFPerRoom&#39;</span>]]</span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a><span class="co"># 正解データを読み込みます。</span></span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ys(data_frame):</span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[<span class="st">&#39;SalePrice&#39;</span>]</span></code></pre></div>
<p>House
Pricesは特徴量の数が多くて大変でした……。なんで初心者向けのGetting
Startedにこんなに特徴量が多い問題があるのかというと、統計的な数値演算で予測する場合向けに、予測に役立つ特徴量を取捨選択する手法を学ぶためだと思うんですよ。でも、我々は勾配ブースティングで決定木なので、取捨選択は機械学習が勝手にやってくれます。というわけで、全部の特徴量を使用してやりました。</p>
<p>で、日本人ならば5段階評価にするところを、なんでか欧米人は文字で表現する場合があるんですよね……。たとえば、Excellent、Good、Average、Typical、Fair、Poorとか。これを数値に変換する<code>convert_to_number</code>関数を作成しました。funcyを使うと関数型プログラミングできるので、こんな場合の処理が楽ちんです（関数型プログラミングに慣れていないと読みづらいかもしれませんけど……）。で、データを見たところ最低点未満の場合にNaNになっているみたいだったので、NaNを最低値の-1で埋める処理もしています。</p>
<p>あと、上のコードでは特長量エンジニアリングの結果の<code>TotalSF</code>（総床面積）と<code>SFPerRoom</code>（部屋単位の床面積）が追加されていますけど、これは作成後に特徴量エンジニアリングして精度を検証してを繰り返した際に作成したもので、このコードを最初に作成したときにはもちろんなかったことに注意してください。</p>
<p>他は、特に工夫なしです。Titanicの時のコードを切り貼りして作成しました。</p>
<h2 id="モデルを保存して読み込む">モデルを保存して読み込む</h2>
<p>今回はローカルで作業していますので、作業中に出来た成果物をストレージに保存したり読み込んだりできます。そこで、モデルの保存と読み込み用のモジュール（model.py）も作成しました。</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># LightGBMのパラメーターを保存します。</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_params(params):</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path.join(<span class="st">&#39;house-prices-model&#39;</span>, <span class="st">&#39;params.pickle&#39;</span>), mode<span class="op">=</span><span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        pickle.dump(params, f)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co"># LightGBMのパラメーターを読み込みます。</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_params():</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path.join(<span class="st">&#39;house-prices-model&#39;</span>, <span class="st">&#39;params.pickle&#39;</span>), mode<span class="op">=</span><span class="st">&#39;rb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pickle.load(f)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを保存します。</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_model(model):</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, booster <span class="kw">in</span> <span class="bu">enumerate</span>(model.boosters):  <span class="co"># 交差検証なので、複数のモデルが生成されます。</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        booster.save_model(path.join(<span class="st">&#39;house-prices-model&#39;</span>, <span class="ss">f&#39;model-</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">.txt&#39;</span>))</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを読み込みます。</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_model():</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> lgb.CVBooster()</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> <span class="bu">sorted</span>(glob(path.join(<span class="st">&#39;house-prices-model&#39;</span>, <span class="st">&#39;model-*.txt&#39;</span>))):  <span class="co"># 交差検証なので、複数のモデルが生成されます。</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>        result.boosters.append(lgb.Booster(model_file<span class="op">=</span><span class="bu">file</span>))</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリーの特徴量を保存します。</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_categorical_features(categorical_features):</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path.join(<span class="st">&#39;house-prices-model&#39;</span>, <span class="st">&#39;categorical-features.pickle&#39;</span>), mode<span class="op">=</span><span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>        pickle.dump(categorical_features, f)</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリーの特徴量を読み込みます。</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_categorical_features():</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path.join(<span class="st">&#39;house-prices-model&#39;</span>, <span class="st">&#39;categorical-features.pickle&#39;</span>), mode<span class="op">=</span><span class="st">&#39;rb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pickle.load(f)</span></code></pre></div>
<p>Titanicの時との違いは、LightGBMのパラメーターもストレージに保存するようにしたことです。ターミナルからコピーしてコードにペーストするのは面倒でしたもんね。</p>
<p>あとはTitanicの時と同じ。切り貼りと置換で速攻作成しました。</p>
<h2
id="ハイパーパラメーターチューニング">ハイパー・パラメーター・チューニング</h2>
<p>今回は、特徴量エンジニアリングする前にハイパー・パラメーター・チューニングをしました（データセットのモジュールが正しいかを確認するために、最初に一度手作りのハイパー・パラメーターで精度の確認をしたけど）。</p>
<p>私は特徴量エンジニアリングを直観だけでやっていて、その際に役立つのがLightGBMが出力してれる重要な特徴量で、それはハイパー・パラメーターの値によって結構変わってくるんですよ。だから特徴量エンジニアリングの前にハイパー・パラメーター・チューニングで、例によってOptunaに丸投げで楽しています。</p>
<p>というわけで、ハイパー・パラメーター・チューニングするモジュール（tune.py）はこんな感じ。</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> optuna.integration.lightgbm <span class="im">as</span> lgb</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_train_data_frame, get_categorical_features, get_xs, get_ys</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> model <span class="im">import</span> save_params</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_train_data_frame()</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> get_categorical_features(data_frame)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="co"># LightGBMのパラメーターを作成します。</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> {</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;objective&#39;</span>: <span class="st">&#39;regression&#39;</span>,</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;metric&#39;</span>: <span class="st">&#39;l2&#39;</span>  <span class="co"># Optunaでエラーが出たので、regressionの場合のデフォルトのmetricを設定しました。</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ハイパー・パラメーター・チューニングをします。</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> lgb.LightGBMTunerCV(params, lgb.Dataset(xs, label<span class="op">=</span>ys), return_cvbooster<span class="op">=</span><span class="va">True</span>, optuna_seed<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>cv_result <span class="op">=</span> tuner.run()</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tuner.get_best_booster()</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 重要な特徴量を出力します。</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame({<span class="st">&#39;feature&#39;</span>: model.boosters[<span class="dv">0</span>].feature_name(), <span class="st">&#39;importance&#39;</span>: np.mean(model.feature_importance(), axis<span class="op">=</span><span class="dv">0</span>)}).sort_values(<span class="st">&#39;importance&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>).head(n<span class="op">=</span><span class="dv">20</span>))</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a><span class="co"># LightGBMのパラメーターを保存します。</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>save_params(tuner.best_params)</span></code></pre></div>
<p>今回は回帰なので、<code>objective</code>に<code>regression</code>を指定しています。LightGBMで機械学習するだけならこれだけでも大丈夫なのですけど、Optunaでエラーが出たので<code>metric</code>に<code>regression</code>の場合のデフォルト値である<code>l2</code>を指定しました。</p>
<h2
id="特徴量エンジニアリングして精度を確認する">特徴量エンジニアリングして、精度を確認する</h2>
<p>特徴量エンジニアリングは、特徴量を追加して精度を確認するという作業を繰り返さなければなりませんので、精度を確認するためのモジュール（train.py）も作成します。</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plot</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_train_data_frame, get_categorical_features, get_xs, get_ys</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> model <span class="im">import</span> load_params</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_train_data_frame()</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> get_categorical_features(data_frame)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データセットを取得します。</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>train_xs <span class="op">=</span> xs[<span class="dv">400</span>:]</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>train_ys <span class="op">=</span> ys[<span class="dv">400</span>:]</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証データセットを取得します。</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>valid_xs <span class="op">=</span> xs[:<span class="dv">400</span>]</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>valid_ys <span class="op">=</span> ys[:<span class="dv">400</span>]</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="co"># LightGBMのパラメーターを取得します。</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> load_params()</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 機械学習します。</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>cv_result <span class="op">=</span> lgb.cv(params, lgb.Dataset(train_xs, label<span class="op">=</span>train_ys), return_cvbooster<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> cv_result[<span class="st">&#39;cvbooster&#39;</span>]</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 重要な特徴量を出力します。</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame({<span class="st">&#39;feature&#39;</span>: model.boosters[<span class="dv">0</span>].feature_name(), <span class="st">&#39;importance&#39;</span>: np.mean(model.feature_importance(), axis<span class="op">=</span><span class="dv">0</span>)}).sort_values(<span class="st">&#39;importance&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>).head(n<span class="op">=</span><span class="dv">20</span>))</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a><span class="co"># スコアを出力します。</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Score = </span><span class="sc">{</span>np<span class="sc">.</span>sqrt(mean_squared_error(np.log(valid_ys), np.log(np.mean(model.predict(valid_xs), axis<span class="op">=</span><span class="dv">0</span>))))<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 学習曲線を出力します。</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>plot.plot(cv_result[<span class="st">&#39;l2-mean&#39;</span>])</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>plot.show()</span></code></pre></div>
<p>特徴量エンジニアリングでデータセットのモジュールを修正したら、このモジュールを実行して成果を確認するわけですね。で、ずっと特徴量エンジニアリングしていると疲れちゃうので、そんな時にはハイパー・パラメーター・チューニングのモジュールを実行してOptunaが新しいハイパー・パラメーターを作成してくれるまで休憩する感じで作業しました。</p>
<h2 id="予測モデルを作成する-1">予測モデルを作成する</h2>
<p>特徴量エンジニアリングが完了したら、予測モデルを作成します（create_model.py）。</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plot</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_train_data_frame, get_categorical_features, get_xs, get_ys</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> model <span class="im">import</span> load_params, save_model, save_categorical_features</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_train_data_frame()</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> get_categorical_features(data_frame)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co"># LightGBMのパラメーターを取得します。</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> load_params() <span class="op">|</span> {<span class="st">&#39;learning_rate&#39;</span>: <span class="fl">0.01</span>}</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 機械学習します。</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>cv_result <span class="op">=</span> lgb.cv(params, lgb.Dataset(xs, label<span class="op">=</span>ys), return_cvbooster<span class="op">=</span><span class="va">True</span>, num_boost_round<span class="op">=</span><span class="dv">2000</span>)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> cv_result[<span class="st">&#39;cvbooster&#39;</span>]</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 重要な特徴量を出力します。</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame({<span class="st">&#39;feature&#39;</span>: model.boosters[<span class="dv">0</span>].feature_name(), <span class="st">&#39;importance&#39;</span>: np.mean(model.feature_importance(), axis<span class="op">=</span><span class="dv">0</span>)}).sort_values(<span class="st">&#39;importance&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>).head(n<span class="op">=</span><span class="dv">20</span>))</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 学習曲線を出力します。</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>plot.plot(cv_result[<span class="st">&#39;l2-mean&#39;</span>])</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>plot.show()</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを保存します。</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>save_model(model)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>save_categorical_features(categorical_features)</span></code></pre></div>
<p>今回はモジュール化をしましたので、Titanicの時と比べてコードは単純です。説明する場所がなくて困っちゃう。</p>
<h2 id="解答を作成する-1">解答を作成する</h2>
<p>保存したモデルを使用して、解答を作成します（create_submission.py）。</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_test_data_frame, get_xs</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> model <span class="im">import</span> load_categorical_features, load_model</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを読み込みます。</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> load_model()</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> load_categorical_features()</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_test_data_frame()</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 提出量のCSVを作成します。</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>submission <span class="op">=</span> pd.DataFrame({<span class="st">&#39;Id&#39;</span>: data_frame[<span class="st">&#39;Id&#39;</span>], <span class="st">&#39;SalePrice&#39;</span>: np.mean(model.predict(xs), axis<span class="op">=</span><span class="dv">0</span>)})</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>submission.to_csv(<span class="st">&#39;submission.csv&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<p>これですべての作業が完了しましたから、Kaggleに提出してみましょう。スコアは、0.12238で329位でした。</p>
<p><img src="./image/score-histgram-house-prices.png"
alt="House Pricesのスコアのヒストグラム" /></p>
<p>うん、そこそこ上位ですね（House
Pricesのスコアは誤差ですから、小さいほど良い値です）。特徴量の分布とかを丁寧に調べている統計屋さんを、勾配ブースティングのパワーだけで蹴散らしちゃった感じ。プログラミング能力だけでここまで来れるなんて本当に良い時代です。もっと上を目指すならデータ分析が必要なのでしょうけど、このくらい予測できればビジネスでは十分役に立つんじゃないかな。</p>
<p>ほら、ビジネスに機械学習を活用してみたくなってきたでしょ？　実案件でLightGBMするときには、このHouse
Prisesのコードを出発点にすればそこそこ楽ちんにプログラミングできると思いますよ。</p>
<p>うん、LightGBMで勾配ブースティングは、簡単で精度が高くて最高ですな！</p>
<h1 id="tensorflowで深層学習">TensorFlowで深層学習</h1>
<p>LightGBMで勾配ブースティングが終わりましたので、お待ちかねの深層学習です。</p>
<p>でね、深層学習と言われて思い浮かべるだろう以下の図のモデルは全結合（dense）と呼ばれる層を重ねたもので、実は、そんなに精度が高くありません。</p>
<p><img src="./image/multilayer-perceptron.png"
alt="Multilayer Perceptron" /></p>
<p>というわけで、まずは、このあまり精度が高くなかった全結合から始まった、深層学習の歴史を。</p>
<h2 id="畳み込みで本領を発揮して">畳み込みで本領を発揮して</h2>
<p>深層学習の精度が大きく向上したのは、畳み込み（convolution）という手法が発明されてからです。で、この畳み込みってのは、画像処理でいうところのフィルタリングそのものなんですよ。</p>
<p>画像においては、あるピクセルだけじゃなくて、そのピクセルの上下左右やそのさらに外側のピクセルとの関係が重要ですよね？　白い中に黒いピクセルが縦に並んでるから縦線と認識できるわけで。このような周りとの関係を汎用的な手法で抽出するのがフィルタリングです。</p>
<p>フィルタリング処理の具定例を示しましょう。こんな感じ。</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plot</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="bu">filter</span>(image, kernel):</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> np.zeros((np.shape(image)[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">2</span>, np.shape(image)[<span class="dv">1</span>] <span class="op">-</span> <span class="dv">2</span>))</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(np.shape(result)[<span class="dv">0</span>]):</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(np.shape(result)[<span class="dv">1</span>]):</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 画像の該当部分とカーネルのベクトルの内積を求めて新たな画像を作成します。</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>            result[y, x] <span class="op">=</span> np.inner(image[y: y <span class="op">+</span> <span class="dv">3</span>, x: x <span class="op">+</span> <span class="dv">3</span>].flatten(), kernel.flatten())</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    result[result <span class="op">&lt;</span>   <span class="dv">0</span>] <span class="op">=</span>   <span class="dv">0</span>  <span class="co"># noqa: E222</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    result[result <span class="op">&gt;</span> <span class="dv">255</span>] <span class="op">=</span> <span class="dv">255</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> cv2.imread(<span class="st">&#39;4.2.07.tiff&#39;</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>plot.imshow(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>plot.show()</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>plot.imshow(<span class="bu">filter</span>(cv2.cvtColor(image, cv2.COLOR_RGB2GRAY), np.array([[<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">0</span>], [<span class="dv">2</span>, <span class="op">-</span><span class="dv">8</span>, <span class="dv">2</span>], [<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">0</span>]])))</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>plot.show()</span></code></pre></div>
<p>ある点の周囲の画像と行列（コード中の<code>kernel</code>）をベクトルに変換（<code>flatten()</code>）して内積（<code>np.inner()</code>）して、新たな画像を作るわけですね。たったこれだけで、画像から輪郭を抽出することができます。</p>
<p><img src="./image/4.2.07.png" alt="元画像" /></p>
<p><img src="./image/filtering.png" alt="フィルタリングの結果" /></p>
<p>で、本稿は文系のための文書ですから、ベクトルの内積について補足しましょう。数式は嫌なので、図でやります。題材は転職で。転職先を、給料と仕事の楽しさで表現します。</p>
<p>で、あれもこれも全部欲しいというのは贅沢すぎるので、転職先の評価軸は、距離が1のベクトルで表現するとしましょう。下の図の、左下から円周上のどこかに向かうベクトルが、転職先の評価軸となるわけですね。</p>
<p><img src="./image/offers.png"
alt="転職先を給料と仕事の楽しさでプロット" /></p>
<p>で、「高い給料をもらえるなら非合法な仕事でもオッケー」とか「仕事が楽しければ霞を食べて生きていける」という特殊な場合はそれぞれX軸とY軸の値を見るだけでその軸と垂直なもう片方の軸の値を無視できるのですけど、普通は、給料2割で仕事の楽しさ8割とかで評価したいですよね？　そんな時は、ベクトルの内積が役に立ちます。</p>
<p><img src="./image/evaluate_offers_with_inner_product.png"
alt="転職先を評価ベクトルと内積で評価" /></p>
<p>上の図のように、ベクトルの内積というのは、あるベクトルの視点で、他のベクトルがどの程度の量になるのかを表現しす。赤色で描かれた給料2割で仕事の楽しさ8割のベクトル上での、各転職先の大きさはどのくらいなのかがこれで一目瞭然で、転職がはかどっちゃうこと請け合い。しかも、ベクトルの内積ってのは2次元の画像だけじゃなくて、3次元でも4次元でも、1,024次元とかでも成り立つんですよ。だから、先ほどのコードでの<code>kernel</code>のような、9次元のベクトルでも使えるんです。</p>
<p>でね、先ほどのプログラムの<code>kernel</code>の値は、輪郭の場合に大きな値になるような行列になっていたんですよ。輪郭抽出なんて機械学習に関係なさそうと思ったかもしれませんけど、もし、こんな感じに丸くなっているとか、こんな感じに尖っているとか、こんな感じに交差しているとかを表現するベクトルを作るなら、しかもそれが大量にあるならば、たとえば文字認識とかを高い精度でできると思いませんか？</p>
<p>深層学習は機械学習なので、どのような<code>kernel</code>を使うと文字認識に有効なのかとか、犬と猫を区別するにはどのような<code>kernel</code>があればよいのかとかは、コンピューターが調整してくれます。とても楽ちんで、しかも精度が高い！</p>
<p>と、これが畳み込みで、この畳み込みのおかげで深層学習での画像認識の精度は大幅に向上したんです。</p>
<h2 id="今はアテンション">今は、アテンション</h2>
<p>でもね、畳み込みって隣り合うものとの関係しか抽出できないので、自然言語のような遠くのものとの関係がある場合には使いづらかったんですよ。そんな場合にも対応できるように編み出されたのがアテンションです。</p>
<p>たとえば、前の文章の「そんな場合」は遠くに位置する「自然言語のような遠くのものとの関係がある場合」で、ほら、自然言語処理では遠くにあるものと関係があるでしょ？</p>
<p>自然言語処理では、単語をベクトルで表現します。「私」＝[0.1, 0.0, 0.4,
0.5,
0.0]みたいな感じ。で、単語のベクトルを要素に持つ行列と単語のベクトルの内積をとる（内積attentionの場合。他に加法attentionってのもありますけど私は使ったことない）と各単語の重みが出てきて、で、その重みに合わせて単語ベクトルと内積をとって、単語と単語の関係を考慮した行列を作成します。で、これだけだとただの行列計算なので、機械学習できるよう、重みパラメータを追加したのがアテンションです。</p>
<p>あとは、深層学習ってのは本来固定長の入力しか受け付けられないのだけど、それを数式上の工夫で可変長にして、翻訳で精度を大幅に向上させたのがTransformerという深層学習のモデルです。</p>
<h2
id="使用するライブラリはtensorflow">使用するライブラリは、TensorFlow</h2>
<p>大雑把な歴史の話が終わりましたので、使用するライブラリを選んでいきましょう。玄人はLuaでTorchかPythonでPyTorchを使うみたいで、深層学習の論文ではこれらの環境が良く使われているみたいです。が、素人の私は敢えてGoogle社のTensorFlowを推薦します。</p>
<p>論文の追試をするとか新しい論文を書くとかなら他の論文と同じ環境が良いのでしょうけど、実際の案件で使用する場合は、やっぱり寄らば大樹の影ですよ。TensorFlowは、様々なプログラミング言語から利用できたり、スマートフォンやIoTデバイスで実行できたりと、周辺機能の充実具合が段違いで優れているので将来のビジネス展開もバッチリですぜ。</p>
<h2 id="tensorflowでtransformer">TensorFlowでTransformer</h2>
<p>では、いきなりで申し訳ないのですけど、流行りのTransformerをTensorFlowで作ります。</p>
<p>いきなりそんな無茶なと感じた貴方は、<a
href="https://www.tensorflow.org/tutorials/text/transformer?hl=ja">言語理解のためのTransformerモデル</a>を開いてみてください。これ、TensorFlowのチュートリアルの一部なんですけど、ここに懇切丁寧にTransformerの作り方が書いてあります。</p>
<p>チュートリアルというのは、コンピューター業界では手を動かして実際にプログラムを作ることや、入門編という意味で使用されます。TensorFlowのチュートリアルはたぶん両方の意味で、入門レベルの人にも分かる記述で、実際に手を動かしてプログラムを作っている間に嫌でも理解できちゃうという内容になっています。いきなりTransformerは難しそうという場合は、<a
href="https://www.tensorflow.org/tutorials/keras/classification?hl=ja">はじめてのニューラルネットワーク：分類問題の初歩</a>から順を追ってやっていけばオッケーです。</p>
<p>ただね、TensorFlowを作っているような人ってのはとても頭が良い人で、で、頭が良い人ってのはたいていプログラミングが下手なんですよね……。彼らは頭が良いので、複雑なものを複雑なままで理解できます。で、理解した複雑な内容をそのまま複雑なプログラムとして実装しちゃう。ビジネス・アプリケーションのプログラマーが考えているようなリーダビリティへの考慮とかはゼロの、複雑怪奇な糞コードを書きやがるんですよ。</p>
<p>だから、TensorFlowのチュートリアルをやったあとは、できあがったコードをリファクタリングしましょう。私がリファクタリングした結果は、こんな感じなりました。</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> func_partial, rcompose</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transformer(num_blocks, d_model, num_heads, d_ff, x_vocab_size, y_vocab_size, x_maximum_position, y_maximum_position, dropout_rate):</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># KerasやTensorflowのレイヤーや関数をラップします。</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dense(units):</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Dense(units)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dropout(rate):</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Dropout(rate)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embedding(input_dim, output_dim):</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Embedding(input_dim, output_dim)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> layer_normalization():</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.LayerNormalization(epsilon<span class="op">=</span><span class="fl">1e-6</span>)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> relu():</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.ReLU()</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reshape(target_shape):</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Reshape(target_shape)</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transpose(perm):</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func_partial(tf.transpose, perm<span class="op">=</span>perm)</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transformerに必要な演算を定義します。</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> scaled_dot_product_attention(x):</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>        query, key, value, mask <span class="op">=</span> x</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.matmul(tf.nn.softmax(tf.matmul(query, key, transpose_b<span class="op">=</span><span class="va">True</span>) <span class="op">/</span> tf.math.sqrt(tf.cast(tf.shape(key)[<span class="op">-</span><span class="dv">1</span>], tf.float32)) <span class="op">+</span> mask <span class="op">*</span> <span class="op">-</span><span class="fl">1e9</span>, axis<span class="op">=-</span><span class="dv">1</span>), value)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> multi_head_attention(d_model, num_heads):</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>        split  <span class="op">=</span> rcompose(reshape((<span class="op">-</span><span class="dv">1</span>, num_heads, d_model <span class="op">//</span> num_heads)),  <span class="co"># noqa: E221</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>                          transpose((<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>)))</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>        concat <span class="op">=</span> rcompose(transpose((<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>)),</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>                          reshape((<span class="op">-</span><span class="dv">1</span>, d_model)))</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>            q, k, v, mask <span class="op">=</span> inputs</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> scaled_dot_product_attention((split(dense(d_model)(q)),</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>                                              split(dense(d_model)(k)),</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>                                              split(dense(d_model)(v)),</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>                                              mask))</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> concat(o)</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> dense(d_model)(o)</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> point_wise_feed_forward(d_model, d_ff):</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> rcompose(dense(d_ff),</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>                        relu(),</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>                        dense(d_model))</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> encoder_block(d_model, num_heads, d_ff, dropout_rate):</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>            x, mask <span class="op">=</span> inputs</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> layer_normalization()(dropout(dropout_rate)(multi_head_attention(d_model, num_heads)((x, x, x, mask))) <span class="op">+</span> x)</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> layer_normalization()(dropout(dropout_rate)(point_wise_feed_forward(d_model, d_ff)(o)) <span class="op">+</span> o)</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> decoder_block(d_model, num_heads, d_ff, dropout_rate):</span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>            y, y_mask, z, z_mask <span class="op">=</span> inputs</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> layer_normalization()(dropout(dropout_rate)(multi_head_attention(d_model, num_heads)((y, y, y, y_mask))) <span class="op">+</span> y)</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> layer_normalization()(dropout(dropout_rate)(multi_head_attention(d_model, num_heads)((o, z, z, z_mask))) <span class="op">+</span> o)</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> layer_normalization()(dropout(dropout_rate)(point_wise_feed_forward(d_model, d_ff)(o)) <span class="op">+</span> o)</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_positional_encoding(maximum_position, d_model):</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> np.empty((maximum_position, d_model), dtype<span class="op">=</span>np.float32)</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a>        angles <span class="op">=</span> np.arange(maximum_position)[:, np.newaxis] <span class="op">/</span> np.power(<span class="dv">10000</span>, <span class="dv">2</span> <span class="op">*</span> np.arange(d_model <span class="op">//</span> <span class="dv">2</span>) <span class="op">/</span> d_model)</span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>        result[:, <span class="dv">0</span>::<span class="dv">2</span>] <span class="op">=</span> np.sin(angles)  <span class="co"># 偶数はsin</span></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>        result[:, <span class="dv">1</span>::<span class="dv">2</span>] <span class="op">=</span> np.cos(angles)  <span class="co"># 奇数はcos</span></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> tf.cast(result[np.newaxis, ...], dtype<span class="op">=</span>tf.float32)</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> encoder(num_blocks, d_model, num_heads, d_ff, vocab_size, maximum_position, dropout_rate):</span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a>        normalize_factor <span class="op">=</span> tf.math.sqrt(tf.cast(d_model, tf.float32))</span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a>        positional_encoding <span class="op">=</span> get_positional_encoding(maximum_position, d_model)</span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>            x, mask <span class="op">=</span> inputs</span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> dropout(dropout_rate)(embedding(vocab_size, d_model)(x) <span class="op">*</span> normalize_factor <span class="op">+</span> positional_encoding[:, :tf.shape(x)[<span class="dv">1</span>], :])</span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_blocks):</span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>                o <span class="op">=</span> encoder_block(d_model, num_heads, d_ff, dropout_rate)((o, mask))</span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> decoder(num_blocks, d_model, num_heads, d_ff, vocab_size, maximum_position, dropout_rate):</span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>        normalize_factor <span class="op">=</span> tf.math.sqrt(tf.cast(d_model, tf.float32))</span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a>        positional_encoding <span class="op">=</span> get_positional_encoding(maximum_position, d_model)</span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a>            y, y_mask, z, z_mask <span class="op">=</span> inputs</span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> dropout(dropout_rate)(embedding(vocab_size, d_model)(y) <span class="op">*</span> normalize_factor <span class="op">+</span> positional_encoding[:, :tf.shape(y)[<span class="dv">1</span>], :])</span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_blocks):</span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>                o <span class="op">=</span> decoder_block(d_model, num_heads, d_ff, dropout_rate)((o, y_mask, z, z_mask))</span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_padding_mask(x):</span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.cast(tf.math.equal(x, <span class="dv">0</span>), tf.float32)[:, tf.newaxis, tf.newaxis, :]</span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_look_ahead_mask(size):</span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span> <span class="op">-</span> tf.linalg.band_part(tf.ones((size, size)), <span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> op(inputs):</span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a>        x, y <span class="op">=</span> inputs</span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> encoder(num_blocks, d_model, num_heads, d_ff, x_vocab_size, x_maximum_position, dropout_rate)((x, get_padding_mask(x)))</span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> decoder(num_blocks, d_model, num_heads, d_ff, y_vocab_size, y_maximum_position, dropout_rate)((y, tf.maximum(get_look_ahead_mask(tf.shape(y)[<span class="dv">1</span>]), get_padding_mask(y)), o, get_padding_mask(x)))</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> dense(y_vocab_size)(o)</span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> o</span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> op</span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LearningRateSchedule(tf.keras.optimizers.schedules.LearningRateSchedule):</span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, d_model, warmup_steps<span class="op">=</span><span class="dv">4000</span>):</span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(LearningRateSchedule, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.d_model <span class="op">=</span> tf.cast(d_model, tf.float32)</span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.warmup_steps <span class="op">=</span> warmup_steps</span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, step):</span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.d_model <span class="op">**</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> tf.math.minimum(step <span class="op">**</span> <span class="op">-</span><span class="fl">0.5</span>, step <span class="op">*</span> <span class="va">self</span>.warmup_steps <span class="op">**</span> <span class="op">-</span><span class="fl">1.5</span>)</span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Loss(tf.keras.losses.Loss):</span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Loss, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sparse_categorical_crossentropy <span class="op">=</span> tf.keras.losses.SparseCategoricalCrossentropy(from_logits<span class="op">=</span><span class="va">True</span>, reduction<span class="op">=</span><span class="st">&#39;none&#39;</span>)</span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> call(<span class="va">self</span>, y_true, y_pred):</span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.reduce_mean(<span class="va">self</span>.sparse_categorical_crossentropy(y_true, y_pred) <span class="op">*</span> tf.cast(tf.math.logical_not(tf.math.equal(y_true, <span class="dv">0</span>)), dtype<span class="op">=</span>tf.float32))</span></code></pre></div>
<p>上のコードの解説はTensorFlowのチュートリアルに任せることにして、なぜ誰かのTransformer実装を使わずに自前でTransformerを実装したのかを述べさせてください。</p>
<p>既存のTransformerの実装が存在しないわけじゃありません。GitHubを検索すれば大量に見つかるでしょう。それらを利用すれば、わざわざ実装せずともTransformerできます。でも、できればTensorFlowのチュートリアルを読んで、自前で実装して動かしてみていただきたいです。</p>
<p>その理由は、深層学習がいまだ未成熟な技術だから。新しいモデルが次々に出てきていて、そのモデルを使えば今までできなかったことができるようになって、ビジネスに大いに役立つかもしれません。その新しいモデルの実装があるとは限らないわけで、自前で実装しなければならないかもしれません。その時は、そのひとつ前のモデルの実装経験が役立つでしょう。</p>
<p>あと、深層学習は入力や出力の型が決まっているという問題もあります。画像認識のような場合はこれが結構痛くて、画像の大きさをモデルが要求する大きさに合わせたりしなければなりません。自前で作成するなら、モデルの中身を調整できるのでこんな問題はありません。</p>
<p>というわけで実装したTransformerを使用して機械学習してみましょう。TensorFlowのチュートリアルではポルトガル語から英語への翻訳をやっていますけど、私はポルトガル語も英語も分からないので、足し算と引き算でやってみます。<code>1 + 1</code>をTransformerにかけたら<code>2</code>が出力されるわけですね。</p>
<p>データセットは、以下のようになっています。</p>
<pre class="csv"><code>Id,Expression,Answer
0,934+952,1886
1,68+487,555
2,550+690,1240
3,360+421,781
4,214+844,1058
5,453+728,1181
6,798+178,976
7,199+809,1008
8,182+317,499
9,818+788,1606
10,966+380,1346</code></pre>
<p>このデータセットを読み込むモジュール（dataset.py）はこんな感じ。</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> concat, count, dropwhile, <span class="bu">map</span>, take, takewhile</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用される単語。自然言語処理の処理単位は単語です。今回は面倒なので、文字単位にしました。</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>WORDS <span class="op">=</span> <span class="bu">tuple</span>(concat((<span class="st">&#39; &#39;</span>,), (<span class="st">&#39;+&#39;</span>, <span class="st">&#39;-&#39;</span>), <span class="bu">map</span>(<span class="bu">str</span>, <span class="bu">range</span>(<span class="dv">10</span>)), (<span class="st">&#39;^&#39;</span>, <span class="st">&#39;$&#39;</span>)))</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 単語を整数にエンコード/デコードするためのdictです。</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>ENCODES <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(WORDS, count()))</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>DECODES <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(count(), WORDS))</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="co"># DataFrameを取得します。</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_data_frame(filename):</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, filename), dtype<span class="op">=</span>{<span class="st">&#39;Expression&#39;</span>: <span class="st">&#39;string&#39;</span>, <span class="st">&#39;Answer&#39;</span>: <span class="st">&#39;string&#39;</span>})</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練用のDataFrameを取得します。</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_train_data_frame():</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_data_frame(<span class="st">&#39;train.csv&#39;</span>)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="co"># テスト用のDataFrameを取得します。</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_test_data_frame():</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_data_frame(<span class="st">&#39;test.csv&#39;</span>)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 深層学習するために、文をエンコードして数値の集合に変換します。</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode(sentence, max_sentence_length):</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> take(max_sentence_length <span class="op">+</span> <span class="dv">2</span>, concat((ENCODES[<span class="st">&#39;^&#39;</span>],),  <span class="co"># 文の開始</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>                                                <span class="bu">map</span>(ENCODES, sentence),</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>                                                (ENCODES[<span class="st">&#39;$&#39;</span>],),  <span class="co"># 文の終了</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>                                                (ENCODES[<span class="st">&#39; &#39;</span>],) <span class="op">*</span> max_sentence_length))  <span class="co"># 残りは空白で埋めます。長さを揃えないと、深層学習できないためです。</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 深層学習が出力した数値の集合を、デコードして文字列に変換します。</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> decode(encoded):</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;&#39;</span>.join(takewhile(<span class="kw">lambda</span> c: c <span class="op">!=</span> <span class="st">&#39;$&#39;</span>, dropwhile(<span class="kw">lambda</span> c: c <span class="op">==</span> <span class="st">&#39;^&#39;</span>, <span class="bu">map</span>(DECODES, encoded))))</span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 入力データを取得します。</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xs(data_frame):</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>    strings <span class="op">=</span> data_frame[<span class="st">&#39;Expression&#39;</span>]</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>    max_length <span class="op">=</span> <span class="bu">max</span>(<span class="bu">map</span>(<span class="bu">len</span>, strings))</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(<span class="bu">tuple</span>(<span class="bu">map</span>(<span class="kw">lambda</span> string: <span class="bu">tuple</span>(encode(string, max_length)), strings)), dtype<span class="op">=</span>np.int64)</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a><span class="co"># 正解データを取得します。</span></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ys(data_frame):</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    strings <span class="op">=</span> data_frame[<span class="st">&#39;Answer&#39;</span>]</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>    max_length <span class="op">=</span> <span class="bu">max</span>(<span class="bu">map</span>(<span class="bu">len</span>, strings))</span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(<span class="bu">tuple</span>(<span class="bu">map</span>(<span class="kw">lambda</span> string: <span class="bu">tuple</span>(encode(string, max_length)), strings)), dtype<span class="op">=</span>np.int64)</span></code></pre></div>
<p>自然言語処理では単語単位に一意のIDを割り振る必要があるので、そのためのdictを作成したり文字列をID列にエンコードしたりID列を文字列にデコードしたりする処理を作成しています。</p>
<p>Transformerのハイパー・パラメーターはこんな感じ。</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> WORDS</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>NUM_BLOCKS <span class="op">=</span> <span class="dv">3</span>             <span class="co"># 簡単なタスクなので、Attention is all you needの半分</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>D_MODEL <span class="op">=</span> <span class="dv">256</span>              <span class="co"># 簡単なタスクなので、Attention is all you needの半分</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>D_FF <span class="op">=</span> <span class="dv">1024</span>                <span class="co"># 簡単なタスクなので、Attention is all you needの半分</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>NUM_HEADS <span class="op">=</span> <span class="dv">4</span>              <span class="co"># 簡単なタスクなので、Attention is all you needの半分</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>DROPOUT_RATE <span class="op">=</span> <span class="fl">0.1</span>         <span class="co"># ここはAttention is all you needのまま</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>X_VOCAB_SIZE <span class="op">=</span> <span class="bu">len</span>(WORDS)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>Y_VOCAB_SIZE <span class="op">=</span> <span class="bu">len</span>(WORDS)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>X_MAXIMUM_POSITION <span class="op">=</span> <span class="dv">20</span>    <span class="co"># 余裕を持って多めに</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>Y_MAXIMUM_POSITION <span class="op">=</span> <span class="dv">20</span>    <span class="co"># 余裕を持って多めに</span></span></code></pre></div>
<p>Transformerは<a href="https://arxiv.org/abs/1706.03762">Attention is
all you
need</a>という論文のモデルで、この論文が使用しているハイパー・パラメーターをフィーリングで半分に減らしました。</p>
<p>機械学習する部分のコードは、こんな感じ。</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> decode, get_train_data_frame, get_xs, get_ys</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> identity, juxt</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> starmap</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> operator <span class="im">import</span> eq</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> params <span class="im">import</span> NUM_BLOCKS, D_MODEL, NUM_HEADS, D_FF, X_VOCAB_SIZE, Y_VOCAB_SIZE, X_MAXIMUM_POSITION, Y_MAXIMUM_POSITION, DROPOUT_RATE</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformer <span class="im">import</span> LearningRateSchedule, Loss, transformer</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> translation <span class="im">import</span> translate</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">0</span>)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="co"># データを読み込みます。</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_train_data_frame()</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データセットと検証データセットに分割するためのインデックスを作成します。</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> rng.permutation(np.arange(<span class="bu">len</span>(xs)))</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データセットを取得します。</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>train_xs <span class="op">=</span> xs[indices[<span class="dv">2000</span>:]]</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>train_ys <span class="op">=</span> ys[indices[<span class="dv">2000</span>:]]</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証データセットを取得します。</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>valid_xs <span class="op">=</span> xs[indices[:<span class="dv">2000</span>]]</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>valid_ys <span class="op">=</span> ys[indices[:<span class="dv">2000</span>]]</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Transformerを作成します。</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>op <span class="op">=</span> transformer(NUM_BLOCKS, D_MODEL, NUM_HEADS, D_FF, X_VOCAB_SIZE, Y_VOCAB_SIZE, X_MAXIMUM_POSITION, Y_MAXIMUM_POSITION, DROPOUT_RATE)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Kerasのモデルを作成します。</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.Model(<span class="op">*</span>juxt(identity, op)([tf.keras.Input(shape<span class="op">=</span>(<span class="va">None</span>,)), tf.keras.Input(shape<span class="op">=</span>(<span class="va">None</span>,))]))</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(tf.keras.optimizers.Adam(LearningRateSchedule(D_MODEL), beta_1<span class="op">=</span><span class="fl">0.9</span>, beta_2<span class="op">=</span><span class="fl">0.98</span>, epsilon<span class="op">=</span><span class="fl">1e-9</span>), loss<span class="op">=</span>Loss(), metrics<span class="op">=</span>())</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a><span class="co"># model.summary()</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a><span class="co"># 機械学習して、モデルを保存します。</span></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>model.fit((train_xs, train_ys[:, :<span class="op">-</span><span class="dv">1</span>]), train_ys[:, <span class="dv">1</span>:], batch_size<span class="op">=</span><span class="dv">256</span>, epochs<span class="op">=</span><span class="dv">100</span>, validation_data<span class="op">=</span>((valid_xs, valid_ys[:, :<span class="op">-</span><span class="dv">1</span>]), valid_ys[:, <span class="dv">1</span>:]))</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">&#39;model&#39;</span>, include_optimizer<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 実際に予測させて、精度を確認します。</span></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Accuracy = </span><span class="sc">{</span><span class="bu">sum</span>(starmap(eq, <span class="bu">zip</span>(<span class="bu">map</span>(decode, valid_ys), <span class="bu">map</span>(decode, translate(model, valid_xs))))) <span class="op">/</span> <span class="bu">len</span>(valid_xs)<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
<p>TensorFlowのTransformerのチュートリアルでは、TensorFlowの生APIを使って細かく学習を制御しているのですけど、生APIを使うのは面倒なので簡単便利ライブラリであるKeras（TensorFlowに付属しています）を使用しました。<code>fit()</code>の時にいろいろ情報を出力してくれて面白いですよ。</p>
<p>で、上のコード中で使用している<code>translate()</code>は、後述するテストのモジュールでも使用するので、共用できるようにモジュール化しました。</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> ENCODES</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> params <span class="im">import</span> Y_MAXIMUM_POSITION</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 翻訳します。</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translate(model, xs):</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 仮の翻訳結果を作成し、文の開始記号を設定します。</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    ys <span class="op">=</span> np.zeros((<span class="bu">len</span>(xs), Y_MAXIMUM_POSITION), dtype<span class="op">=</span>np.int64)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    ys[:, <span class="dv">0</span>] <span class="op">=</span> ENCODES[<span class="st">&#39;^&#39;</span>]</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 文の終了記号が出力されたかを表現する変数です。</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    is_ends <span class="op">=</span> np.zeros((<span class="bu">len</span>(xs),), dtype<span class="op">=</span>np.int32)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transformerは、学習時は文の単位なのですけど、翻訳は単語単位でやらなければなりません……。</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, Y_MAXIMUM_POSITION):</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 単語を翻訳します。</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>        ys[:, i] <span class="op">=</span> np.argmax(model.predict((xs, ys[:, :i]), batch_size<span class="op">=</span><span class="dv">256</span>)[:, <span class="op">-</span><span class="dv">1</span>], axis<span class="op">=-</span><span class="dv">1</span>)  <span class="co"># 256並列で、次の単語を予測します。対象以外の単語も予測されますけど、無視します。</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 文の終了記号が出力されたか確認します。</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>        is_ends <span class="op">|=</span> ys[:, i] <span class="op">==</span> ENCODES[<span class="st">&#39;$&#39;</span>]</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># すべての文の翻訳が完了した場合はループをブレークします。</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.<span class="bu">all</span>(is_ends):</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ys</span></code></pre></div>
<p>Transformerは、学習は文の単位でやる（そのために、文の先を参照しないようにマスクを設定している）のですけど、翻訳するときの単位は単語です。元の文＋1単語目までを入力に2単語目を出力するわけですね。実は3つ目の単語を予測する時にも2つめの単語を予測して出力しているのですけど、<code>[:, -1]</code>で捨てています。計算の無駄な気がしますけど、効率よく学習するためなので我慢してください。</p>
<p>最後。テスト・データを翻訳させて、精度を確認します。コードはこんな感じ。</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> decode, get_test_data_frame, get_xs, get_ys</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> translation <span class="im">import</span> translate</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを取得します。</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;model&#39;</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_test_data_frame()</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 正解した数。</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>equal_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 実際に予測させて、正解した数を取得します。</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x, y_true, y_pred <span class="kw">in</span> <span class="bu">zip</span>(xs, ys, translate(model, xs)):</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    y_true_string <span class="op">=</span> decode(y_true)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    y_pred_string <span class="op">=</span> decode(y_pred)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    equal <span class="op">=</span> y_true_string <span class="op">==</span> y_pred_string</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    equal_count <span class="op">+=</span> equal</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&#39;</span><span class="sc">{</span>decode(x)<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="st">&quot;==&quot;</span> <span class="cf">if</span> equal <span class="cf">else</span> <span class="st">&quot;!=&quot;</span><span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>y_pred_string<span class="sc">}</span><span class="ss">&#39;</span>)  <span class="co"># ついでなので、予測結果を出力させます。</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 精度を出力します。</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Accuracy: </span><span class="sc">{</span>equal_count <span class="op">/</span> <span class="bu">len</span>(xs)<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
<p>さて、その精度はどうなったかというと、0.947という高い精度になりました！　大量データを用意すれば、Transformerで翻訳できそうですね。チュートリアルがあるので、作るのはそんなに大変じゃないですし。</p>
<h2 id="深層学習の使いどころ">深層学習の使いどころ</h2>
<p>……でも、ちょっと待って。足し算とか引き算なら、深層学習を使わないで実際に足し算とか引き算するコードを書けば精度が100%になるのでは？</p>
<p>はい。おっしゃる通り。もし入力と出力の関係を定義できて、それをプログラムでシミュレーションできるなら、深層学習を使わないでシミュレーターを実装すれば良いでしょう。シミュレーターを作れるなら、シミュレーターの方が精度が高そうですもんね。</p>
<p>ただ、シミュレーターを作成可能な場合であっても深層学習が役に立つ場合もあるんですよ。それがどんな場合かというと、シミュレーションにやたらと時間がかかる場合。実は深層学習はすべての関数を近似できるらしくて（証明は難しくて理解できなかったけど）、ということは、シミュレーションを近似できちゃうというわけ。</p>
<p>たとえば原子の動きのシミュレーションは、量子力学の基本法則に立脚した第一原理計算というのがあって、それを活用する密度汎関数法（density
functional
theory）という計算でできる（らしい）んです。ただ、これってとにかく計算に時間がかかる（っぽい）んですよ。複雑な原子のシミュレーションはとにかく時間がかかってやってられないので、だからこれを深層学習で近似しちゃおうというのが、Preferred
Networks社とENEOS社の<a
href="https://matlantis.com/ja/">Matlantis</a>で、マテリアル・インフォマティクス分野ではとても役に立つ（みたい）です。</p>
<p>こんな感じで、もし遅くてやってられないシミュレーターがあるなら、深層学習で代替できないかを検討してみるのも良いと思います。</p>
<p>あ、シミュレーターを作れるかもしれないけど作るのが面倒なのでとりあえず深層学習ってのもアリで、私はこっち派だったりします。</p>
<h1 id="vision-transformerで画像のクラス分類">Vision
Transformerで画像のクラス分類</h1>
<p>話を元に戻して、KaggleのGetting Startedの<a
href="https://www.kaggle.com/c/digit-recognizer">Digit
Recognizer</a>で画像のクラス分類をやりましょう。手書き数字の画像認識問題です。</p>
<h2 id="vision-transformer">Vision Transformer？</h2>
<p>Vision
Transformerは、翻訳で大成功したTransformerを元にして作成された、様々な自然言語処理タスクで人間を超えたと話題になったBERTの、画像認識版です。BERTはTransformerを少し修正するだけで作成できるのですけど、Vision
Transformerも同様にTransformerの修正で作成可能です。</p>
<p>TensorFlowのTransformerのチュートリアルをやった皆様はすでにご存じだと思いますけど、Transformerはエンコーダーとデコーダーで構成されています。エンコーダーで文章全体を表現する行列を作成して、その行列をデコーダーで変換して翻訳先の文章を作るわけ。BERTやVision
Transformerはこのエンコーダーだけを使用します。</p>
<p>BERTやVision
Trasformerでは、文章の頭にクラスを表現するベクトルを追加して、で、そのベクトルに相当する部分の出力を使用してクラス分類する（BERTの場合は、ネガ/ポジの感情判定したりする）わけですね。BERTの場合は、入力となった単語のベクトルに相当する部分を使って、文と質問のペアの、質問に相当する文の箇所を推論したりもします。</p>
<p>で、BERTはその学習方法が面白かったりする（簡単にいくらでも作れる問題で事前学習（pre
training）している）のですけど、詳細はBERTと事前学習で検索してみてください。これは説明責任を放棄しているわけではなくて、流行りの技術である深層学習はいろいろな人が解説を書いてくれていて、検索するだけで大量の解説が手に入ることを知って欲しいから。</p>
<p>これはVision
Transformerについても同様で、検索すれば大量の分かりやすい解説が見つかります。解説が間違えている可能性はあるので<a
href="https://arxiv.org/abs/2010.11929">論文</a>の参照は必要ですけど、論文だけで理解するより遥かに楽ちんです。</p>
<p>最新の深層学習のモデルだと論文を読むしかないので深層学習は難しいのですけど、半年から一年遅れくらいでよいなら、大量の解説を利用できるので深層学習はそんなに難しくないですよ。</p>
<h2 id="vision-transformerを実装する">Vision Transformerを実装する</h2>
<p>ありがたいことにVision Transformerの<a
href="https://keras.io/examples/vision/image_classification_with_vision_transformer/">Keras公式実装</a>もあるので、これを参考にすれば簡単に実装できます。今回は、論文から少し離れて、Kerasの実装に合う形（クラスを先頭に追加するのではなく、全結合層でクラス分類する等）で実装しました。</p>
<p>というわけで、コードはこんな感じになりました。</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> func_partial, rcompose</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> vision_transformer(num_blocks, patch_height, patch_width, num_heads, d_ff, y_vocab_size, x_maximum_position, dropout_rate):</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># KerasやTensorflowのレイヤーや関数をラップします。</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dense(units):</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Dense(units)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dropout(rate):</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Dropout(rate)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embedding(input_dim, output_dim):</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Embedding(input_dim, output_dim)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> flatten():</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Flatten()</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> gelu():</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.activations.gelu</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> layer_normalization():</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.LayerNormalization(epsilon<span class="op">=</span><span class="fl">1e-6</span>)</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reshape(target_shape):</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Reshape(target_shape)</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> softmax():</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Softmax()</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transpose(perm):</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func_partial(tf.transpose, perm<span class="op">=</span>perm)</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transformerに必要な演算を定義します。</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> scaled_dot_product_attention(x):</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>        query, key, value <span class="op">=</span> x</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.matmul(tf.nn.softmax(tf.matmul(query, key, transpose_b<span class="op">=</span><span class="va">True</span>) <span class="op">/</span> tf.math.sqrt(tf.cast(tf.shape(key)[<span class="op">-</span><span class="dv">1</span>], tf.float32)), axis<span class="op">=-</span><span class="dv">1</span>), value)</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> multi_head_attention(d_model, num_heads):</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>        split  <span class="op">=</span> rcompose(reshape((<span class="op">-</span><span class="dv">1</span>, num_heads, d_model <span class="op">//</span> num_heads)),  <span class="co"># noqa: E221</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>                          transpose((<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>)))</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>        concat <span class="op">=</span> rcompose(transpose((<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>)),</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>                          reshape((<span class="op">-</span><span class="dv">1</span>, d_model)))</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>            q, k, v <span class="op">=</span> inputs</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> scaled_dot_product_attention((split(dense(d_model)(q)),</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>                                              split(dense(d_model)(k)),</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>                                              split(dense(d_model)(v))))</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> concat(o)</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> dense(d_model)(o)</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> point_wise_feed_forward(d_model, d_ff):</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> rcompose(dense(d_ff),</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>                        gelu(),</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>                        dense(d_model))</span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> encoder_block(d_model, num_heads, d_ff, dropout_rate):</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> inputs</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> layer_normalization()(x)</span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> dropout(dropout_rate)(multi_head_attention(d_model, num_heads)((o, o, o))) <span class="op">+</span> o</span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> layer_normalization()(o)</span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> dropout(dropout_rate)(point_wise_feed_forward(d_model, d_ff)(o)) <span class="op">+</span> o</span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_positional_encoding(maximum_position, d_model):</span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> embedding(maximum_position, d_model)(tf.<span class="bu">range</span>(<span class="dv">0</span>, maximum_position))</span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result[np.newaxis, ...]</span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_patches():</span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> inputs</span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> tf.image.extract_patches(x, (<span class="dv">1</span>, patch_height, patch_width, <span class="dv">1</span>), (<span class="dv">1</span>, patch_height, patch_width, <span class="dv">1</span>), (<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="st">&#39;VALID&#39;</span>)</span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> reshape((<span class="op">-</span><span class="dv">1</span>, tf.keras.backend.int_shape(o)[<span class="op">-</span><span class="dv">1</span>]))(o)</span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> encoder(num_blocks, d_model, num_heads, d_ff, maximum_position, dropout_rate):</span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>        normalize_factor <span class="op">=</span> tf.math.sqrt(tf.cast(d_model, tf.float32))</span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>        positional_encoding <span class="op">=</span> get_positional_encoding(maximum_position, d_model)</span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> inputs</span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> get_patches()(x)</span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> dropout(dropout_rate)(o <span class="op">*</span> normalize_factor <span class="op">+</span> positional_encoding)</span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_blocks):</span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>                o <span class="op">=</span> encoder_block(d_model, num_heads, d_ff, dropout_rate)((o))</span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> op(inputs):</span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> inputs</span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> softmax()(dense(y_vocab_size)(flatten()(encoder(num_blocks, patch_height <span class="op">*</span> patch_width, num_heads, d_ff, x_maximum_position, dropout_rate)(x))))</span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> op</span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LearningRateSchedule(tf.keras.optimizers.schedules.LearningRateSchedule):</span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, d_model, warmup_steps<span class="op">=</span><span class="dv">4000</span>):</span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(LearningRateSchedule, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.d_model <span class="op">=</span> tf.cast(d_model, tf.float32)</span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.warmup_steps <span class="op">=</span> warmup_steps</span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, step):</span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.d_model <span class="op">**</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> tf.math.minimum(step <span class="op">**</span> <span class="op">-</span><span class="fl">0.5</span>, step <span class="op">*</span> <span class="va">self</span>.warmup_steps <span class="op">**</span> <span class="op">-</span><span class="fl">1.5</span>)</span></code></pre></div>
<p>自然言語処理では単語を埋め込み（embedding）してベクトル化して入力にするのですけど、Vision
Transformerでは画像を例えば16×16のパッチに分けて、それぞれのパッチをベクトルとして扱って入力としているのがキモです。</p>
<p>あとは、デコーダーが不要だったり、先読みが無関係なのでマスクがいらなかったり、Layer
Normalizationが先だったりReLUの代わりにGERUを使ったりと、少しだけニューラル・ネットワークが違うくらい。Transformerのコードがあるなら、その修正で簡単に作成できます。</p>
<p>……とはいっても、いざ修正してみると大量のエラーが出たりするんですけどね。でも、安心してください。エラーが出るのは関数の引数の型が合わないからで、しかもその型ってのは行列の形だったりします。普段のプログラミングで様々な型を考慮しなければならないのに比べれば、考えなければならないことが少ない分だけ簡単です。<code>print(tf.shape(x))</code>とかすれば行列の形が表示されますしね。</p>
<h2 id="データセットを取得する-1">データセットを取得する</h2>
<p>Vision
Transformerが出来たので、次は、データセットを取得するモジュールを作成します。</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># DataFrameを取得します。</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_data_frame(filename):</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, <span class="st">&#39;digit-recognizer&#39;</span>, filename))</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練用DataFrameを取得します。</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_train_data_frame():</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_data_frame(<span class="st">&#39;train.csv&#39;</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="co"># テスト用DataFrameを取得します。</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_test_data_frame():</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_data_frame(<span class="st">&#39;test.csv&#39;</span>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 入力データを取得します。</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xs(data_frame):</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.reshape(data_frame[<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> i: <span class="ss">f&#39;pixel</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&#39;</span>, <span class="bu">range</span>(<span class="dv">784</span>)))].values <span class="op">/</span> <span class="dv">255</span>, (<span class="op">-</span><span class="dv">1</span>, <span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>))</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 出力データを取得します。</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ys(data_frame):</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[<span class="st">&#39;label&#39;</span>].values</span></code></pre></div>
<p><code>get_xs()</code>の中で255で割っているのは、データ中は0～255になっているのを0～1に正規化するためです。深層学習のハイパー・パラメーターはデータが正規化されていることを前提にしているので、0～255のような大きな値だと学習が正常に進まないんですよ。</p>
<h2
id="ハイパーパラメーターを設定する">ハイパー・パラメーターを設定する</h2>
<p>Transformerのハイパー・パラメーターを設定するモジュールを作成します。</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>NUM_BLOCKS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>PATCH_HEIGHT <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>PATCH_WIDTH <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>D_MODEL <span class="op">=</span> PATCH_HEIGHT <span class="op">*</span> PATCH_WIDTH</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>D_FF <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>NUM_HEADS <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>DROPOUT_RATE <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>Y_VOCAB_SIZE <span class="op">=</span> <span class="dv">10</span></span></code></pre></div>
<p>パッチの大きさは4×4ドットにしました。今回のデータは28×28ドットなので、これなら割り切れて、あと、そこそこパッチ数も大きくなるんじゃないかと。他は調整が面倒だったのでTransformerを作ったときの値から変えていません。</p>
<h2 id="機械学習する">機械学習する</h2>
<p>準備が整ったので、機械学習しましょう。コードはこんな感じ。</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_train_data_frame, get_xs, get_ys</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> identity, juxt</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> starmap</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> operator <span class="im">import</span> eq</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> params <span class="im">import</span> NUM_BLOCKS, D_MODEL, NUM_HEADS, D_FF, Y_VOCAB_SIZE, DROPOUT_RATE</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> vision_transformer <span class="im">import</span> LearningRateSchedule, vision_transformer</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">0</span>)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_train_data_frame()</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データセットと検証データセットに分割するためのインデックスを作成します。</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> rng.permutation(np.arange(<span class="bu">len</span>(xs)))</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データセットを取得します。</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>train_xs <span class="op">=</span> xs[indices[<span class="dv">2000</span>:]]</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>train_ys <span class="op">=</span> ys[indices[<span class="dv">2000</span>:]]</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証データセットを取得します。</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>valid_xs <span class="op">=</span> xs[indices[:<span class="dv">2000</span>]]</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>valid_ys <span class="op">=</span> ys[indices[:<span class="dv">2000</span>]]</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Vision Transformerを作成します。</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>op <span class="op">=</span> vision_transformer(NUM_BLOCKS, D_MODEL, NUM_HEADS, D_FF, Y_VOCAB_SIZE, <span class="dv">28</span> <span class="op">*</span> <span class="dv">28</span> <span class="op">//</span> D_MODEL, DROPOUT_RATE)</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Kerasのモデルを作成します。</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.Model(<span class="op">*</span>juxt(identity, op)(tf.keras.Input(shape<span class="op">=</span>np.shape(xs)[<span class="dv">1</span>:])))</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(tf.keras.optimizers.Adam(LearningRateSchedule(D_MODEL), beta_1<span class="op">=</span><span class="fl">0.9</span>, beta_2<span class="op">=</span><span class="fl">0.98</span>, epsilon<span class="op">=</span><span class="fl">1e-9</span>), loss<span class="op">=</span><span class="st">&#39;sparse_categorical_crossentropy&#39;</span>, metrics<span class="op">=</span>(<span class="st">&#39;accuracy&#39;</span>,))</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a><span class="co"># model.summary()</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 機械学習します。</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>model.fit(train_xs, train_ys, batch_size<span class="op">=</span><span class="dv">256</span>, epochs<span class="op">=</span><span class="dv">10</span>, validation_data<span class="op">=</span>(valid_xs, valid_ys))</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a><span class="co"># 精度を表示します。</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Accuracy = </span><span class="sc">{</span><span class="bu">sum</span>(starmap(eq, <span class="bu">zip</span>(valid_ys, np.argmax(model.predict(valid_xs, batch_size<span class="op">=</span><span class="dv">256</span>), axis<span class="op">=-</span><span class="dv">1</span>)))) <span class="op">/</span> <span class="bu">len</span>(valid_xs)<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
<p>うん、Transformerの時とほぼ同じですね。Transformerの時は入力の行列の形を事前に決められなかった（文の長さは事前には分からない）ので変な形になっていました（それでも問題ないようにニューラル・ネットワークが工夫されていた）けど、今回は画像の大きさが決まっているので<code>tf.keras.Input(shape=np.shape(xs)[1:])</code>として行列の形を指定しました。</p>
<p>あとは、<code>compile()</code>の時の引数が<code>loss='sparse_categorical_crossentropy'</code>となっています。これは、クラス分類をする時用の損失関数（誤差を計算するための関数。LightGBMの<code>metric</code>）です。あと、Kerasでは、損失関数とは別に、人間に分かりやすい測定結果も出力できるようになっていて、それが<code>metrics</code>です。今回は、ここに精度である<code>accuracy</code>を指定しました。</p>
<p>残りはTransformerの時と同じです。実行してみると、精度は0.963でした。あれ、なんか精度低い？　2,000人くらい中の1,600番目くらい？</p>
<h2 id="予測モデルを作成する-2">予測モデルを作成する</h2>
<p>精度を確認するために、予測モデルを作成してテスト・データで予測して、Kaggleに提出してみましょう。まずは、予測モデルの作成から。</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_train_data_frame, get_xs, get_ys</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> identity, juxt</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> params <span class="im">import</span> NUM_BLOCKS, D_MODEL, NUM_HEADS, D_FF, Y_VOCAB_SIZE, DROPOUT_RATE</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> vision_transformer <span class="im">import</span> LearningRateSchedule, vision_transformer</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">0</span>)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_train_data_frame()</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Vision Transformerを作成します。</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>op <span class="op">=</span> vision_transformer(NUM_BLOCKS, D_MODEL, NUM_HEADS, D_FF, Y_VOCAB_SIZE, <span class="dv">28</span> <span class="op">*</span> <span class="dv">28</span> <span class="op">//</span> D_MODEL, DROPOUT_RATE)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Kerasのモデルを作成します。</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.Model(<span class="op">*</span>juxt(identity, op)(tf.keras.Input(shape<span class="op">=</span>np.shape(xs)[<span class="dv">1</span>:])))</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(tf.keras.optimizers.Adam(LearningRateSchedule(D_MODEL), beta_1<span class="op">=</span><span class="fl">0.9</span>, beta_2<span class="op">=</span><span class="fl">0.98</span>, epsilon<span class="op">=</span><span class="fl">1e-9</span>), loss<span class="op">=</span><span class="st">&#39;sparse_categorical_crossentropy&#39;</span>, metrics<span class="op">=</span>(<span class="st">&#39;accuracy&#39;</span>,))</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span class="co"># model.summary()</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 機械学習して、モデルを保存します。</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>model.fit(xs, ys, batch_size<span class="op">=</span><span class="dv">256</span>, epochs<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">&#39;digit-recognizer-model&#39;</span>, include_optimizer<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<p>機械学習するモジュールからコードを切り貼りして、最後にモデルを保存する処理を追加しただけです。あ、精度が上がるかもと思って、エポック数は10から100に増やしました。</p>
<h2 id="解答を作成する-2">解答を作成する</h2>
<p>テスト・データで予測して解答を作成するモジュールを作成します。コードはこんな感じ。</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_test_data_frame, get_xs</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを取得します。</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;digit-recognizer-model&#39;</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_test_data_frame()</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 入力データを取得します。</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 解答を作成して、保存します。</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>submission <span class="op">=</span> pd.DataFrame({<span class="st">&#39;ImageId&#39;</span>: data_frame.index <span class="op">+</span> <span class="dv">1</span>, <span class="st">&#39;Label&#39;</span>: np.argmax(model.predict(xs, batch_size<span class="op">=</span><span class="dv">256</span>), axis<span class="op">=-</span><span class="dv">1</span>)})</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>submission.to_csv(<span class="st">&#39;submission.csv&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<p>さて、テスト・データでの精度は、0.98285でした。エポック数を増やした分だけ精度が上がったような気がしますが、それでも2,000人くらい中の900番目くらい。Digit
Recognizerでもやっぱりカンニングしている連中はいるけど、それにしたって低すぎます。2020年に画像認識の革命と大騒ぎになったVision
Transformerを使っているのにどういうこと？</p>
<p>……ここまで真面目に読んでくださった皆様ごめんなさい。たぶんこんな結果になると、実は知ってました。</p>
<p>というのも、Transformer系って、大量のデータがないと精度が高くならないんですよ。Transformerの後に自然言語処理で人間を超えたと話題になったBERTはBooksCorpusという8億ワードのデータとWikipediaの25億ワードのデータで事前学習しましたし、Vision
Transformerで最高の精度を出したときはGoogle社のプライベートなデータセットであるJFT-300Mという3億枚の画像を使用して事前学習しています。データの単位が億なんですな。</p>
<p>それと比較して今回は、事前学習がゼロで、学習に使用したデータは4万2千……。そりゃ、精度なんか出ませんよね。</p>
<p>こんな感じで、実用という意味では、深層学習の最先端は我々一般人の手が届かない遥か彼方に行ってしまった感があります。そもそもデータが集まらないし、仮にデータが集まっても一般人の手に入るレベルの計算リソースだととても学習させられないし。</p>
<p>というわけで、事前学習済みのモデルに転移学習（fine
tuning）するような場合にしか使えないんじゃないかなぁと。貴方の目的に合う事前学習と入力のものが運良く見つかったならば、ですけど。</p>
<h1 id="densenetで画像のクラス分類">DenseNetで画像のクラス分類</h1>
<p>だから今回は、アテンションではなく、畳み込みを使うモデルで勝負しました。DenseNetです。</p>
<h2 id="densenetを実装する">DenseNetを実装する</h2>
<p>DenseNetの実装はこんな感じ。</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> rcompose</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dense_net(growth_rate, classes):</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># KerasやTensorflowのレイヤーや関数をラップします。</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> average_pooling_2d(pool_size, strides<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.AveragePooling2D(pool_size, strides<span class="op">=</span>strides)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> concatenate():</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Concatenate()</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> batch_normalization():</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.BatchNormalization(epsilon<span class="op">=</span><span class="fl">1.001e-5</span>)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> conv_2d(filters, kernel_size):</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Conv2D(filters, kernel_size, padding<span class="op">=</span><span class="st">&#39;same&#39;</span>, use_bias<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dense(units):</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Dense(units)</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> global_average_pooling_2d():</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.GlobalAveragePooling2D()</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> relu():</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.ReLU()</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> softmax():</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Softmax()</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> zero_padding2d(padding):</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.ZeroPadding2D(padding<span class="op">=</span>padding)</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DenseNetに必要な演算を定義します。</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dense_block(blocks):</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> inputs</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(blocks):</span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>                result_ <span class="op">=</span> batch_normalization()(result)</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>                result_ <span class="op">=</span> relu()(result_)</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>                result_ <span class="op">=</span> conv_2d(<span class="dv">4</span> <span class="op">*</span> growth_rate, <span class="dv">1</span>)(result_)</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>                result_ <span class="op">=</span> batch_normalization()(result_)</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>                result_ <span class="op">=</span> relu()(result_)</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>                result_ <span class="op">=</span> conv_2d(growth_rate, <span class="dv">3</span>)(result_)</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> concatenate()((result, result_))</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> result</span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transition_block():</span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> batch_normalization()(inputs)</span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> relu()(result)</span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> conv_2d(<span class="bu">int</span>(tf.keras.backend.int_shape(inputs)[<span class="dv">3</span>] <span class="op">*</span> <span class="fl">0.5</span>), <span class="dv">1</span>)(result)</span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> average_pooling_2d(<span class="dv">2</span>, strides<span class="op">=</span><span class="dv">2</span>)(result)</span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> result</span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-67"><a href="#cb44-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dense_net_121():</span>
<span id="cb44-68"><a href="#cb44-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> rcompose(dense_block(<span class="dv">6</span>),</span>
<span id="cb44-69"><a href="#cb44-69" aria-hidden="true" tabindex="-1"></a>                        transition_block(),</span>
<span id="cb44-70"><a href="#cb44-70" aria-hidden="true" tabindex="-1"></a>                        dense_block(<span class="dv">12</span>),</span>
<span id="cb44-71"><a href="#cb44-71" aria-hidden="true" tabindex="-1"></a>                        transition_block(),</span>
<span id="cb44-72"><a href="#cb44-72" aria-hidden="true" tabindex="-1"></a>                        dense_block(<span class="dv">24</span>),</span>
<span id="cb44-73"><a href="#cb44-73" aria-hidden="true" tabindex="-1"></a>                        transition_block(),</span>
<span id="cb44-74"><a href="#cb44-74" aria-hidden="true" tabindex="-1"></a>                        dense_block(<span class="dv">16</span>))</span>
<span id="cb44-75"><a href="#cb44-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-76"><a href="#cb44-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rcompose(conv_2d(<span class="dv">64</span>, <span class="dv">1</span>),</span>
<span id="cb44-77"><a href="#cb44-77" aria-hidden="true" tabindex="-1"></a>                    batch_normalization(),</span>
<span id="cb44-78"><a href="#cb44-78" aria-hidden="true" tabindex="-1"></a>                    relu(),  <span class="co"># ImageNetの場合はここでConv2DやMaxPooling2Dで画素数を減らすのですけど、今回はもともとの画素数が少ないのでやりません。</span></span>
<span id="cb44-79"><a href="#cb44-79" aria-hidden="true" tabindex="-1"></a>                    dense_net_121(),</span>
<span id="cb44-80"><a href="#cb44-80" aria-hidden="true" tabindex="-1"></a>                    batch_normalization(),</span>
<span id="cb44-81"><a href="#cb44-81" aria-hidden="true" tabindex="-1"></a>                    relu(),</span>
<span id="cb44-82"><a href="#cb44-82" aria-hidden="true" tabindex="-1"></a>                    global_average_pooling_2d(),</span>
<span id="cb44-83"><a href="#cb44-83" aria-hidden="true" tabindex="-1"></a>                    dense(classes),</span>
<span id="cb44-84"><a href="#cb44-84" aria-hidden="true" tabindex="-1"></a>                    softmax())</span></code></pre></div>
<p>Transformerに比べるとだいぶん簡単です。例によって、検索で見つけた様々な解説と、<a
href="https://github.com/keras-team/keras-applications/blob/master/keras_applications/densenet.py">KerasのDenseNet実装</a>を参考にしました。</p>
<p>DenseNetはImageNetというデータセットを前提にしていて、224×224ドットの画像が入力されることを前提にしています。Digit
Recognizerの入力は28×28ドットとだいぶん小さいので、コメントに書いたように前処理を省略しました。モデルを自作すると、このような調整が出来て便利です。</p>
<h2 id="データセットを取得する-2">データセットを取得する</h2>
<p>データセットを取得するモジュールを作成します。</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># DataFrameを取得します。</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_data_frame(filename):</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, <span class="st">&#39;digit-recognizer&#39;</span>, filename))</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練用DataFrameを取得します。</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_train_data_frame():</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_data_frame(<span class="st">&#39;train.csv&#39;</span>)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="co"># テスト用DataFrameを取得します。</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_test_data_frame():</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_data_frame(<span class="st">&#39;test.csv&#39;</span>)</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 入力データを取得します。</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xs(data_frame):</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.reshape(data_frame[<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> i: <span class="ss">f&#39;pixel</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&#39;</span>, <span class="bu">range</span>(<span class="dv">784</span>)))].values <span class="op">/</span> <span class="dv">255</span>, (<span class="op">-</span><span class="dv">1</span>, <span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>))</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 出力データを取得します。</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ys(data_frame):</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[<span class="st">&#39;label&#39;</span>].values</span></code></pre></div>
<p>ごめんなさい。Vision
Transformerの時と全く同じです。繰り返しになりますけど、255で割っているのは0～1に正規化するためで、正規化しないと学習が正常に進まないので気を付けてください。</p>
<h2 id="機械学習する-1">機械学習する</h2>
<p>準備ができたので、機械学習してみましょう。</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_train_data_frame, get_xs, get_ys</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dense_net <span class="im">import</span> dense_net</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> concat, identity, juxt, partial, repeat, take</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> starmap</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> operator <span class="im">import</span> eq, getitem</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">0</span>)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_train_data_frame()</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データセットと検証データセットに分割するためのインデックスを作成します。</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> rng.permutation(np.arange(<span class="bu">len</span>(xs)))</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練データセットを取得します。</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>train_xs <span class="op">=</span> xs[indices[<span class="dv">2000</span>:]]</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>train_ys <span class="op">=</span> ys[indices[<span class="dv">2000</span>:]]</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 検証データセットを取得します。</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>valid_xs <span class="op">=</span> xs[indices[:<span class="dv">2000</span>]]</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>valid_ys <span class="op">=</span> ys[indices[:<span class="dv">2000</span>]]</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a><span class="co"># DenseNetを作成します。</span></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>op <span class="op">=</span> dense_net(<span class="dv">16</span>, <span class="dv">10</span>)</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Kerasのモデルを作成します。</span></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.Model(<span class="op">*</span>juxt(identity, op)(tf.keras.Input(shape<span class="op">=</span>np.shape(xs)[<span class="dv">1</span>:])))</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(<span class="st">&#39;adam&#39;</span>, loss<span class="op">=</span><span class="st">&#39;sparse_categorical_crossentropy&#39;</span>, metrics<span class="op">=</span>(<span class="st">&#39;accuracy&#39;</span>,))</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a><span class="co"># model.summary()</span></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>epoch_size <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a><span class="co"># データの水増しをします。</span></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>image_data_generator <span class="op">=</span> tf.keras.preprocessing.image.ImageDataGenerator(rotation_range<span class="op">=</span><span class="fl">22.5</span>,</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>                                                                       width_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>                                                                       height_shift_range<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 機械学習して、モデルを保存します。</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>model.fit(image_data_generator.flow(train_xs, train_ys, batch_size<span class="op">=</span>batch_size),</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>          steps_per_epoch<span class="op">=</span><span class="bu">len</span>(train_xs) <span class="op">//</span> batch_size,</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>          epochs<span class="op">=</span>epoch_size,</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>          callbacks<span class="op">=</span>(tf.keras.callbacks.LearningRateScheduler(partial(getitem, <span class="bu">tuple</span>(take(epoch_size, concat(repeat(<span class="fl">0.01</span>, epoch_size <span class="op">//</span> <span class="dv">2</span>), repeat(<span class="fl">0.01</span> <span class="op">/</span> <span class="dv">10</span>, epoch_size <span class="op">//</span> <span class="dv">4</span>), repeat(<span class="fl">0.01</span> <span class="op">/</span> <span class="dv">100</span>))))))),</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>          validation_data<span class="op">=</span>(valid_xs, valid_ys))</span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 精度を出力します。</span></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Accuracy = </span><span class="sc">{</span><span class="bu">sum</span>(starmap(eq, <span class="bu">zip</span>(valid_ys, np.argmax(model.predict(valid_xs, batch_size<span class="op">=</span><span class="dv">256</span>), axis<span class="op">=-</span><span class="dv">1</span>)))) <span class="op">/</span> <span class="bu">len</span>(valid_xs)<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
<p>前半はVision
Transformerの時と同じですが、後半はちょっと違っています。</p>
<p>まずは、Kerasのモデルを<code>compile()</code>するところ。Vision
Transformerでは学習率を専用のクラスを作成して調整しましたが、今回は、<code>compile()</code>の時は<code>adam</code>を使うようにだけ指定して、後でコールバックを使用して学習率を調整しています。<code>fit()</code>や今回使用した<code>fit_generator()</code>の引数のcallbacksに<code>LearningRateScheduler</code>を指定して、そこでエポック数の半分はデフォルトの学習率、1/4はその1/10、残りは1/100にしています。</p>
<p>で、TransformerやVision
Transformerでは曖昧にごまかした学習率の調整なのですけど、これ、遠くにあるゴール目指して歩く時の歩幅だと考えてみてください。まずは、ゴールが遠いので大股で歩かないとゴールにたどりつけませんから、歩幅を大きくします。でも、その歩幅のままだと、いつかはゴールを通り過ぎてしまいます。で、Uターンしたとしても、歩幅が大きいので、またゴールを通り過ぎてしまいます。それでは困るので、学習率を下げて歩幅を小さくします。これで、ゴールまでより近づくことができるようになりますが、その場合であっても、ゴールまでの距離より歩幅の方が大きければまた同じ問題が発生します。だから、念のためもう一度歩幅を狭めたというわけ。</p>
<p>次は、データの水増し（data
augmentation）です。機械学習はデータに見つかるパターンしか学習しませんから、データ中のバリエーションを増やしたい。たとえば、少し右にずれている画像とか、少し回転している画像とか、あとは、今回は使えないですけど左右が反転した画像とか。犬猫認識で、もし左を向いたデータしかなければ、右を向いた犬は犬と識別できないことになっちゃいますもんね。というわけで、今回は<code>ImageDataGenerator</code>でデータを加工して水増ししました。上のコードでは、±22.5°まで傾けたり、2/10まで画像を左右や上下に動かしたりしています。</p>
<p>で、<code>ImageDataGenerator</code>のような、データがどんどん生成されるような場合（他に、データが大きすぎてメモリに乗らない場合にストレージから逐次的に読み込む場合なんてのもあります）は、<code>fit()</code>とはちょっと引数が違うので気を付けてください。</p>
<p>以上でコードの解説は完了しましたので、実行して精度を測定します。で、精度は、0.9955でした。2,000人中の130位くらい。うん、やっぱり深層学習はこうでなきゃ。</p>
<h2 id="予測モデルを作成する-3">予測モデルを作成する</h2>
<p>テスト・データでもこのような高い精度がでるのか、確認しましょう。まずは、予測モデルの作成です。</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_train_data_frame, get_xs, get_ys</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dense_net <span class="im">import</span> dense_net</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> concat, identity, juxt, partial, repeat, take</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> operator <span class="im">import</span> getitem</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">0</span>)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_train_data_frame()</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="co"># DenseNetを作成します。</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>op <span class="op">=</span> dense_net(<span class="dv">16</span>, <span class="dv">10</span>)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Kerasのモデルを作成します。</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.Model(<span class="op">*</span>juxt(identity, op)(tf.keras.Input(shape<span class="op">=</span>np.shape(xs)[<span class="dv">1</span>:])))</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(<span class="st">&#39;adam&#39;</span>, loss<span class="op">=</span><span class="st">&#39;sparse_categorical_crossentropy&#39;</span>, metrics<span class="op">=</span>(<span class="st">&#39;accuracy&#39;</span>,))</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="co"># model.summary()</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="co"># データの水増しをします。</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>image_data_generator <span class="op">=</span> tf.keras.preprocessing.image.ImageDataGenerator(rotation_range<span class="op">=</span><span class="fl">22.5</span>,</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>                                                                       width_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>                                                                       height_shift_range<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>epoch_size <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 機械学習して、モデルを保存します。</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>model.fit(image_data_generator.flow(xs, ys, batch_size<span class="op">=</span>batch_size),</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>          steps_per_epoch<span class="op">=</span><span class="bu">len</span>(xs) <span class="op">//</span> batch_size,</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>          epochs<span class="op">=</span>epoch_size,</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>          callbacks<span class="op">=</span>(tf.keras.callbacks.LearningRateScheduler(partial(getitem, <span class="bu">tuple</span>(take(epoch_size, concat(repeat(<span class="fl">0.01</span>, epoch_size <span class="op">//</span> <span class="dv">2</span>), repeat(<span class="fl">0.01</span> <span class="op">/</span> <span class="dv">10</span>, epoch_size <span class="op">//</span> <span class="dv">4</span>), repeat(<span class="fl">0.01</span> <span class="op">/</span> <span class="dv">100</span>))))))))</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">&#39;digit-recognizer-model&#39;</span>, include_optimizer<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<h2 id="解答を作成する-3">解答を作成する</h2>
<p>最後。解答の作成です。</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_test_data_frame, get_xs</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを取得します。</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;digit-recognizer-model&#39;</span>)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_test_data_frame()</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 入力データを取得します。</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 解答を作成して、保存します。</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>submission <span class="op">=</span> pd.DataFrame({<span class="st">&#39;ImageId&#39;</span>: data_frame.index <span class="op">+</span> <span class="dv">1</span>, <span class="st">&#39;Label&#39;</span>: np.argmax(model.predict(xs, batch_size<span class="op">=</span><span class="dv">256</span>), axis<span class="op">=-</span><span class="dv">1</span>)})</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>submission.to_csv(<span class="st">&#39;submission.csv&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<p>やりました！　精度は0.99567で、2,000人位中126位になりました！　カンニング（Digit
RecognizerのデータはMNISTという答えが公開されているデータセットをそのまま使用しているので、MNISTを見れば正解が分かってしまう）している連中がいることを考えると、かなり良い成績だと思います。</p>
<p>やったことは、とても簡単ですしね。深層学習と画像認識で検索したら見つかったDenseNetを、Kerasの公式実装を参考にして作成しただけ。こんな簡単なことで高い精度で画像認識できるなんて、やはり深層学習は素晴らしい！</p>
<h1
id="transformerでテーブルデータもやってみた">Transformerでテーブル・データもやってみた</h1>
<p>と、こんな感じで画像（とか音声とか自然言語）なら深層学習でしょうって感じなのですが、テーブル・データではどうなのでしょうか？</p>
<p>伝統的には、テーブル・データの場合は全結合を重ねただけのMLP（Multilayer
Perceptron）を使うのですけど、畳み込みもアテンションも使わないのでは精度が上がらなそう。だから畳み込み……は、テーブル・データの場合はカラムの順序に意味がない（年齢→身長→体重と並べても、体重→身長→年齢と並べてもよい）のでちょっと使えません。というわけで、アテンションを使ってみましょう。Transformerを改造して、Titanicをやってみます。</p>
<h2 id="特徴量をベクトル化する方法">特徴量をベクトル化する方法</h2>
<p>Transformerを使うためには、特徴量をベクトルに変換できなければなりません。カテゴリー型の特徴量なら<code>embedding</code>が使えますけど、数値型の特長量はどうしましょうか？</p>
<p>テーブル・データと深層学習でGoogle検索したら見つけた<a
href="https://tech.preferred.jp/ja/blog/deep-table/">Preferred
Networks社のBlog</a>からソース・コードを辿ってみたら全結合を使ってベクトル化していたので、この方式を採用しましょう。Blogが参照している論文のどこかに全結合で良い理由が書いてあるのでしょうけど、すみません、参照先の論文はまだ読んでいません……。</p>
<h2 id="transformer改を作成する">Transformer改を作成する</h2>
<p>ともあれ、方針が決まりましたので、Transformer（を元に作成したVision
Transformer）を改造します。</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> func_partial, rcompose</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transformer(num_blocks, d_model, num_heads, d_ff, x_maximum_position, dropout_rate):</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># KerasやTensorflowのレイヤーや関数をラップします。</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dense(units):</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Dense(units)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dropout(rate):</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Dropout(rate)</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> embedding(input_dim, output_dim):</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Embedding(input_dim, output_dim)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> flatten():</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Flatten()</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> gelu():</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.activations.gelu</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> layer_normalization():</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.LayerNormalization(epsilon<span class="op">=</span><span class="fl">1e-6</span>)</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reshape(target_shape):</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Reshape(target_shape)</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sigmoid():</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.keras.layers.Activation(<span class="st">&#39;sigmoid&#39;</span>)</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transpose(perm):</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> func_partial(tf.transpose, perm<span class="op">=</span>perm)</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transformerに必要な演算を定義します。</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> scaled_dot_product_attention(x):</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>        query, key, value <span class="op">=</span> x</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tf.matmul(tf.nn.softmax(tf.matmul(query, key, transpose_b<span class="op">=</span><span class="va">True</span>) <span class="op">/</span> tf.math.sqrt(tf.cast(tf.shape(key)[<span class="op">-</span><span class="dv">1</span>], tf.float32)), axis<span class="op">=-</span><span class="dv">1</span>), value)</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> multi_head_attention(d_model, num_heads):</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>        split <span class="op">=</span> rcompose(reshape((<span class="op">-</span><span class="dv">1</span>, num_heads, d_model <span class="op">//</span> num_heads)),  <span class="co"># noqa: E221</span></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>                          transpose((<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>)))</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>        concat <span class="op">=</span> rcompose(transpose((<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>)),</span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>                          reshape((<span class="op">-</span><span class="dv">1</span>, d_model)))</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>            q, k, v <span class="op">=</span> inputs</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> scaled_dot_product_attention((split(dense(d_model)(q)),</span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>                                              split(dense(d_model)(k)),</span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>                                              split(dense(d_model)(v))))</span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> concat(o)</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> dense(d_model)(o)</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> point_wise_feed_forward(d_model, d_ff):</span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> rcompose(dense(d_ff),</span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a>                        gelu(),</span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>                        dense(d_model))</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> encoder_block(d_model, num_heads, d_ff, dropout_rate):</span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> inputs</span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> layer_normalization()(x)</span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> dropout(dropout_rate)(multi_head_attention(d_model, num_heads)((o, o, o))) <span class="op">+</span> o</span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> layer_normalization()(o)</span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> dropout(dropout_rate)(point_wise_feed_forward(d_model, d_ff)(o)) <span class="op">+</span> o</span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_positional_encoding(maximum_position, d_model):</span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> embedding(maximum_position, d_model)(tf.<span class="bu">range</span>(<span class="dv">0</span>, maximum_position))</span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result[np.newaxis, ...]</span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> encoder(num_blocks, d_model, num_heads, d_ff, maximum_position, dropout_rate):</span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a>        normalize_factor <span class="op">=</span> tf.math.sqrt(tf.cast(d_model, tf.float32))</span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a>        positional_encoding <span class="op">=</span> get_positional_encoding(maximum_position, d_model)</span>
<span id="cb49-89"><a href="#cb49-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-90"><a href="#cb49-90" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> op(inputs):</span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> inputs</span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 特徴量をベクトル化します。数値の特長量は、全結合でベクトル化します。</span></span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a>            x0, x1, x2, x3, x4, x5, x6, x7 <span class="op">=</span> tf.split(x, [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">1</span>)</span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> tf.concat((tf.stack((dense(d_model)(x0),   <span class="co"># PClass</span></span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a>                                    dense(d_model)(x2),   <span class="co"># Age</span></span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a>                                    dense(d_model)(x3),   <span class="co"># SibSp</span></span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a>                                    dense(d_model)(x4),   <span class="co"># Parch</span></span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a>                                    dense(d_model)(x5)),  <span class="co"># Fare</span></span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a>                                    axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb49-101"><a href="#cb49-101" aria-hidden="true" tabindex="-1"></a>                           embedding(<span class="dv">2</span>, d_model)(x1),      <span class="co"># Sex。マジック・ナンバーが入ってしまってごめんなさい……</span></span>
<span id="cb49-102"><a href="#cb49-102" aria-hidden="true" tabindex="-1"></a>                           embedding(<span class="dv">4</span>, d_model)(x6),      <span class="co"># Embarked。マジック・ナンバーが入ってしまってごめんなさい……</span></span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a>                           embedding(<span class="dv">5</span>, d_model)(x7)),     <span class="co"># Title。マジック・ナンバーが入ってしまってごめんなさい……</span></span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a>                          axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-106"><a href="#cb49-106" aria-hidden="true" tabindex="-1"></a>            o <span class="op">=</span> dropout(dropout_rate)(o <span class="op">*</span> normalize_factor <span class="op">+</span> positional_encoding)</span>
<span id="cb49-107"><a href="#cb49-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_blocks):</span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a>                o <span class="op">=</span> encoder_block(d_model, num_heads, d_ff, dropout_rate)((o))</span>
<span id="cb49-110"><a href="#cb49-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-111"><a href="#cb49-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> o</span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-113"><a href="#cb49-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> op</span>
<span id="cb49-114"><a href="#cb49-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> op(inputs):</span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> inputs</span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sigmoid()(dense(<span class="dv">1</span>)(flatten()(encoder(num_blocks, d_model, num_heads, d_ff, x_maximum_position, dropout_rate)(x))))</span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> op</span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LearningRateSchedule(tf.keras.optimizers.schedules.LearningRateSchedule):</span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, d_model, warmup_steps<span class="op">=</span><span class="dv">4000</span>):</span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(LearningRateSchedule, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-127"><a href="#cb49-127" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.d_model <span class="op">=</span> tf.cast(d_model, tf.float32)</span>
<span id="cb49-128"><a href="#cb49-128" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.warmup_steps <span class="op">=</span> warmup_steps</span>
<span id="cb49-129"><a href="#cb49-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-130"><a href="#cb49-130" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, step):</span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.d_model <span class="op">**</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> tf.math.minimum(step <span class="op">**</span> <span class="op">-</span><span class="fl">0.5</span>, step <span class="op">*</span> <span class="va">self</span>.warmup_steps <span class="op">**</span> <span class="op">-</span><span class="fl">1.5</span>)</span></code></pre></div>
<p>数値の特徴量は<code>dense</code>で、カテゴリー型の特徴量は<code>embedding</code>でベクトル化するわけですね。あと、Titanicは2値分類なので、最後の<code>dense</code>の要素数を1にして、<code>sigmoid</code>（出力範囲を0～1にしてくれる）しました。他はVision
Transformerと同じで楽ちんでした。</p>
<h1 id="データセットを取得する-3">データセットを取得する</h1>
<p>次はデータセットを取得するモジュールです。こんな感じ。</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> count, repeat</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 数値型の特徴量のNaNを平均値で埋めます。</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fill_na(data_frame):</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature <span class="kw">in</span> (<span class="st">&#39;Pclass&#39;</span>, <span class="st">&#39;Age&#39;</span>, <span class="st">&#39;SibSp&#39;</span>, <span class="st">&#39;Parch&#39;</span>, <span class="st">&#39;Fare&#39;</span>):</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>        data_frame[feature] <span class="op">=</span> data_frame[feature].fillna(data_frame[feature].mean())</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 特徴量を追加します。</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_features(data_frame):</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書追加用の補助関数。</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_title(title_series, name_series, <span class="bu">id</span>, titles):</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>        title_series[<span class="bu">reduce</span>(<span class="kw">lambda</span> acc, series: acc <span class="op">+</span> series, <span class="bu">map</span>(<span class="kw">lambda</span> title: name_series.<span class="bu">str</span>.contains(title), titles))] <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> title_series</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 肩書を追加します。</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;Title&#39;</span>] <span class="op">=</span> <span class="bu">reduce</span>(<span class="kw">lambda</span> title_series, params: add_title(title_series, data_frame[<span class="st">&#39;Name&#39;</span>], <span class="op">*</span>params),</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>                                 ((<span class="dv">0</span>, (<span class="st">&#39;Mr.&#39;</span>, <span class="st">&#39;Dr.&#39;</span>, <span class="st">&#39;Rev.&#39;</span>, <span class="st">&#39;Don.&#39;</span>, <span class="st">&#39;Col.&#39;</span>, <span class="st">&#39;Major.&#39;</span>, <span class="st">&#39;Capt.&#39;</span>)),</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">1</span>, (<span class="st">&#39;Master.&#39;</span>,)),</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">2</span>, (<span class="st">&#39;Mrs.&#39;</span>, <span class="st">&#39;Mme.&#39;</span>, <span class="st">&#39;Ms.&#39;</span>)),</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>                                  (<span class="dv">3</span>, (<span class="st">&#39;Miss.&#39;</span>,))),</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>                                 pd.Series(repeat(np.nan, <span class="bu">len</span>(data_frame[<span class="st">&#39;Name&#39;</span>])), dtype<span class="op">=</span><span class="st">&#39;object&#39;</span>))</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリ型の特徴量を、どの数値に変換するかのdictを取得します。</span></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_categorical_features(data_frame):</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">map</span>(<span class="kw">lambda</span> feature: (feature, <span class="bu">dict</span>(<span class="bu">zip</span>(data_frame[feature].factorize()[<span class="dv">1</span>], count(<span class="dv">1</span>)))), (<span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>)))  <span class="co"># NaNは0にして、カテゴリは1始まり。</span></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a><span class="co"># 数値型の特徴量の最小値と最大値を取得します。正規化のためです。</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_feature_ranges(data_frame):</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(<span class="bu">map</span>(<span class="kw">lambda</span> feature: (feature, (data_frame[feature].<span class="bu">min</span>(), data_frame[feature].<span class="bu">max</span>())), (<span class="st">&#39;Pclass&#39;</span>, <span class="st">&#39;Age&#39;</span>, <span class="st">&#39;SibSp&#39;</span>, <span class="st">&#39;Parch&#39;</span>, <span class="st">&#39;Fare&#39;</span>)))</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a><span class="co"># DataFrameを取得します。</span></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_data_frame(filename):</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> add_features(fill_na(pd.read_csv(path.join(<span class="st">&#39;..&#39;</span>, <span class="st">&#39;input&#39;</span>, <span class="st">&#39;titanic&#39;</span>, filename))))</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a><span class="co"># 訓練用DataFrameを取得します。</span></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_train_data_frame():</span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_data_frame(<span class="st">&#39;train.csv&#39;</span>)</span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a><span class="co"># テスト用DataFrameを取得します。</span></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_test_data_frame():</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_data_frame(<span class="st">&#39;test.csv&#39;</span>)</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 入力データを取得します。</span></span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_xs(data_frame, categorical_features, feature_ranges):</span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># カテゴリ型の特徴量を、数値に変換します。</span></span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, mapping <span class="kw">in</span> categorical_features.items():</span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>        data_frame[feature] <span class="op">=</span> data_frame[feature].<span class="bu">map</span>(mapping).fillna(<span class="dv">0</span>)</span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 数値型の特徴量を、正規化します。</span></span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, (<span class="bu">min</span>, <span class="bu">max</span>) <span class="kw">in</span> feature_ranges.items():</span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>        data_frame[feature] <span class="op">=</span> (data_frame[feature] <span class="op">-</span> <span class="bu">min</span>) <span class="op">/</span> (<span class="bu">max</span> <span class="op">-</span> <span class="bu">min</span>)</span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SexはNaNがないので、1を引いて0と1にします。</span></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a>    data_frame[<span class="st">&#39;Sex&#39;</span>] <span class="op">=</span> data_frame[<span class="st">&#39;Sex&#39;</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 予測に使用するカラムだけを抽出します。</span></span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[[<span class="st">&#39;Pclass&#39;</span>, <span class="st">&#39;Sex&#39;</span>, <span class="st">&#39;Age&#39;</span>, <span class="st">&#39;SibSp&#39;</span>, <span class="st">&#39;Parch&#39;</span>, <span class="st">&#39;Fare&#39;</span>, <span class="st">&#39;Embarked&#39;</span>, <span class="st">&#39;Title&#39;</span>]].values</span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a><span class="co"># 出力データを取得します。</span></span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ys(data_frame):</span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data_frame[<span class="st">&#39;Survived&#39;</span>].values</span></code></pre></div>
<p>深層学習なので正規化とかしなければならなくて大変でした。あと、四則演算で作成する程度の特徴量は行列演算する深層学習では無意味で、今回はそのような特徴量しか追加されていなかったので、特徴量エンジニアリングは無しです。</p>
<h2 id="モデルを保存して読み込む-1">モデルを保存して読み込む</h2>
<p>モデル（に入力するデータを作成するための情報）を保存したり読み込んだりするモジュール尾作成します。</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> path</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリーの特徴量を保存します。</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_categorical_features(categorical_features):</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path.join(<span class="st">&#39;titanic-model&#39;</span>, <span class="st">&#39;categorical-features.pickle&#39;</span>), mode<span class="op">=</span><span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>        pickle.dump(categorical_features, f)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="co"># カテゴリーの特徴量を読み込みます。</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_categorical_features():</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path.join(<span class="st">&#39;titanic-model&#39;</span>, <span class="st">&#39;categorical-features.pickle&#39;</span>), mode<span class="op">=</span><span class="st">&#39;rb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pickle.load(f)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 数値型の特徴量の最小値と最大値を保存します。</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_feature_rangess(feature_ranges):</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path.join(<span class="st">&#39;titanic-model&#39;</span>, <span class="st">&#39;feature-ranges.pickle&#39;</span>), mode<span class="op">=</span><span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>        pickle.dump(feature_ranges, f)</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 数値型の特徴量の最小値と最大値を読み込みます。</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_feature_ranges():</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path.join(<span class="st">&#39;titanic-model&#39;</span>, <span class="st">&#39;feature-ranges.pickle&#39;</span>), mode<span class="op">=</span><span class="st">&#39;rb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pickle.load(f)</span></code></pre></div>
<p>数値型の特徴量の最大値と最小値の情報を追加しました。これを保存しておかないと、機械学習した時と同じ条件で正規化できなくなっちゃいますもんね。</p>
<h2
id="ハイパーパラメーターを設定する-1">ハイパー・パラメーターを設定する</h2>
<p>Transformerのハイパー・パラメーターはこんな感じ。</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>NUM_BLOCKS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>D_MODEL <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>D_FF <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>NUM_HEADS <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>DROPOUT_RATE <span class="op">=</span> <span class="fl">0.1</span></span></code></pre></div>
<h2 id="予測モデルを作成する-4">予測モデルを作成する</h2>
<p>準備が終わりましたので予測モデルを作成しましょう。</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_feature_ranges, get_train_data_frame, get_categorical_features, get_xs, get_ys</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> funcy <span class="im">import</span> identity, juxt</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> model <span class="im">import</span> save_feature_rangess, save_categorical_features</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> params <span class="im">import</span> NUM_BLOCKS, D_MODEL, NUM_HEADS, D_FF, DROPOUT_RATE</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformer <span class="im">import</span> LearningRateSchedule, transformer</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_train_data_frame()</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> get_categorical_features(data_frame)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>feature_ranges <span class="op">=</span> get_feature_ranges(data_frame)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="co"># データセットを取得します。</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features, feature_ranges)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> get_ys(data_frame)</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 機械学習します。</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>op <span class="op">=</span> transformer(NUM_BLOCKS, D_MODEL, NUM_HEADS, D_FF, np.shape(xs)[<span class="dv">1</span>], DROPOUT_RATE)</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.Model(<span class="op">*</span>juxt(identity, op)(tf.keras.Input(shape<span class="op">=</span>np.shape(xs)[<span class="dv">1</span>:])))</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(tf.keras.optimizers.Adam(LearningRateSchedule(D_MODEL), beta_1<span class="op">=</span><span class="fl">0.9</span>, beta_2<span class="op">=</span><span class="fl">0.98</span>, epsilon<span class="op">=</span><span class="fl">1e-9</span>), loss<span class="op">=</span><span class="st">&#39;binary_crossentropy&#39;</span>, metrics<span class="op">=</span>(<span class="st">&#39;accuracy&#39;</span>,))</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>model.fit(xs, ys, batch_size<span class="op">=</span><span class="dv">256</span>, epochs<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを保存します。</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">&#39;titanic-model&#39;</span>, include_optimizer<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>save_categorical_features(categorical_features)</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>save_feature_rangess(feature_ranges)</span></code></pre></div>
<h2 id="解答を作成する-4">解答を作成する</h2>
<p>最後。解答を作成するモジュールを作成します。</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataset <span class="im">import</span> get_test_data_frame, get_xs</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> model <span class="im">import</span> load_categorical_features, load_feature_ranges</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co"># モデルを読み込みます。</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;titanic-model&#39;</span>)</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> load_categorical_features()</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>feature_ranges <span class="op">=</span> load_feature_ranges()</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co"># データを取得します。</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>data_frame <span class="op">=</span> get_test_data_frame()</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>xs <span class="op">=</span> get_xs(data_frame, categorical_features, feature_ranges)</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 提出量のCSVを作成します。</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>submission <span class="op">=</span> pd.DataFrame({<span class="st">&#39;PassengerId&#39;</span>: data_frame[<span class="st">&#39;PassengerId&#39;</span>], <span class="st">&#39;Survived&#39;</span>: (model.predict(xs)[:, <span class="dv">0</span>] <span class="op">&gt;=</span> <span class="fl">0.5</span>).astype(np.int32)})</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>submission.to_csv(<span class="st">&#39;submission.csv&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<p>で、オチが予想できたとは思うのですけど、精度は0.74641（LightGBMの時は0.77990でした）とガタガタでした……。まぁ、大量のデータが必要なTransformerで、Titanicみたいなデータ量が少ない問題をやっているんですから当然ですな。でも、大量のデータがあるなら、もっと高い精度が出るかもしれません。</p>
<p>というわけで、2022年3月現在はまだテーブル・データならLightGBMで良いと思うのですけど、使えるデータの量（または深層学習の進歩）次第、あと、GPUやTPUがあるなら、テーブル・データでも深層学習の方が良い時代が来るかもしれません。事前学習でデータに対する理解を深められる（本稿では紹介しなかったけど）ってのは、深層学習の大きなアドバンテージだと思うんですよね。</p>
<h1 id="終わりに">終わりに</h1>
<p>本稿で、機械学習は別に難しくない、というか、作業の多くはデータを読み込んだり整形したりのごく普通のプログラミングで私たちの得意分野なのだということをご理解いただければ幸いです。プログラミングができるというのは、とても大きなアドバンテージなんです。</p>
<p>深層学習のモデルのプログラミングは難しく思えたかもしれませんけど、紹介したTensorFlowのチュートリアルを読んで、あと、インターネットにゴロゴロしているお手本を参考にしながら作るのだから、やっぱり別に難しくはないですよ。</p>
<p>というわけで機械学習は、「アルゴリズムを考えるのが面倒だから、とりあえず機械学習でやってみよう」という程度の、気楽に使ってよい道具なんだと思いますよ。ぜひ、使ってみてください。</p>
</article>
</body>
</html>
